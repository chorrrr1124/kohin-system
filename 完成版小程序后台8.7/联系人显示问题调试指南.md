# 联系人显示问题调试指南

## 🐛 问题描述

小程序端显示"联系人: 未设置"，但Web端显示客户确实有联系人数据。

## 🔍 调试步骤

### 1. 使用调试工具

在小程序客户管理页面：
1. 打开开发者工具 (F12)
2. 切换到 Console 标签
3. 复制 `调试客户数据.js` 中的代码
4. 粘贴到 Console 中执行

### 2. 检查输出信息

调试工具会显示：
- ✅ 客户数据的完整结构
- ✅ 联系人字段的类型和值
- ✅ 显示条件的检查结果
- ✅ 可能的字段名变体

### 3. 常见问题排查

#### 问题1: 字段名不匹配
**表现**: 有联系人数据但字段名不是 `name`

**可能的字段名**:
- `contact` (旧版本)
- `contactName` 
- `联系人`
- 中文字段名

**解决方案**: 已在模板中添加兼容性检查
```xml
<view wx:if="{{item.contacts && item.contacts.length > 0 && (item.contacts[0].name || item.contacts[0].contact)}}">
  联系人: {{item.contacts[0].name || item.contacts[0].contact}}
</view>
<view wx:elif="{{item.contact}}">联系人: {{item.contact}}</view>
```

#### 问题2: 空字符串问题
**表现**: `name` 字段存在但是空字符串 `""`

**检查方法**:
```javascript
console.log('name值:', `"${customer.contacts[0].name}"`);
console.log('是否为空字符串:', customer.contacts[0].name === '');
```

**解决方案**: 在条件中添加非空检查
```xml
wx:if="{{item.contacts[0].name && item.contacts[0].name.trim()}}"
```

#### 问题3: 数据同步问题
**表现**: Web端和小程序端数据不一致

**可能原因**:
- 缓存问题
- 数据更新延迟
- 不同数据源

**解决方案**: 清除缓存并重新加载
```javascript
// 在页面 onLoad 中添加
wx.removeStorageSync('customers');
this.loadCustomers();
```

#### 问题4: 数据结构变化
**表现**: 老客户显示正常，新客户显示异常

**检查方法**:
```javascript
// 比较不同客户的数据结构
customers.forEach(customer => {
  console.log(customer.name, '联系人结构:', customer.contacts);
});
```

## 🛠️ 修复方案

### 方案1: 增强兼容性 (已实施)

```xml
<!-- 兼容多种字段名 -->
<view wx:if="{{item.contacts && item.contacts.length > 0 && (item.contacts[0].name || item.contacts[0].contact)}}">
  联系人: {{item.contacts[0].name || item.contacts[0].contact}}
</view>
<view wx:elif="{{item.contact}}">联系人: {{item.contact}}</view>
<view wx:else>联系人: 未设置</view>
```

### 方案2: 数据清理

如果发现数据结构问题，可以在客户管理页面的 JS 中添加数据清理逻辑：

```javascript
// 在 loadCustomers 方法中添加
loadCustomers: function() {
  // ... 现有代码 ...
  
  // 数据清理和格式化
  const cleanedCustomers = customers.map(customer => {
    // 确保 contacts 是数组
    if (!Array.isArray(customer.contacts)) {
      customer.contacts = [];
    }
    
    // 兼容旧数据格式
    if (customer.contact && !customer.contacts.length) {
      customer.contacts = [{
        name: customer.contact,
        phone: customer.phone || '',
        address: customer.address || ''
      }];
    }
    
    return customer;
  });
  
  this.setData({
    customers: cleanedCustomers
  });
}
```

### 方案3: 强制刷新

如果是缓存问题，可以强制刷新：

```javascript
// 在客户管理页面添加刷新按钮
refreshData: function() {
  wx.removeStorageSync('customers');
  wx.showLoading({ title: '刷新中...' });
  
  this.loadCustomers();
  
  setTimeout(() => {
    wx.hideLoading();
    wx.showToast({
      title: '刷新成功',
      icon: 'success'
    });
  }, 1000);
}
```

## 📱 测试验证

### 1. 基本显示测试
- ✅ 有 `name` 字段的客户
- ✅ 有 `contact` 字段的客户  
- ✅ 空联系人的客户
- ✅ 新建客户

### 2. 特殊情况测试
- ✅ 空字符串联系人
- ✅ null/undefined 联系人
- ✅ 数组为空的情况
- ✅ contacts 字段不存在的情况

### 3. 功能测试
- ✅ 搜索功能
- ✅ 筛选功能
- ✅ 电话拨打功能

## 🎯 预期结果

修复后应该能正确显示：

1. **有联系人名称**: `联系人: 张三`
2. **有旧格式联系人**: `联系人: 李四` 
3. **无联系人**: `联系人: 未设置`
4. **有电话号码**: `电话: 13888888888`
5. **无电话**: `电话: 未设置`

如果仍有问题，请运行调试工具并提供具体的 Console 输出结果。 