<!-- pages/orders/orders.wxml -->
<view class="container">
  <view class="fixed-header">
    <!-- <view class="section-title">è®¢å•ç®¡ç†</view> -->
    <!-- æ‰¹é‡æ“ä½œåŒºå·²åˆ é™¤ -->
    <!-- è®¢å•çŠ¶æ€é€‰é¡¹å¡ -->
    <view class="order-tabs">
      <view 
        wx:for="{{tabs}}" 
        wx:key="id" 
        class="order-tab {{activeTab === item.id ? 'active' : ''}}"
        bindtap="switchTab"
        data-id="{{item.id}}"
      >
        {{item.name}}
      </view>
    </view>
    <!-- æ—¥æœŸç­›é€‰ -->
    <view class="date-filter">
      <view class="date-picker">
        <picker mode="date" value="{{startDate}}" bindchange="onStartDateChange">
          <view class="picker-item">
            <text class="date-label">å¼€å§‹æ—¥æœŸ:</text>
            <text class="date-value">{{startDate || 'è¯·é€‰æ‹©'}}</text>
          </view>
        </picker>
      </view>
      <view class="date-picker">
        <picker mode="date" value="{{endDate}}" bindchange="onEndDateChange">
          <view class="picker-item">
            <text class="date-label">ç»“æŸæ—¥æœŸ:</text>
            <text class="date-value">{{endDate || 'è¯·é€‰æ‹©'}}</text>
          </view>
        </picker>
      </view>
      <view class="filter-btn-row">
      <view class="filter-button" bindtap="filterByDate">ç­›é€‰</view>
      <view class="filter-button reset" bindtap="resetDateFilter">é‡ç½®</view>
        <!-- æ›´å¤šæŒ‰é’®åŠä¸‹æ‹‰æ å·²ç§»é™¤ -->
      </view>
    </view>
    
    <!-- æœç´¢æ  -->
    <view class="search-container">
      <view class="search-box">
        <input type="text" 
               placeholder="æœç´¢è®¢å•å·ã€å®¢æˆ·ã€ç”µè¯ã€å•†å“ã€åœ°å€ç­‰" 
               confirm-type="search" 
               bindinput="onSearchInput" 
               bindconfirm="onSearchConfirm"
               value="{{searchKeyword}}" />
        <view class="search-icon" wx:if="{{!searchKeyword}}">ğŸ”</view>
        <view class="clear-icon" wx:if="{{searchKeyword}}" bindtap="clearSearch">âœ•</view>
      </view>
    </view>
  </view>
  <!-- è®¢å•åˆ—è¡¨ï¼ˆå¯æ»šåŠ¨åŒºåŸŸï¼‰ -->
  <scroll-view class="scrollable-content" scroll-y="true" bindscrolltolower="loadMoreOrders" enable-flex="true">
    <view class="order-list-container">
      <view class="order-list" wx:if="{{!loading}}">
        <block wx:for="{{orders}}" wx:key="id">
          <view class="order-item" bindtap="viewOrderDetail" data-id="{{item.id}}">
            <!-- å¤é€‰æ¡†å·²ç§»é™¤ -->
            <!-- è®¢å•å¤´éƒ¨ï¼šè®¢å•å·å’ŒçŠ¶æ€åœ¨åŒä¸€è¡Œ -->
            <view class="order-header-row">
              <view class="order-id">è®¢å•å·: {{item.id || 'å¾…ç”Ÿæˆ'}}</view>
              <view class="order-status">
                <text wx:if="{{item.status === 'pending'}}" class="status-pending">å¾…ä»˜æ¬¾</text>
                <text wx:elif="{{item.status === 'pending_shipment'}}" class="status-processing">å¾…å‘è´§</text>
                <text wx:elif="{{item.status === 'shipped'}}" class="status-shipped">å·²å‘è´§</text>
                <text wx:elif="{{item.status === 'completed'}}" class="status-completed">å·²å®Œæˆ</text>
              </view>
            </view>
            <view class="order-info">
              <view class="order-date">ä¸‹å•æ—¶é—´: {{item.date || 'æœªçŸ¥'}}</view>
              <view class="order-customer">å®¢æˆ·: {{item.customer || 'æœªçŸ¥å®¢æˆ·'}}</view>
              <view class="order-items">
                <text wx:for="{{item.items}}" wx:for-item="product" wx:key="name" class="order-item-product">
                  {{product.name}} x{{product.quantity}}
                </text>
              </view>
            </view>
            <view class="order-footer">
              <view class="order-total-section">              
                <view class="order-total-label">æ€»é‡‘é¢:</view>
                <view class="order-total-amount">
                  <block wx:if="{{item.isPrepaidProduct || item.paymentMethod === 'prepaid' || item.paymentMethod === 'prestore'}}">
                    Â¥0.00 (é¢„å­˜æ‰£é™¤)
                  </block>
                  <block wx:else>
                    Â¥{{item.total || 0}}
                  </block>
                </view>
              </view>
              <view class="order-actions">
                <button 
                  class="action-btn" 
                  catchtap="processOrder" 
                  data-id="{{item.id}}"
                  wx:if="{{item.status !== 'completed'}}"
                  hover-class="button-hover"
                  hover-stay-time="100"
                >
                  <block wx:if="{{item.processing && item.processingId === item.id}}">
                    <view class="loading-dots">å¤„ç†ä¸­<text class="dot">.</text><text class="dot">.</text><text class="dot">.</text></view>
                  </block>
                  <block wx:else>
                  {{item.status === 'pending' ? 'ç¡®è®¤ä»˜æ¬¾' : 
                    item.status === 'pending_shipment' ? 'å‘è´§' : 
                    item.status === 'shipped' ? 'ç¡®è®¤å®Œæˆ' : ''}}
                  </block>
                </button>
              </view>
            </view>
          </view>
        </block>
      </view>
      <view class="loading" wx:if="{{loading}}">
        <text>åŠ è½½ä¸­...</text>
      </view>
      <view class="empty-tip" wx:if="{{!loading && orders.length === 0}}">
        <view class="empty-state">
          <view class="empty-icon">ğŸ“‹</view>
          <text class="empty-text">æš‚æ— è®¢å•</text>
          <text class="empty-hint">æ·»åŠ è®¢å•åå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</text>
        </view>
      </view>
      <!-- åŠ è½½æ›´å¤š - åªåœ¨è®¢å•æ€»æ•°è¶…è¿‡10æ¡æ—¶æ˜¾ç¤º -->
      <view class="load-more" wx:if="{{hasMoreOrders && !loading && orders.length > 0 && allOrders.length > 10}}">
        <view class="load-more-btn" bindtap="loadMoreOrders">åŠ è½½æ›´å¤š</view>
      </view>
      <!-- åº•éƒ¨é—´è· -->
      <view class="bottom-space"></view>
    </view>
  </scroll-view>
  <!-- æ·»åŠ æ‰‹åŠ¨åˆ·æ–°æŒ‰é’® -->
  <view class="refresh-btn" bindtap="manualRefresh">
    <text class="refresh-icon">âŸ³</text>
    <text class="refresh-text">åˆ·æ–°æ•°æ®</text>
  </view>
</view>