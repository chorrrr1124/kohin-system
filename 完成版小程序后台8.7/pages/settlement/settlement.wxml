<view class="settlement-container">
  <!-- 购物车商品列表 -->
  <view class="cart-list">
    <view class="section-title">商品清单</view>
    <view class="cart-item" wx:for="{{cartItems}}" wx:key="id">
      <view class="item-info">
        <view class="item-name">{{item.name}}</view>
        <view class="item-price">¥{{item.price}}</view>
      </view>
      <view class="item-quantity">x{{item.quantity}}</view>
    </view>
    <view class="total-price">
      <text>合计：</text>
      <text class="price">¥{{totalPrice}}</text>
    </view>
  </view>

  <!-- 客户信息 -->
  <view class="customer-section">
    <view class="section-title">客户信息</view>
    <view class="info-item customer-select-btn" bindtap="selectCustomer">
      <view class="value {{!selectedCustomer ? 'placeholder' : ''}}">
        {{selectedCustomer ? selectedCustomer.name + ' - ' + selectedCustomer.phone : '点击选择客户'}}
        <text class="arrow">></text>
      </view>
    </view>
  </view>

  <!-- 收货信息 -->
  <view class="shipping-section">
    <view class="section-title">收货信息</view>
    <view class="info-item">
      <view class="label">收货联系人</view>
      <view class="value">
        <input placeholder="请输入联系人姓名" value="{{shippingContact.name}}" bindinput="inputContactName" />
      </view>
    </view>
    <view class="info-item">
      <view class="label">联系电话</view>
      <view class="value">
        <input placeholder="请输入联系电话" value="{{shippingContact.phone}}" maxlength="11" bindinput="inputContactPhone" />
      </view>
    </view>
    <view class="info-item">
      <view class="label">收货地址</view>
      <view class="value">
        <textarea placeholder="请输入详细地址" value="{{shippingContact.address}}" bindinput="inputContactAddress" />
      </view>
    </view>
  </view>

  <!-- 支付方式 -->
  <view class="payment-section">
    <view class="section-title">支付方式</view>
    <view class="payment-methods">
      <view 
        class="payment-method {{paymentMethod === item.id ? 'selected' : ''}}" 
        wx:for="{{paymentMethods}}" 
        wx:key="id"
        data-method="{{item.id}}"
        bindtap="selectPaymentMethod"
      >
        {{item.name}}
      </view>
    </view>
  </view>

  <!-- 提交订单按钮 -->
  <view class="submit-section">
    <view class="total-info">
      <text>实付金额：</text>
      <text class="price">¥{{totalPrice}}</text>
    </view>
    <button class="submit-btn" bindtap="submitOrder">提交订单</button>
  </view>
  
  <!-- 客户选择弹窗 -->
  <view class="customer-modal" wx:if="{{showCustomerModal}}">
    <view class="modal-content">
      <!-- 客户选择界面 -->
      <block wx:if="{{!showNewCustomerForm}}">
        <view class="modal-header">
          <view class="modal-title">选择客户</view>
          <view class="close-btn" bindtap="closeCustomerModal">×</view>
        </view>
        <view class="search-bar">
          <input 
            type="text" 
            placeholder="搜索客户名称或电话" 
            value="{{searchValue}}"
            bindinput="searchCustomers"
            confirm-type="search"
          />
        </view>
        <view class="customer-list">
          <block wx:if="{{loadingCustomers}}">
            <view class="loading">加载中...</view>
          </block>
          <block wx:elif="{{filteredCustomers.length === 0}}">
            <view class="empty-tip">未找到客户</view>
          </block>
          <block wx:else>
            <view class="customer-item" wx:for="{{filteredCustomers}}" wx:key="_id" bindtap="selectCustomerItem" data-id="{{item._id}}">
              <view class="customer-info">
                <view class="customer-name">{{item.name}}</view>
                <view class="customer-phone">{{item.phone || (item.contacts && item.contacts.length > 0 ? item.contacts[0].phone : '')}}</view>
              </view>
            </view>
          </block>
        </view>
        <view class="modal-footer">
          <button class="new-customer-btn" bindtap="createNewCustomer">新建客户</button>
        </view>
      </block>

      <!-- 新建客户表单 -->
      <block wx:if="{{showNewCustomerForm}}">
        <view class="modal-header">
          <view class="modal-title">新建客户</view>
          <view class="close-btn" bindtap="cancelNewCustomer">×</view>
        </view>
        <view class="new-customer-form">
          <!-- 客户名称 -->
          <view class="form-item">
            <view class="label">客户名称</view>
            <input class="input" value="{{newCustomer.name}}" placeholder="请输入客户名称" bindinput="inputNewCustomerName"/>
          </view>
          
          <!-- 联系人信息 -->
          <view class="form-item">
            <view class="label">联系人姓名</view>
            <input class="input" value="{{newCustomerContact.name}}" placeholder="请输入联系人姓名" bindinput="inputNewCustomerContactName"/>
          </view>
          
          <view class="form-item">
            <view class="label">联系电话</view>
            <input class="input" type="number" value="{{newCustomerContact.phone}}" maxlength="11" placeholder="请输入联系电话" bindinput="inputNewCustomerContactPhone"/>
          </view>
          
          <view class="form-item">
            <view class="label">联系地址</view>
            <input class="input" value="{{newCustomerContact.address}}" placeholder="请输入联系地址" bindinput="inputNewCustomerContactAddress"/>
          </view>
        </view>
        <view class="modal-footer">
          <button class="cancel-btn" bindtap="cancelNewCustomer">取消</button>
          <button class="save-btn" bindtap="saveNewCustomer">保存</button>
        </view>
      </block>
    </view>
  </view>
</view>