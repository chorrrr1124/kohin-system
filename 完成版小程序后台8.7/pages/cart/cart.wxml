<!-- pages/cart/cart.wxml -->
<view class="container">
  <view class="section-title">è´­ç‰©è½¦</view>
  
  <!-- è´­ç‰©è½¦ä¸ºç©ºæ—¶æ˜¾ç¤º -->
  <view class="empty-cart" wx:if="{{isEmpty}}">
    <view class="empty-icon">ğŸ›’</view>
    <view class="empty-text">è´­ç‰©è½¦è¿˜æ˜¯ç©ºçš„</view>
    <view class="go-shop-btn" bindtap="goBackToShop">å»é€‰è´­å•†å“</view>
  </view>
  
  <!-- è´­ç‰©è½¦æœ‰å•†å“æ—¶æ˜¾ç¤º -->
  <view class="cart-content" wx:else>
    <!-- å•†å“åˆ—è¡¨ -->
    <view class="cart-items">
      <view class="cart-item" wx:for="{{cartItems}}" wx:key="id">
        <view class="item-info">
          <view class="item-name">{{item.name}}</view>
          <view class="item-price">Â¥{{item.price}}</view>
        </view>
        
        <!-- æ·»åŠ äº§å“è¯¦ç»†ä¿¡æ¯ -->
        <view class="item-details">
          <view class="detail-item" wx:if="{{item.brand}}">å“ç‰Œ: {{item.brand !== null && item.brand !== undefined && item.brand !== '' ? item.brand : 'æ— '}}</view>
            <view class="detail-item" wx:if="{{item.specification}}">è§„æ ¼: {{item.specification !== null && item.specification !== undefined && item.specification !== '' ? item.specification : 'æ— '}}</view>
          <view class="detail-item">åº“å­˜: {{item.stock || 0}}</view>
        </view>
        
        <view class="item-actions">
          <view class="quantity-control">
            <view class="quantity-btn minus" bindtap="decreaseQuantity" data-index="{{index}}">-</view>
            <view class="quantity-number">{{item.quantity}}</view>
            <view class="quantity-btn plus" bindtap="increaseQuantity" data-index="{{index}}">+</view>
          </view>
          <view class="delete-btn" bindtap="removeItem" data-index="{{index}}">åˆ é™¤</view>
        </view>
      </view>
    </view>
    
    <!-- å®¢æˆ·ä¿¡æ¯ -->
    <view class="customer-section">
      <view class="section-subtitle">å®¢æˆ·ä¿¡æ¯</view>
      <view class="info-item customer-select-btn" bindtap="selectCustomer">
        <view class="value {{!selectedCustomer ? 'placeholder' : ''}}">
          <block wx:if="{{selectedCustomer}}">
            {{selectedCustomer.name}}
            <block wx:if="{{selectedCustomer.phone}}"> - {{selectedCustomer.phone}}</block>
            <block wx:elif="{{selectedCustomer.contacts && selectedCustomer.contacts.length > 0 && selectedCustomer.contacts[0].phone}}"> - {{selectedCustomer.contacts[0].phone}}</block>
          </block>
          <block wx:else>ç‚¹å‡»é€‰æ‹©å®¢æˆ·</block>
          <text class="arrow">></text>
        </view>
      </view>
    </view>
    
    <!-- æ”¶è´§åœ°å€ -->
    <view class="address-section" wx:if="{{selectedCustomer}}">
      <view class="section-subtitle">æ”¶è´§åœ°å€</view>
      <view class="info-item" bindtap="selectAddress">
        <view class="label">æ”¶è´§åœ°å€</view>
        <view class="value {{!selectedAddress ? 'placeholder' : ''}}">
          <block wx:if="{{selectedAddress}}">
            <view>{{selectedAddress.name}} {{selectedAddress.phone}}</view>
            <view>{{selectedAddress.province}}{{selectedAddress.city}}{{selectedAddress.district}}{{selectedAddress.detail}}</view>
          </block>
          <block wx:else>
            ç‚¹å‡»é€‰æ‹©æ”¶è´§åœ°å€
            <text class="arrow">></text>
          </block>
        </view>
      </view>

    </view>
    
    <!-- æ”¯ä»˜æ–¹å¼ -->
    <view class="payment-section" wx:if="{{selectedCustomer}}">
      <view class="section-subtitle">æ”¯ä»˜æ–¹å¼</view>
      <view class="payment-methods">
        <view 
          class="payment-method {{paymentMethod === 'cash' ? 'selected' : ''}}" 
          bindtap="selectPaymentMethod" 
          data-method="cash"
        >ç°é‡‘æ”¯ä»˜</view>
        <view 
          class="payment-method {{paymentMethod === 'wechat' ? 'selected' : ''}}" 
          bindtap="selectPaymentMethod" 
          data-method="wechat"
        >å¾®ä¿¡æ”¯ä»˜</view>
        <view 
          class="payment-method {{paymentMethod === 'prepaid' ? 'selected' : ''}}" 
          bindtap="selectPaymentMethod" 
          data-method="prepaid"
        >é¢„å­˜æŠµæ‰£</view>
        <view 
          class="payment-method {{paymentMethod === 'prestore' ? 'selected' : ''}}" 
          bindtap="selectPaymentMethod" 
          data-method="prestore"
        >é¢„å­˜</view>
      </view>
    </view>
    
    <!-- åº•éƒ¨ç»“ç®—æ  -->
    <view class="cart-footer">
      <view class="cart-total">
        <text>æ€»è®¡: </text>
        <text class="total-price">Â¥{{totalPrice}}</text>
      </view>
      
      <view class="action-buttons">
        <view class="clear-btn" bindtap="clearCart">æ¸…ç©º</view>
        <view class="checkout-btn" bindtap="submitOrder">ç»“ç®—</view>
      </view>
    </view>
  </view>
  
  <!-- å®¢æˆ·é€‰æ‹©å¼¹çª— -->
  <view class="customer-modal {{showCustomerModal ? 'active' : ''}}" wx:if="{{showCustomerModal}}">
    <view class="modal-mask" bindtap="closeCustomerModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <view class="modal-title">å®¢æˆ·ç®¡ç†</view>
        <view class="close-btn" bindtap="closeCustomerModal">Ã—</view>
      </view>
      
      <view class="search-bar">
        <input 
          type="text" 
          placeholder="æœç´¢å®¢æˆ·å§“åæˆ–ç”µè¯" 
          value="{{searchValue}}"
          bindinput="searchCustomers"
          confirm-type="search"
        />
      </view>
      
      <!-- æ·»åŠ æ–°å»ºå®¢æˆ·æŒ‰é’® -->
      <view class="add-customer-btn" bindtap="navigateToAddCustomer">
        <text class="add-icon">+</text>
        <text>æ–°å»ºå®¢æˆ·</text>
      </view>
      
      <view class="customer-list">
        <block wx:if="{{loadingCustomers}}">
          <view class="loading">åŠ è½½ä¸­...</view>
        </block>
        <block wx:elif="{{filteredCustomers.length === 0}}">
          <view class="empty-tip">æœªæ‰¾åˆ°å®¢æˆ·</view>
        </block>
        <block wx:else>
          <view class="customer-item" wx:for="{{filteredCustomers}}" wx:key="_id" bindtap="selectCustomerItem" data-id="{{item._id}}">
            <view class="customer-info">
              <view class="customer-name">{{item.name}}</view>
              <view class="customer-phone">{{item.phone || (item.contacts && item.contacts.length > 0 ? item.contacts[0].phone : '')}}</view>
            </view>
          </view>
        </block>
      </view>
    </view>
  </view>
  
  <!-- åœ°å€é€‰æ‹©å¼¹çª— -->
  <view class="address-modal {{showAddressModal ? 'active' : ''}}" wx:if="{{showAddressModal}}">
    <view class="modal-mask" bindtap="closeAddressModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <view class="modal-title">æ”¶è´§åœ°å€</view>
        <view class="close-btn" bindtap="closeAddressModal">Ã—</view>
      </view>
      
      <!-- åœ°å€åˆ—è¡¨ -->
      <view class="address-list">
        <block wx:if="{{allAddresses.length === 0}}">
          <view class="empty-tip">æš‚æ— æ”¶è´§åœ°å€</view>
        </block>
        <block wx:else>
          <view class="address-item {{item.isDefault ? 'default' : ''}}" 
                wx:for="{{allAddresses}}" 
                wx:key="_id" 
                bindtap="selectAddressItem" 
                data-index="{{index}}">
            <!-- ä¸´æ—¶è”ç³»äººæ ‡è¯† -->
            <view class="address-badge" wx:if="{{item.fromContact}}">è”ç³»äºº</view>
            <view class="address-badge" wx:elif="{{item.isTemporary}}">ä¸´æ—¶</view>
            <!-- é»˜è®¤åœ°å€æ ‡è¯† -->
            <view class="default-badge" wx:if="{{item.isDefault}}">é»˜è®¤</view>
            
            <view class="address-info">
              <view class="address-contact">
                <text class="address-name">{{item.name}}</text>
                <text class="address-phone">{{item.phone}}</text>
              </view>
              <view class="address-detail">
                {{(item.province || '') + (item.city || '') + (item.district || '') + (item.detail || item.address || '')}}
              </view>
            </view>
          </view>
        </block>
      </view>
      
      <!-- æ·»åŠ æ–°åœ°å€æŒ‰é’® -->
      <view class="add-address-btn" bindtap="addNewAddress">
        <text class="add-icon">+</text>
        <text>æ–°å¢æ”¶è´§åœ°å€</text>
      </view>
    </view>
  </view>
</view>