# 数据库设计文档

## 概述

本文档详细描述了商城系统的数据库设计，包括数据模型、字段定义、索引策略、数据关系和约束规则。

### 技术栈
- **数据库类型：** 腾讯云开发 - 云数据库（基于MongoDB）
- **数据格式：** JSON文档存储
- **索引引擎：** MongoDB索引
- **事务支持：** 支持ACID事务

### 设计原则

1. **数据一致性** - 确保数据的完整性和一致性
2. **性能优化** - 合理设计索引，优化查询性能
3. **扩展性** - 支持业务扩展和数据增长
4. **安全性** - 数据访问权限控制和敏感信息保护
5. **用户隔离** - 确保用户数据的隔离和安全

## 数据库架构

### 集合（Collection）分类

```
商城数据库架构
├── 用户管理模块
│   ├── users (商城用户)
│   ├── customers (后台客户)
│   ├── admins (管理员)
│   └── userProfiles (用户档案)
├── 商品管理模块
│   ├── products (基础商品)
│   ├── shopProducts (商城商品)
│   ├── categories (商品分类)
│   ├── brands (品牌信息)
│   └── inventory (库存记录)
├── 订单管理模块
│   ├── orders (订单主表)
│   ├── orderItems (订单商品明细)
│   ├── orderLogs (订单操作日志)
│   └── shippingInfo (物流信息)
├── 财务管理模块
│   ├── prepaidRecords (预存记录)
│   ├── transactions (交易记录)
│   ├── payments (支付记录)
│   └── refunds (退款记录)
├── 营销管理模块
│   ├── coupons (优惠券)
│   ├── promotions (促销活动)
│   ├── points (积分记录)
│   └── memberLevels (会员等级)
├── 内容管理模块
│   ├── banners (轮播图)
│   ├── homepageConfig (首页配置)
│   ├── announcements (公告)
│   └── articles (文章)
└── 系统管理模块
    ├── operationLogs (操作日志)
    ├── systemConfig (系统配置)
    ├── permissions (权限配置)
    └── backups (备份记录)
```

## 详细数据模型

### 1. 用户管理模块

#### 1.1 users - 商城用户表

**用途：** 存储商城小程序用户信息

**字段定义：**

| 字段名 | 类型 | 必填 | 默认值 | 描述 | 索引 |
|--------|------|------|--------|------|------|
| _id | ObjectId | 是 | 自动生成 | 主键 | 主键 |
| openid | String | 是 | - | 微信OpenID | 唯一索引 |
| unionid | String | 否 | null | 微信UnionID | 普通索引 |
| nickName | String | 否 | "" | 用户昵称 | - |
| avatarUrl | String | 否 | "" | 头像URL | - |
| realName | String | 否 | "" | 真实姓名 | - |
| phone | String | 否 | "" | 手机号 | 普通索引 |
| email | String | 否 | "" | 邮箱 | - |
| gender | Number | 否 | 0 | 性别(0:未知,1:男,2:女) | - |
| birthday | Date | 否 | null | 生日 | - |
| city | String | 否 | "" | 城市 | - |
| province | String | 否 | "" | 省份 | - |
| country | String | 否 | "" | 国家 | - |
| points | Number | 否 | 0 | 积分余额 | 普通索引 |
| balance | Number | 否 | 0 | 账户余额 | - |
| vipLevel | Number | 否 | 1 | VIP等级 | 普通索引 |
| totalSpent | Number | 否 | 0 | 累计消费金额 | 普通索引 |
| orderCount | Number | 否 | 0 | 订单数量 | - |
| lastLoginTime | Date | 否 | null | 最后登录时间 | 普通索引 |
| lastOrderTime | Date | 否 | null | 最后下单时间 | - |
| status | String | 否 | "active" | 状态(active/inactive/banned) | 普通索引 |
| tags | Array | 否 | [] | 用户标签 | - |
| preferences | Object | 否 | {} | 用户偏好设置 | - |
| addresses | Array | 否 | [] | 收货地址列表 | - |
| createTime | Date | 是 | 当前时间 | 创建时间 | 普通索引 |
| updateTime | Date | 是 | 当前时间 | 更新时间 | - |

**示例数据：**
```json
{
  "_id": "60f1234567890abcdef12345",
  "openid": "oXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
  "unionid": "uXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
  "nickName": "张三",
  "avatarUrl": "https://wx.qlogo.cn/mmopen/...",
  "realName": "张三",
  "phone": "13800138000",
  "email": "zhangsan@example.com",
  "gender": 1,
  "birthday": "1990-01-01T00:00:00.000Z",
  "city": "北京",
  "province": "北京",
  "country": "中国",
  "points": 1500,
  "balance": 299.50,
  "vipLevel": 2,
  "totalSpent": 2580.00,
  "orderCount": 15,
  "lastLoginTime": "2021-07-16T08:00:00.000Z",
  "lastOrderTime": "2021-07-15T14:30:00.000Z",
  "status": "active",
  "tags": ["VIP客户", "活跃用户"],
  "preferences": {
    "language": "zh-CN",
    "currency": "CNY",
    "notifications": {
      "order": true,
      "promotion": true,
      "system": false
    }
  },
  "addresses": [
    {
      "id": "addr_001",
      "name": "张三",
      "phone": "13800138000",
      "province": "北京",
      "city": "北京市",
      "district": "朝阳区",
      "detail": "某某街道123号",
      "isDefault": true
    }
  ],
  "createTime": "2021-01-01T08:00:00.000Z",
  "updateTime": "2021-07-16T08:00:00.000Z"
}
```

#### 1.2 customers - 后台客户表

**用途：** 存储后台管理系统的客户信息

**字段定义：**

| 字段名 | 类型 | 必填 | 默认值 | 描述 | 索引 |
|--------|------|------|--------|------|------|
| _id | ObjectId | 是 | 自动生成 | 主键 | 主键 |
| customerNo | String | 是 | 自动生成 | 客户编号 | 唯一索引 |
| name | String | 是 | - | 客户姓名 | 普通索引 |
| phone | String | 是 | - | 手机号 | 唯一索引 |
| email | String | 否 | "" | 邮箱 | - |
| gender | String | 否 | "" | 性别 | - |
| birthday | Date | 否 | null | 生日 | - |
| address | String | 否 | "" | 详细地址 | - |
| company | String | 否 | "" | 公司名称 | - |
| position | String | 否 | "" | 职位 | - |
| source | String | 否 | "" | 客户来源 | 普通索引 |
| level | String | 否 | "普通" | 客户等级 | 普通索引 |
| prepaidBalance | Number | 否 | 0 | 预存余额 | 普通索引 |
| creditLimit | Number | 否 | 0 | 信用额度 | - |
| totalSpent | Number | 否 | 0 | 累计消费 | 普通索引 |
| orderCount | Number | 否 | 0 | 订单数量 | - |
| lastOrderTime | Date | 否 | null | 最后下单时间 | 普通索引 |
| lastContactTime | Date | 否 | null | 最后联系时间 | - |
| status | String | 否 | "active" | 状态 | 普通索引 |
| tags | Array | 否 | [] | 客户标签 | - |
| notes | String | 否 | "" | 备注信息 | - |
| salesRep | String | 否 | "" | 销售代表 | 普通索引 |
| createBy | String | 是 | - | 创建人 | 普通索引 |
| createTime | Date | 是 | 当前时间 | 创建时间 | 普通索引 |
| updateTime | Date | 是 | 当前时间 | 更新时间 | - |

#### 1.3 admins - 管理员表

**用途：** 存储系统管理员信息

**字段定义：**

| 字段名 | 类型 | 必填 | 默认值 | 描述 | 索引 |
|--------|------|------|--------|------|------|
| _id | ObjectId | 是 | 自动生成 | 主键 | 主键 |
| username | String | 是 | - | 用户名 | 唯一索引 |
| password | String | 是 | - | 密码(加密) | - |
| name | String | 是 | - | 真实姓名 | - |
| email | String | 否 | "" | 邮箱 | - |
| phone | String | 否 | "" | 手机号 | - |
| role | String | 是 | "admin" | 角色 | 普通索引 |
| permissions | Array | 否 | [] | 权限列表 | - |
| department | String | 否 | "" | 部门 | - |
| position | String | 否 | "" | 职位 | - |
| lastLoginTime | Date | 否 | null | 最后登录时间 | - |
| lastLoginIP | String | 否 | "" | 最后登录IP | - |
| loginCount | Number | 否 | 0 | 登录次数 | - |
| status | String | 否 | "active" | 状态 | 普通索引 |
| createBy | String | 否 | "" | 创建人 | - |
| createTime | Date | 是 | 当前时间 | 创建时间 | 普通索引 |
| updateTime | Date | 是 | 当前时间 | 更新时间 | - |

### 2. 商品管理模块

#### 2.1 products - 基础商品表

**用途：** 存储基础商品信息，供后台管理和商城使用

**字段定义：**

| 字段名 | 类型 | 必填 | 默认值 | 描述 | 索引 |
|--------|------|------|--------|------|------|
| _id | ObjectId | 是 | 自动生成 | 主键 | 主键 |
| productNo | String | 是 | 自动生成 | 商品编号 | 唯一索引 |
| name | String | 是 | - | 商品名称 | 文本索引 |
| description | String | 否 | "" | 商品描述 | 文本索引 |
| shortDesc | String | 否 | "" | 简短描述 | - |
| category | String | 是 | - | 商品分类 | 普通索引 |
| subCategory | String | 否 | "" | 子分类 | 普通索引 |
| brand | String | 否 | "" | 品牌 | 普通索引 |
| model | String | 否 | "" | 型号 | - |
| sku | String | 否 | "" | SKU编码 | 普通索引 |
| barcode | String | 否 | "" | 条形码 | 普通索引 |
| price | Number | 是 | 0 | 销售价格 | 普通索引 |
| originalPrice | Number | 否 | 0 | 原价 | - |
| costPrice | Number | 否 | 0 | 成本价 | - |
| wholesalePrice | Number | 否 | 0 | 批发价 | - |
| stock | Number | 否 | 0 | 库存数量 | 普通索引 |
| minStock | Number | 否 | 0 | 最低库存 | - |
| maxStock | Number | 否 | 0 | 最高库存 | - |
| unit | String | 否 | "件" | 计量单位 | - |
| weight | Number | 否 | 0 | 重量(克) | - |
| volume | Number | 否 | 0 | 体积(立方厘米) | - |
| dimensions | Object | 否 | {} | 尺寸信息 | - |
| images | Array | 否 | [] | 商品图片 | - |
| videos | Array | 否 | [] | 商品视频 | - |
| specifications | Object | 否 | {} | 规格参数 | - |
| variants | Array | 否 | [] | 商品变体 | - |
| tags | Array | 否 | [] | 商品标签 | - |
| status | String | 否 | "active" | 状态 | 普通索引 |
| isActive | Boolean | 否 | true | 是否启用 | 普通索引 |
| createBy | String | 是 | - | 创建人 | 普通索引 |
| createTime | Date | 是 | 当前时间 | 创建时间 | 普通索引 |
| updateTime | Date | 是 | 当前时间 | 更新时间 | - |

**示例数据：**
```json
{
  "_id": "60f1234567890abcdef12345",
  "productNo": "PRD202107160001",
  "name": "iPhone 13 Pro Max",
  "description": "苹果iPhone 13 Pro Max，6.7英寸超视网膜XDR显示屏",
  "shortDesc": "苹果旗舰手机",
  "category": "电子产品",
  "subCategory": "智能手机",
  "brand": "Apple",
  "model": "iPhone 13 Pro Max",
  "sku": "IPHONE13PM-256-BLUE",
  "barcode": "1234567890123",
  "price": 8999.00,
  "originalPrice": 9999.00,
  "costPrice": 7500.00,
  "wholesalePrice": 8500.00,
  "stock": 50,
  "minStock": 5,
  "maxStock": 200,
  "unit": "台",
  "weight": 238,
  "volume": 150,
  "dimensions": {
    "length": 160.8,
    "width": 78.1,
    "height": 7.65
  },
  "images": [
    "https://example.com/images/iphone13pm-1.jpg",
    "https://example.com/images/iphone13pm-2.jpg"
  ],
  "videos": [
    "https://example.com/videos/iphone13pm-intro.mp4"
  ],
  "specifications": {
    "屏幕尺寸": "6.7英寸",
    "存储容量": "256GB",
    "颜色": "远峰蓝色",
    "处理器": "A15仿生芯片",
    "摄像头": "1200万像素三摄系统"
  },
  "variants": [
    {
      "id": "var_001",
      "name": "128GB 远峰蓝色",
      "sku": "IPHONE13PM-128-BLUE",
      "price": 7999.00,
      "stock": 30
    }
  ],
  "tags": ["热销", "新品", "5G"],
  "status": "active",
  "isActive": true,
  "createBy": "admin001",
  "createTime": "2021-07-16T08:00:00.000Z",
  "updateTime": "2021-07-16T08:00:00.000Z"
}
```

#### 2.2 shopProducts - 商城商品表

**用途：** 商城展示的商品信息，继承基础商品并添加商城特有属性

**字段定义：**

| 字段名 | 类型 | 必填 | 默认值 | 描述 | 索引 |
|--------|------|------|--------|------|------|
| _id | ObjectId | 是 | 自动生成 | 主键 | 主键 |
| productId | String | 是 | - | 关联基础商品ID | 普通索引 |
| onSale | Boolean | 否 | false | 是否上架 | 普通索引 |
| isRecommended | Boolean | 否 | false | 是否推荐 | 普通索引 |
| isFeatured | Boolean | 否 | false | 是否精选 | 普通索引 |
| isHot | Boolean | 否 | false | 是否热销 | 普通索引 |
| isNew | Boolean | 否 | false | 是否新品 | 普通索引 |
| sortOrder | Number | 否 | 0 | 排序权重 | 普通索引 |
| saleCount | Number | 否 | 0 | 销量 | 普通索引 |
| viewCount | Number | 否 | 0 | 浏览量 | 普通索引 |
| favoriteCount | Number | 否 | 0 | 收藏量 | - |
| rating | Number | 否 | 0 | 平均评分 | 普通索引 |
| reviewCount | Number | 否 | 0 | 评论数量 | - |
| mallPrice | Number | 否 | 0 | 商城价格 | 普通索引 |
| promotionPrice | Number | 否 | 0 | 促销价格 | - |
| promotionStart | Date | 否 | null | 促销开始时间 | - |
| promotionEnd | Date | 否 | null | 促销结束时间 | - |
| limitQuantity | Number | 否 | 0 | 限购数量(0=不限购) | - |
| minOrderQuantity | Number | 否 | 1 | 最小起订量 | - |
| maxOrderQuantity | Number | 否 | 0 | 最大订购量(0=不限制) | - |
| shippingFree | Boolean | 否 | false | 是否包邮 | - |
| shippingWeight | Number | 否 | 0 | 运费重量 | - |
| deliveryTime | String | 否 | "" | 发货时间 | - |
| returnPolicy | String | 否 | "" | 退换政策 | - |
| seoTitle | String | 否 | "" | SEO标题 | - |
| seoDescription | String | 否 | "" | SEO描述 | - |
| seoKeywords | String | 否 | "" | SEO关键词 | - |
| publishTime | Date | 否 | null | 上架时间 | 普通索引 |
| offlineTime | Date | 否 | null | 下架时间 | - |
| createTime | Date | 是 | 当前时间 | 创建时间 | 普通索引 |
| updateTime | Date | 是 | 当前时间 | 更新时间 | - |

#### 2.3 categories - 商品分类表

**用途：** 存储商品分类信息

**字段定义：**

| 字段名 | 类型 | 必填 | 默认值 | 描述 | 索引 |
|--------|------|------|--------|------|------|
| _id | ObjectId | 是 | 自动生成 | 主键 | 主键 |
| name | String | 是 | - | 分类名称 | 普通索引 |
| code | String | 是 | - | 分类编码 | 唯一索引 |
| parentId | String | 否 | "" | 父分类ID | 普通索引 |
| level | Number | 否 | 1 | 分类层级 | 普通索引 |
| path | String | 否 | "" | 分类路径 | - |
| icon | String | 否 | "" | 分类图标 | - |
| image | String | 否 | "" | 分类图片 | - |
| description | String | 否 | "" | 分类描述 | - |
| sortOrder | Number | 否 | 0 | 排序 | 普通索引 |
| isActive | Boolean | 否 | true | 是否启用 | 普通索引 |
| productCount | Number | 否 | 0 | 商品数量 | - |
| createTime | Date | 是 | 当前时间 | 创建时间 | 普通索引 |
| updateTime | Date | 是 | 当前时间 | 更新时间 | - |

### 3. 订单管理模块

#### 3.1 orders - 订单主表

**用途：** 存储订单主要信息

**字段定义：**

| 字段名 | 类型 | 必填 | 默认值 | 描述 | 索引 |
|--------|------|------|--------|------|------|
| _id | ObjectId | 是 | 自动生成 | 主键 | 主键 |
| orderNo | String | 是 | 自动生成 | 订单号 | 唯一索引 |
| type | String | 是 | - | 订单类型(mall/backend) | 普通索引 |
| userId | String | 否 | "" | 用户ID(商城订单) | 普通索引 |
| customerId | String | 否 | "" | 客户ID(后台订单) | 普通索引 |
| items | Array | 是 | [] | 订单商品列表 | - |
| itemCount | Number | 否 | 0 | 商品总数量 | - |
| totalAmount | Number | 是 | 0 | 商品总金额 | 普通索引 |
| discountAmount | Number | 否 | 0 | 优惠金额 | - |
| shippingFee | Number | 否 | 0 | 运费 | - |
| taxAmount | Number | 否 | 0 | 税费 | - |
| finalAmount | Number | 是 | 0 | 实付金额 | 普通索引 |
| currency | String | 否 | "CNY" | 货币类型 | - |
| status | String | 是 | "pending" | 订单状态 | 普通索引 |
| paymentStatus | String | 否 | "pending" | 支付状态 | 普通索引 |
| paymentMethod | String | 否 | "" | 支付方式 | 普通索引 |
| paymentId | String | 否 | "" | 支付流水号 | - |
| shippingAddress | Object | 否 | {} | 收货地址 | - |
| billingAddress | Object | 否 | {} | 账单地址 | - |
| shippingMethod | String | 否 | "" | 配送方式 | - |
| trackingNumber | String | 否 | "" | 快递单号 | 普通索引 |
| courierCompany | String | 否 | "" | 快递公司 | - |
| couponId | String | 否 | "" | 使用的优惠券ID | - |
| couponAmount | Number | 否 | 0 | 优惠券金额 | - |
| pointsUsed | Number | 否 | 0 | 使用积分 | - |
| pointsEarned | Number | 否 | 0 | 获得积分 | - |
| notes | String | 否 | "" | 订单备注 | - |
| customerNotes | String | 否 | "" | 客户备注 | - |
| operatorId | String | 否 | "" | 操作员ID | 普通索引 |
| salesRep | String | 否 | "" | 销售代表 | - |
| source | String | 否 | "" | 订单来源 | 普通索引 |
| createTime | Date | 是 | 当前时间 | 创建时间 | 普通索引 |
| updateTime | Date | 是 | 当前时间 | 更新时间 | - |
| payTime | Date | 否 | null | 支付时间 | 普通索引 |
| shipTime | Date | 否 | null | 发货时间 | 普通索引 |
| deliverTime | Date | 否 | null | 送达时间 | - |
| finishTime | Date | 否 | null | 完成时间 | - |
| cancelTime | Date | 否 | null | 取消时间 | - |
| cancelReason | String | 否 | "" | 取消原因 | - |

**订单状态枚举：**
- `pending` - 待支付
- `paid` - 已支付
- `processing` - 处理中
- `shipped` - 已发货
- `delivered` - 已送达
- `completed` - 已完成
- `cancelled` - 已取消
- `refunded` - 已退款

**支付状态枚举：**
- `pending` - 待支付
- `paid` - 已支付
- `failed` - 支付失败
- `refunded` - 已退款
- `partial_refunded` - 部分退款

**示例数据：**
```json
{
  "_id": "60f1234567890abcdef12345",
  "orderNo": "ORD202107160001",
  "type": "mall",
  "userId": "oXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
  "customerId": "",
  "items": [
    {
      "productId": "60f1234567890abcdef12345",
      "name": "iPhone 13 Pro Max",
      "sku": "IPHONE13PM-256-BLUE",
      "price": 8999.00,
      "quantity": 1,
      "subtotal": 8999.00,
      "specifications": {
        "颜色": "远峰蓝色",
        "存储": "256GB"
      }
    }
  ],
  "itemCount": 1,
  "totalAmount": 8999.00,
  "discountAmount": 500.00,
  "shippingFee": 0.00,
  "taxAmount": 0.00,
  "finalAmount": 8499.00,
  "currency": "CNY",
  "status": "shipped",
  "paymentStatus": "paid",
  "paymentMethod": "wechat_pay",
  "paymentId": "wx_pay_123456789",
  "shippingAddress": {
    "name": "张三",
    "phone": "13800138000",
    "province": "北京",
    "city": "北京市",
    "district": "朝阳区",
    "detail": "某某街道123号",
    "postalCode": "100000"
  },
  "shippingMethod": "express",
  "trackingNumber": "SF1234567890",
  "courierCompany": "顺丰速运",
  "couponId": "60f1234567890abcdef12345",
  "couponAmount": 500.00,
  "pointsUsed": 0,
  "pointsEarned": 849,
  "notes": "请尽快发货",
  "customerNotes": "工作日送货",
  "operatorId": "",
  "salesRep": "",
  "source": "miniprogram",
  "createTime": "2021-07-16T08:00:00.000Z",
  "updateTime": "2021-07-17T10:30:00.000Z",
  "payTime": "2021-07-16T08:05:00.000Z",
  "shipTime": "2021-07-17T10:30:00.000Z",
  "deliverTime": null,
  "finishTime": null,
  "cancelTime": null,
  "cancelReason": ""
}
```

### 4. 财务管理模块

#### 4.1 prepaidRecords - 预存记录表

**用途：** 存储客户预存充值和消费记录

**字段定义：**

| 字段名 | 类型 | 必填 | 默认值 | 描述 | 索引 |
|--------|------|------|--------|------|------|
| _id | ObjectId | 是 | 自动生成 | 主键 | 主键 |
| recordNo | String | 是 | 自动生成 | 记录编号 | 唯一索引 |
| customerId | String | 是 | - | 客户ID | 普通索引 |
| type | String | 是 | - | 类型(recharge/consume/refund) | 普通索引 |
| amount | Number | 是 | 0 | 金额 | 普通索引 |
| balanceBefore | Number | 是 | 0 | 操作前余额 | - |
| balanceAfter | Number | 是 | 0 | 操作后余额 | - |
| paymentMethod | String | 否 | "" | 支付方式 | 普通索引 |
| paymentId | String | 否 | "" | 支付流水号 | - |
| orderId | String | 否 | "" | 关联订单ID | 普通索引 |
| description | String | 否 | "" | 描述 | - |
| notes | String | 否 | "" | 备注 | - |
| operatorId | String | 是 | - | 操作员ID | 普通索引 |
| status | String | 否 | "completed" | 状态 | 普通索引 |
| createTime | Date | 是 | 当前时间 | 创建时间 | 普通索引 |
| updateTime | Date | 是 | 当前时间 | 更新时间 | - |

#### 4.2 transactions - 交易记录表

**用途：** 存储所有交易记录

**字段定义：**

| 字段名 | 类型 | 必填 | 默认值 | 描述 | 索引 |
|--------|------|------|--------|------|------|
| _id | ObjectId | 是 | 自动生成 | 主键 | 主键 |
| transactionNo | String | 是 | 自动生成 | 交易号 | 唯一索引 |
| type | String | 是 | - | 交易类型 | 普通索引 |
| userId | String | 否 | "" | 用户ID | 普通索引 |
| customerId | String | 否 | "" | 客户ID | 普通索引 |
| orderId | String | 否 | "" | 订单ID | 普通索引 |
| amount | Number | 是 | 0 | 交易金额 | 普通索引 |
| currency | String | 否 | "CNY" | 货币类型 | - |
| paymentMethod | String | 是 | - | 支付方式 | 普通索引 |
| paymentId | String | 否 | "" | 第三方支付ID | - |
| status | String | 是 | "pending" | 交易状态 | 普通索引 |
| description | String | 否 | "" | 交易描述 | - |
| metadata | Object | 否 | {} | 元数据 | - |
| createTime | Date | 是 | 当前时间 | 创建时间 | 普通索引 |
| updateTime | Date | 是 | 当前时间 | 更新时间 | - |
| completedTime | Date | 否 | null | 完成时间 | - |

### 5. 营销管理模块

#### 5.1 coupons - 优惠券表

**用途：** 存储优惠券信息

**字段定义：**

| 字段名 | 类型 | 必填 | 默认值 | 描述 | 索引 |
|--------|------|------|--------|------|------|
| _id | ObjectId | 是 | 自动生成 | 主键 | 主键 |
| code | String | 是 | 自动生成 | 优惠券码 | 唯一索引 |
| name | String | 是 | - | 优惠券名称 | - |
| description | String | 否 | "" | 描述 | - |
| type | String | 是 | - | 类型(fixed/percent) | 普通索引 |
| value | Number | 是 | 0 | 优惠值 | - |
| minAmount | Number | 否 | 0 | 最低消费金额 | - |
| maxDiscount | Number | 否 | 0 | 最大优惠金额 | - |
| totalQuantity | Number | 是 | 0 | 总发放数量 | - |
| usedQuantity | Number | 否 | 0 | 已使用数量 | - |
| remainingQuantity | Number | 否 | 0 | 剩余数量 | - |
| userLimit | Number | 否 | 1 | 每用户限领数量 | - |
| applicableProducts | Array | 否 | [] | 适用商品 | - |
| applicableCategories | Array | 否 | [] | 适用分类 | - |
| excludeProducts | Array | 否 | [] | 排除商品 | - |
| startTime | Date | 是 | - | 开始时间 | 普通索引 |
| endTime | Date | 是 | - | 结束时间 | 普通索引 |
| validDays | Number | 否 | 0 | 有效天数(0=按时间) | - |
| status | String | 否 | "active" | 状态 | 普通索引 |
| createBy | String | 是 | - | 创建人 | - |
| createTime | Date | 是 | 当前时间 | 创建时间 | 普通索引 |
| updateTime | Date | 是 | 当前时间 | 更新时间 | - |

#### 5.2 points - 积分记录表

**用途：** 存储用户积分变动记录

**字段定义：**

| 字段名 | 类型 | 必填 | 默认值 | 描述 | 索引 |
|--------|------|------|--------|------|------|
| _id | ObjectId | 是 | 自动生成 | 主键 | 主键 |
| userId | String | 是 | - | 用户ID | 普通索引 |
| type | String | 是 | - | 类型(earn/spend/expire) | 普通索引 |
| amount | Number | 是 | 0 | 积分数量 | 普通索引 |
| balanceBefore | Number | 是 | 0 | 操作前积分 | - |
| balanceAfter | Number | 是 | 0 | 操作后积分 | - |
| source | String | 是 | - | 积分来源 | 普通索引 |
| orderId | String | 否 | "" | 关联订单ID | 普通索引 |
| description | String | 否 | "" | 描述 | - |
| expireTime | Date | 否 | null | 过期时间 | 普通索引 |
| status | String | 否 | "active" | 状态 | 普通索引 |
| createTime | Date | 是 | 当前时间 | 创建时间 | 普通索引 |
| updateTime | Date | 是 | 当前时间 | 更新时间 | - |

### 6. 内容管理模块

#### 6.1 banners - 轮播图表

**用途：** 存储首页轮播图信息

**字段定义：**

| 字段名 | 类型 | 必填 | 默认值 | 描述 | 索引 |
|--------|------|------|--------|------|------|
| _id | ObjectId | 是 | 自动生成 | 主键 | 主键 |
| title | String | 是 | - | 标题 | - |
| subtitle | String | 否 | "" | 副标题 | - |
| imageUrl | String | 是 | - | 图片URL | - |
| mobileImageUrl | String | 否 | "" | 移动端图片URL | - |
| linkType | String | 是 | - | 链接类型 | 普通索引 |
| linkValue | String | 否 | "" | 链接值 | - |
| position | String | 否 | "home" | 位置 | 普通索引 |
| sortOrder | Number | 否 | 0 | 排序 | 普通索引 |
| isActive | Boolean | 否 | true | 是否启用 | 普通索引 |
| startTime | Date | 否 | null | 开始时间 | 普通索引 |
| endTime | Date | 否 | null | 结束时间 | 普通索引 |
| clickCount | Number | 否 | 0 | 点击次数 | - |
| createBy | String | 是 | - | 创建人 | - |
| createTime | Date | 是 | 当前时间 | 创建时间 | 普通索引 |
| updateTime | Date | 是 | 当前时间 | 更新时间 | - |

#### 6.2 homepageConfig - 首页配置表

**用途：** 存储首页配置信息

**字段定义：**

| 字段名 | 类型 | 必填 | 默认值 | 描述 | 索引 |
|--------|------|------|--------|------|------|
| _id | ObjectId | 是 | 自动生成 | 主键 | 主键 |
| configKey | String | 是 | - | 配置键 | 唯一索引 |
| configValue | Object | 是 | {} | 配置值 | - |
| description | String | 否 | "" | 描述 | - |
| version | Number | 否 | 1 | 版本号 | - |
| isActive | Boolean | 否 | true | 是否启用 | 普通索引 |
| createBy | String | 是 | - | 创建人 | - |
| createTime | Date | 是 | 当前时间 | 创建时间 | 普通索引 |
| updateTime | Date | 是 | 当前时间 | 更新时间 | - |

### 7. 系统管理模块

#### 7.1 operationLogs - 操作日志表

**用途：** 记录系统操作日志

**字段定义：**

| 字段名 | 类型 | 必填 | 默认值 | 描述 | 索引 |
|--------|------|------|--------|------|------|
| _id | ObjectId | 是 | 自动生成 | 主键 | 主键 |
| userId | String | 否 | "" | 用户ID | 普通索引 |
| adminId | String | 否 | "" | 管理员ID | 普通索引 |
| operation | String | 是 | - | 操作类型 | 普通索引 |
| module | String | 是 | - | 模块名称 | 普通索引 |
| action | String | 是 | - | 具体动作 | 普通索引 |
| targetType | String | 否 | "" | 目标类型 | - |
| targetId | String | 否 | "" | 目标ID | 普通索引 |
| details | Object | 否 | {} | 操作详情 | - |
| result | String | 否 | "success" | 操作结果 | 普通索引 |
| errorMessage | String | 否 | "" | 错误信息 | - |
| ip | String | 否 | "" | IP地址 | 普通索引 |
| userAgent | String | 否 | "" | 用户代理 | - |
| duration | Number | 否 | 0 | 执行时长(毫秒) | - |
| createTime | Date | 是 | 当前时间 | 创建时间 | 普通索引 |

## 索引设计策略

### 1. 主要索引

```javascript
// 用户相关索引
db.users.createIndex({ "openid": 1 }, { unique: true })
db.users.createIndex({ "phone": 1 })
db.users.createIndex({ "points": -1 })
db.users.createIndex({ "totalSpent": -1 })
db.users.createIndex({ "createTime": -1 })
db.users.createIndex({ "lastLoginTime": -1 })

// 客户相关索引
db.customers.createIndex({ "customerNo": 1 }, { unique: true })
db.customers.createIndex({ "phone": 1 }, { unique: true })
db.customers.createIndex({ "name": 1 })
db.customers.createIndex({ "prepaidBalance": -1 })
db.customers.createIndex({ "totalSpent": -1 })
db.customers.createIndex({ "createTime": -1 })

// 商品相关索引
db.products.createIndex({ "productNo": 1 }, { unique: true })
db.products.createIndex({ "name": "text", "description": "text" })
db.products.createIndex({ "category": 1, "isActive": 1 })
db.products.createIndex({ "price": 1 })
db.products.createIndex({ "stock": 1 })
db.products.createIndex({ "createTime": -1 })

// 商城商品索引
db.shopProducts.createIndex({ "productId": 1 })
db.shopProducts.createIndex({ "onSale": 1, "sortOrder": -1 })
db.shopProducts.createIndex({ "isRecommended": 1 })
db.shopProducts.createIndex({ "saleCount": -1 })
db.shopProducts.createIndex({ "rating": -1 })
db.shopProducts.createIndex({ "publishTime": -1 })

// 订单相关索引
db.orders.createIndex({ "orderNo": 1 }, { unique: true })
db.orders.createIndex({ "userId": 1, "createTime": -1 })
db.orders.createIndex({ "customerId": 1, "createTime": -1 })
db.orders.createIndex({ "status": 1 })
db.orders.createIndex({ "paymentStatus": 1 })
db.orders.createIndex({ "createTime": -1 })
db.orders.createIndex({ "payTime": -1 })
db.orders.createIndex({ "shipTime": -1 })

// 复合索引
db.orders.createIndex({ "userId": 1, "status": 1, "createTime": -1 })
db.orders.createIndex({ "type": 1, "status": 1, "createTime": -1 })
db.products.createIndex({ "category": 1, "price": 1 })
db.shopProducts.createIndex({ "onSale": 1, "category": 1, "sortOrder": -1 })
```

### 2. 性能优化索引

```javascript
// 分页查询优化
db.orders.createIndex({ "createTime": -1, "_id": 1 })
db.products.createIndex({ "category": 1, "createTime": -1, "_id": 1 })

// 统计查询优化
db.orders.createIndex({ "status": 1, "createTime": -1 })
db.orders.createIndex({ "userId": 1, "status": 1 })
db.transactions.createIndex({ "type": 1, "createTime": -1 })

// 搜索优化
db.products.createIndex({ 
  "name": "text", 
  "description": "text", 
  "category": "text" 
}, {
  weights: {
    "name": 10,
    "category": 5,
    "description": 1
  }
})
```

## 数据关系设计

### 1. 关系图

```
用户关系图
┌─────────────┐    1:N    ┌─────────────┐
│    users    │ ────────→ │   orders    │
└─────────────┘           └─────────────┘
                                 │
                                 │ 1:N
                                 ▼
                          ┌─────────────┐
                          │ orderItems  │
                          └─────────────┘
                                 │
                                 │ N:1
                                 ▼
┌─────────────┐           ┌─────────────┐
│  products   │ ◄──────── │shopProducts │
└─────────────┘    1:1    └─────────────┘
       │
       │ N:1
       ▼
┌─────────────┐
│ categories  │
└─────────────┘

客户关系图
┌─────────────┐    1:N    ┌─────────────┐
│  customers  │ ────────→ │   orders    │
└─────────────┘           └─────────────┘
       │
       │ 1:N
       ▼
┌─────────────┐
│prepaidRecords│
└─────────────┘
```

### 2. 外键约束

虽然MongoDB不支持传统的外键约束，但我们在应用层实现引用完整性：

```javascript
// 订单商品引用检查
const validateOrderItems = async (items) => {
  for (const item of items) {
    const product = await db.collection('products')
      .doc(item.productId)
      .get()
    
    if (!product.data) {
      throw new Error(`商品 ${item.productId} 不存在`)
    }
    
    if (product.data.stock < item.quantity) {
      throw new Error(`商品 ${product.data.name} 库存不足`)
    }
  }
}

// 用户订单关联检查
const validateUserOrder = async (userId, orderId) => {
  const order = await db.collection('orders')
    .where({ _id: orderId, userId })
    .get()
  
  if (order.data.length === 0) {
    throw new Error('订单不存在或无权限访问')
  }
  
  return order.data[0]
}
```

## 数据安全设计

### 1. 权限控制

```javascript
// 数据库权限配置
const securityRules = {
  // 用户只能访问自己的数据
  "users": {
    "read": "auth.openid == resource.openid",
    "write": "auth.openid == resource.openid"
  },
  
  // 订单用户隔离
  "orders": {
    "read": "auth.openid == resource.userId || auth.role == 'admin'",
    "write": "auth.role == 'admin'"
  },
  
  // 商品公开读取，管理员写入
  "products": {
    "read": true,
    "write": "auth.role == 'admin'"
  },
  
  // 管理员数据
  "admins": {
    "read": "auth.role == 'admin'",
    "write": "auth.role == 'super_admin'"
  }
}
```

### 2. 敏感数据处理

```javascript
// 敏感字段加密
const encryptSensitiveFields = (data) => {
  const sensitiveFields = ['phone', 'email', 'address']
  
  for (const field of sensitiveFields) {
    if (data[field]) {
      data[field] = encrypt(data[field])
    }
  }
  
  return data
}

// 数据脱敏
const maskSensitiveData = (data) => {
  if (data.phone) {
    data.phone = data.phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2')
  }
  
  if (data.email) {
    data.email = data.email.replace(/(.{2}).*(@.*)/, '$1***$2')
  }
  
  return data
}
```

## 数据备份策略

### 1. 自动备份

```javascript
// 定时备份云函数
exports.main = async (event, context) => {
  const collections = [
    'users', 'customers', 'products', 'orders', 
    'transactions', 'coupons', 'operationLogs'
  ]
  
  for (const collectionName of collections) {
    try {
      // 导出数据
      const data = await db.collection(collectionName).get()
      
      // 上传到COS
      const backupKey = `backup/${collectionName}/${new Date().toISOString()}.json`
      await uploadToCOS(backupKey, JSON.stringify(data.data))
      
      console.log(`${collectionName} 备份完成`)
    } catch (error) {
      console.error(`${collectionName} 备份失败:`, error)
    }
  }
}
```

### 2. 数据恢复

```javascript
// 数据恢复云函数
exports.main = async (event, context) => {
  const { collectionName, backupKey } = event
  
  try {
    // 从COS下载备份数据
    const backupData = await downloadFromCOS(backupKey)
    const data = JSON.parse(backupData)
    
    // 清空现有数据（谨慎操作）
    await db.collection(collectionName).where({}).remove()
    
    // 批量插入备份数据
    const batchSize = 100
    for (let i = 0; i < data.length; i += batchSize) {
      const batch = data.slice(i, i + batchSize)
      await db.collection(collectionName).add(batch)
    }
    
    return { success: true, message: '数据恢复完成' }
  } catch (error) {
    console.error('数据恢复失败:', error)
    return { success: false, error: error.message }
  }
}
```

## 性能监控

### 1. 查询性能监控

```javascript
// 慢查询监控
const monitorSlowQueries = async () => {
  const slowQueries = await db.runCommand({
    "profile": 2,
    "slowms": 1000  // 超过1秒的查询
  })
  
  // 分析慢查询并优化
  for (const query of slowQueries) {
    console.log('慢查询:', {
      collection: query.ns,
      duration: query.millis,
      command: query.command
    })
    
    // 自动优化建议
    if (query.millis > 5000) {
      console.warn('严重慢查询，建议立即优化')
    }
  }
}
```

### 2. 数据库统计

```javascript
// 数据库统计信息
const getDatabaseStats = async () => {
  const collections = [
    'users', 'customers', 'products', 'orders', 
    'transactions', 'coupons'
  ]
  
  const stats = {}
  
  for (const collection of collections) {
    const count = await db.collection(collection).count()
    const size = await db.collection(collection).stats()
    
    stats[collection] = {
      documentCount: count.total,
      storageSize: size.storageSize,
      indexSize: size.totalIndexSize,
      avgDocumentSize: size.avgObjSize
    }
  }
  
  return stats
}
```

## 数据迁移策略

### 1. 版本控制

```javascript
// 数据库版本管理
const migrations = {
  '1.0.0': {
    description: '初始化数据库结构',
    up: async () => {
      // 创建基础集合
      await createCollections()
      await createIndexes()
    },
    down: async () => {
      // 回滚操作
      await dropCollections()
    }
  },
  
  '1.1.0': {
    description: '添加用户积分系统',
    up: async () => {
      // 为现有用户添加积分字段
      await db.collection('users').update(
        {},
        { $set: { points: 0, totalEarned: 0, totalSpent: 0 } },
        { multi: true }
      )
      
      // 创建积分记录表
      await db.createCollection('points')
    },
    down: async () => {
      // 移除积分字段
      await db.collection('users').update(
        {},
        { $unset: { points: 1, totalEarned: 1, totalSpent: 1 } },
        { multi: true }
      )
      
      await db.collection('points').drop()
    }
  }
}

// 执行迁移
const runMigration = async (version) => {
  const migration = migrations[version]
  if (!migration) {
    throw new Error(`迁移版本 ${version} 不存在`)
  }
  
  try {
    await migration.up()
    
    // 记录迁移历史
    await db.collection('migrations').add({
      data: {
        version,
        description: migration.description,
        executedAt: new Date(),
        status: 'completed'
      }
    })
    
    console.log(`迁移 ${version} 执行成功`)
  } catch (error) {
    console.error(`迁移 ${version} 执行失败:`, error)
    
    // 记录失败信息
    await db.collection('migrations').add({
      data: {
        version,
        description: migration.description,
        executedAt: new Date(),
        status: 'failed',
        error: error.message
      }
    })
    
    throw error
  }
}
```

### 2. 数据清理

```javascript
// 定期数据清理
const cleanupOldData = async () => {
  const thirtyDaysAgo = new Date()
  thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30)
  
  const sixMonthsAgo = new Date()
  sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6)
  
  // 清理过期的操作日志
  await db.collection('operationLogs')
    .where({
      createTime: db.command.lt(thirtyDaysAgo)
    })
    .remove()
  
  // 清理过期的优惠券
  await db.collection('coupons')
    .where({
      endTime: db.command.lt(new Date()),
      status: 'expired'
    })
    .remove()
  
  // 归档旧订单
  const oldOrders = await db.collection('orders')
    .where({
      createTime: db.command.lt(sixMonthsAgo),
      status: db.command.in(['completed', 'cancelled'])
    })
    .get()
  
  if (oldOrders.data.length > 0) {
    // 移动到归档表
    await db.collection('orders_archive').add(oldOrders.data)
    
    // 删除原记录
    const orderIds = oldOrders.data.map(order => order._id)
    await db.collection('orders')
      .where({
        _id: db.command.in(orderIds)
      })
      .remove()
  }
  
  console.log('数据清理完成')
}
```

## 最佳实践

### 1. 查询优化

```javascript
// 分页查询最佳实践
const getOrdersPaginated = async (userId, page = 1, limit = 10) => {
  const skip = (page - 1) * limit
  
  // 使用索引优化的查询
  const orders = await db.collection('orders')
    .where({
      userId,
      status: db.command.neq('deleted')
    })
    .orderBy('createTime', 'desc')
    .skip(skip)
    .limit(limit)
    .field({
      // 只返回必要字段
      orderNo: true,
      totalAmount: true,
      status: true,
      createTime: true,
      items: true
    })
    .get()
  
  return orders.data
}

// 聚合查询优化
const getOrderStatistics = async (userId, startDate, endDate) => {
  const result = await db.collection('orders')
    .aggregate()
    .match({
      userId,
      createTime: {
        $gte: startDate,
        $lte: endDate
      },
      status: { $ne: 'cancelled' }
    })
    .group({
      _id: null,
      totalOrders: { $sum: 1 },
      totalAmount: { $sum: '$finalAmount' },
      avgAmount: { $avg: '$finalAmount' }
    })
    .end()
  
  return result.list[0] || {
    totalOrders: 0,
    totalAmount: 0,
    avgAmount: 0
  }
}
```

### 2. 事务处理

```javascript
// 订单处理事务
const processOrderTransaction = async (orderData) => {
  const transaction = await db.startTransaction()
  
  try {
    // 1. 创建订单
    const orderResult = await transaction.collection('orders').add({
      data: orderData
    })
    
    // 2. 更新商品库存
    for (const item of orderData.items) {
      const updateResult = await transaction.collection('products')
        .doc(item.productId)
        .update({
          data: {
            stock: db.command.inc(-item.quantity),
            updateTime: db.serverDate()
          }
        })
      
      // 检查库存是否足够
      if (updateResult.stats.updated === 0) {
        throw new Error(`商品 ${item.name} 库存不足`)
      }
    }
    
    // 3. 更新用户积分
    if (orderData.userId) {
      const pointsEarned = Math.floor(orderData.finalAmount)
      await transaction.collection('users')
        .doc(orderData.userId)
        .update({
          data: {
            points: db.command.inc(pointsEarned),
            totalSpent: db.command.inc(orderData.finalAmount),
            orderCount: db.command.inc(1),
            lastOrderTime: db.serverDate()
          }
        })
      
      // 4. 记录积分变动
      await transaction.collection('points').add({
        data: {
          userId: orderData.userId,
          type: 'earn',
          amount: pointsEarned,
          source: 'order',
          orderId: orderResult._id,
          description: '购物获得积分',
          createTime: db.serverDate()
        }
      })
    }
    
    // 5. 提交事务
    await transaction.commit()
    
    return {
      success: true,
      orderId: orderResult._id,
      orderNo: orderData.orderNo
    }
  } catch (error) {
    // 回滚事务
    await transaction.rollback()
    throw error
  }
}
```

### 3. 数据验证

```javascript
// 数据验证规则
const validateUserData = (userData) => {
  const rules = {
    openid: { required: true, type: 'string', minLength: 20 },
    nickName: { required: false, type: 'string', maxLength: 50 },
    phone: { required: false, type: 'string', pattern: /^1[3-9]\d{9}$/ },
    email: { required: false, type: 'string', pattern: /^[^\s@]+@[^\s@]+\.[^\s@]+$/ },
    points: { required: false, type: 'number', min: 0 },
    balance: { required: false, type: 'number', min: 0 }
  }
  
  return validateData(userData, rules)
}

const validateProductData = (productData) => {
  const rules = {
    name: { required: true, type: 'string', minLength: 1, maxLength: 200 },
    category: { required: true, type: 'string' },
    price: { required: true, type: 'number', min: 0 },
    stock: { required: false, type: 'number', min: 0 },
    images: { required: false, type: 'array', maxLength: 10 }
  }
  
  return validateData(productData, rules)
}

const validateData = (data, rules) => {
  const errors = []
  
  for (const [field, rule] of Object.entries(rules)) {
    const value = data[field]
    
    // 必填检查
    if (rule.required && (value === undefined || value === null || value === '')) {
      errors.push(`${field} 是必填字段`)
      continue
    }
    
    // 如果字段为空且非必填，跳过后续检查
    if (!rule.required && (value === undefined || value === null || value === '')) {
      continue
    }
    
    // 类型检查
    if (rule.type && typeof value !== rule.type) {
      errors.push(`${field} 类型错误，期望 ${rule.type}`)
      continue
    }
    
    // 字符串长度检查
    if (rule.type === 'string') {
      if (rule.minLength && value.length < rule.minLength) {
        errors.push(`${field} 长度不能少于 ${rule.minLength} 个字符`)
      }
      if (rule.maxLength && value.length > rule.maxLength) {
        errors.push(`${field} 长度不能超过 ${rule.maxLength} 个字符`)
      }
      if (rule.pattern && !rule.pattern.test(value)) {
        errors.push(`${field} 格式不正确`)
      }
    }
    
    // 数值范围检查
    if (rule.type === 'number') {
      if (rule.min !== undefined && value < rule.min) {
        errors.push(`${field} 不能小于 ${rule.min}`)
      }
      if (rule.max !== undefined && value > rule.max) {
        errors.push(`${field} 不能大于 ${rule.max}`)
      }
    }
    
    // 数组长度检查
    if (rule.type === 'array') {
      if (rule.maxLength && value.length > rule.maxLength) {
        errors.push(`${field} 数组长度不能超过 ${rule.maxLength}`)
      }
    }
  }
  
  return {
    isValid: errors.length === 0,
    errors
  }
}
```

## 总结

本数据库设计文档详细描述了商城系统的完整数据架构，包括：

1. **完整的数据模型** - 涵盖用户、商品、订单、财务、营销等所有业务模块
2. **优化的索引策略** - 确保查询性能和数据检索效率
3. **安全的权限控制** - 实现用户数据隔离和访问控制
4. **可靠的备份恢复** - 保障数据安全和业务连续性
5. **高效的性能监控** - 及时发现和解决性能问题
6. **灵活的迁移策略** - 支持数据库结构的平滑升级
7. **规范的最佳实践** - 确保代码质量和系统稳定性

通过遵循这个设计文档，开发团队可以构建一个高性能、高可用、易维护的商城数据库系统。