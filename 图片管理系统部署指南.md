# 图片管理系统部署指南

## 部署前准备

### 1. 环境要求
- Node.js 14+
- 微信开发者工具
- 腾讯云开发环境
- 云开发CLI工具

### 2. 环境配置
- **环境ID**: `cloudbase-3g4w6lls8a5ce59b`
- **COS存储桶**: 已配置
- **数据库**: MongoDB (云数据库)

## 部署步骤

### 第一步：部署云函数

#### 1.1 部署图片管理云函数
```bash
# 进入云函数目录
cd cloudfunctions/imageManager

# 安装依赖
npm install

# 部署云函数
# 方法1: 使用微信开发者工具
# 在微信开发者工具中右键点击云函数文件夹，选择"上传并部署"

# 方法2: 使用云开发CLI
tcb fn deploy imageManager
```

#### 1.2 部署获取图片列表云函数
```bash
cd cloudfunctions/getImageList
npm install
# 部署方法同上
```

#### 1.3 部署获取临时URL云函数
```bash
cd cloudfunctions/getTempFileURL
npm install
# 部署方法同上
```

#### 1.4 部署COS STS云函数（如果未部署）
```bash
cd cloudfunctions/getCosSts
npm install
# 部署方法同上
```

### 第二步：部署Web端

#### 2.1 构建Web应用
```bash
cd web7.27/miniprogram-admin

# 安装依赖
npm install

# 构建项目
npm run build
```

#### 2.2 部署到静态托管
```bash
# 使用云开发CLI部署
tcb hosting deploy dist/ --path /admin

# 或者使用微信开发者工具
# 在云开发控制台中选择静态网站托管，上传dist目录
```

### 第三步：部署小程序

#### 3.1 配置小程序
```bash
cd 商城小程序

# 检查project.config.json配置
# 确保环境ID正确
```

#### 3.2 上传小程序代码
- 在微信开发者工具中导入项目
- 点击"上传"按钮上传代码
- 在微信公众平台提交审核

### 第四步：数据库初始化

#### 4.1 创建数据库集合
在云开发控制台中创建以下集合：
- `images` - 存储图片信息

#### 4.2 设置数据库权限
```javascript
// images集合权限设置
{
  "read": true,  // 所有人可读
  "write": false // 仅管理端可写
}
```

## 验证部署

### 1. 验证云函数
```javascript
// 在微信开发者工具中测试云函数
wx.cloud.callFunction({
  name: 'getImageList',
  data: {
    category: 'banner',
    path: 'images/banner/'
  }
}).then(res => {
  console.log('云函数测试成功:', res);
});
```

### 2. 验证Web端
- 访问Web端管理后台
- 点击"图片管理"菜单
- 尝试上传一张测试图片

### 3. 验证小程序端
- 在小程序中查看首页轮播图
- 检查图片是否正确显示
- 测试响应式效果

## 配置说明

### 1. COS存储配置
确保COS存储桶配置正确：
- 存储桶名称
- 地域信息
- 访问权限

### 2. 数据库索引
为images集合创建索引：
```javascript
// 按分类和显示顺序查询
db.images.createIndex({
  "category": 1,
  "displayOrder": 1
});

// 按上传时间查询
db.images.createIndex({
  "uploadTime": -1
});
```

### 3. 小程序配置
检查小程序的网络域名配置：
- 云开发域名
- COS存储域名
- 图片CDN域名

## 性能优化

### 1. 图片压缩
- 上传前压缩图片
- 使用合适的图片格式
- 设置合理的图片尺寸

### 2. CDN加速
- 配置COS CDN加速
- 设置缓存策略
- 优化访问速度

### 3. 懒加载
- 小程序端使用懒加载
- 按需加载图片
- 优化用户体验

## 监控和维护

### 1. 日志监控
- 云函数执行日志
- 错误日志监控
- 性能指标监控

### 2. 存储监控
- COS存储使用量
- 数据库读写次数
- 网络流量监控

### 3. 定期维护
- 清理过期图片
- 优化数据库索引
- 更新依赖包

## 故障排除

### 常见问题

#### 1. 云函数部署失败
- 检查Node.js版本
- 检查依赖包安装
- 检查代码语法错误

#### 2. 图片上传失败
- 检查COS权限配置
- 检查网络连接
- 检查文件大小限制

#### 3. 小程序显示异常
- 检查云函数调用
- 检查图片URL有效性
- 检查网络权限配置

### 调试方法
1. 查看云函数执行日志
2. 使用微信开发者工具调试
3. 检查浏览器控制台错误
4. 验证数据库数据

## 安全建议

### 1. 访问控制
- 设置合适的数据库权限
- 限制COS访问权限
- 使用临时密钥

### 2. 数据验证
- 验证文件类型
- 限制文件大小
- 检查恶意文件

### 3. 监控告警
- 设置异常访问告警
- 监控存储使用量
- 记录操作日志

## 联系支持

如遇到部署问题，请联系：
- 开发团队技术支持
- 云开发官方文档
- 微信开发者社区

---

**部署完成后，请按照《图片管理系统使用说明.md》进行功能测试和用户培训。**
