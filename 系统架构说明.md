# 商城系统架构说明

## 系统总体架构

```
┌─────────────────────────────────────────────────────────────┐
│                    商城生态系统架构                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │   用户端    │  │   管理端    │  │   Web端     │          │
│  │ 商城小程序  │  │ 后台小程序  │  │ 后台管理    │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
│         │                │                │                 │
│         └────────────────┼────────────────┘                 │
│                          │                                  │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                 腾讯云开发平台                          │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐       │ │
│  │  │   云函数    │ │   云数据库  │ │   云存储    │       │ │
│  │  │ (Node.js)   │ │ (MongoDB)   │ │   (COS)     │       │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘       │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 三端架构详解

### 1. 用户端 - 商城小程序

**技术栈：**
- 微信小程序原生框架
- TDesign UI组件库
- 微信云开发SDK

**核心功能：**
```
商城小程序
├── 用户认证 (微信登录)
├── 商品浏览 (分类筛选)
├── 购物车管理
├── 订单管理 (下单/查看/跟踪)
├── 个人中心 (积分/优惠券/余额)
├── 地址管理
└── 支付集成 (微信支付/余额支付)
```

**数据隔离机制：**
```javascript
// 用户数据隔离示例
const { OPENID } = cloud.getWXContext()

// 所有用户相关查询都必须包含用户标识
const userOrders = await db.collection('orders')
  .where({ 
    userId: OPENID,  // 关键：确保用户只能访问自己的数据
    isDeleted: false 
  })
  .get()
```

### 2. 管理端 - 后台小程序

**技术栈：**
- 微信小程序原生框架
- 自定义UI组件
- 微信云开发SDK

**核心功能：**
```
后台管理小程序
├── 库存管理
│   ├── 产品入库/出库
│   ├── 库存查询
│   ├── 低库存预警
│   └── 库存统计
├── 订单管理
│   ├── 内部下单
│   ├── 代客下单
│   ├── 订单状态管理
│   └── 订单统计
├── 客户管理
│   ├── 客户信息维护
│   ├── 客户合并
│   ├── 客户订单历史
│   └── 客户统计
├── 预存管理
│   ├── 预存充值
│   ├── 预存消费
│   ├── 余额查询
│   └── 交易记录
└── 产品管理
    ├── 产品增删改查
    ├── 产品分类管理
    ├── 价格管理
    └── 产品统计
```

### 3. Web端 - 后台管理系统

**技术栈：**
- React 18 + Hooks
- Vite (构建工具)
- TailwindCSS + DaisyUI
- React Router (路由)
- 腾讯云开发Web SDK

**核心功能：**
```
Web后台管理
├── 基础管理 (与小程序后台功能一致)
│   ├── 用户管理
│   ├── 订单管理
│   ├── 预存管理
│   └── 商城下单
├── 商城管理 (专门管理商城小程序)
│   ├── 首页布局装修
│   │   ├── 轮播图管理
│   │   ├── 推广配置
│   │   ├── 价格设置
│   │   └── 文案管理
│   ├── 商品管理
│   │   ├── 商品上架/下架
│   │   ├── 商品分类
│   │   ├── 库存同步
│   │   └── 价格管理
│   ├── 营销管理
│   │   ├── 优惠券发放
│   │   ├── 活动配置
│   │   ├── 会员等级
│   │   └── 积分规则
│   └── 数据分析
│       ├── 销售统计
│       ├── 用户分析
│       ├── 商品分析
│       └── 财务报表
└── 系统管理
    ├── 权限管理
    ├── 操作日志
    ├── 系统配置
    └── 数据备份
```

## 数据库架构设计

### 数据库集合结构

```
腾讯云开发数据库 (MongoDB)
├── 用户相关
│   ├── users (用户信息)
│   ├── customers (客户信息)
│   └── admins (管理员)
├── 商品相关
│   ├── products (产品信息)
│   ├── shopProducts (商城产品)
│   ├── categories (分类信息)
│   └── inventory (库存记录)
├── 订单相关
│   ├── orders (订单信息)
│   ├── orderItems (订单商品)
│   └── orderLogs (订单日志)
├── 财务相关
│   ├── prepaidRecords (预存记录)
│   ├── transactions (交易记录)
│   └── payments (支付记录)
├── 营销相关
│   ├── coupons (优惠券)
│   ├── promotions (促销活动)
│   └── points (积分记录)
├── 内容管理
│   ├── banners (轮播图)
│   ├── homepageConfig (首页配置)
│   └── announcements (公告)
└── 系统相关
    ├── operationLogs (操作日志)
    ├── systemConfig (系统配置)
    └── backups (备份记录)
```

### 核心数据模型

#### 1. 用户模型
```javascript
// users - 商城用户
{
  _id: ObjectId,
  openid: String,        // 微信OpenID
  unionid: String,       // 微信UnionID
  nickName: String,      // 昵称
  avatarUrl: String,     // 头像
  phone: String,         // 手机号
  gender: Number,        // 性别
  city: String,          // 城市
  province: String,      // 省份
  country: String,       // 国家
  points: Number,        // 积分
  balance: Number,       // 余额
  vipLevel: Number,      // VIP等级
  totalSpent: Number,    // 总消费
  orderCount: Number,    // 订单数量
  lastLoginTime: Date,   // 最后登录时间
  createTime: Date,      // 创建时间
  updateTime: Date,      // 更新时间
  isActive: Boolean      // 是否激活
}

// customers - 后台客户
{
  _id: ObjectId,
  name: String,          // 客户姓名
  phone: String,         // 手机号
  address: String,       // 地址
  birthday: Date,        // 生日
  gender: String,        // 性别
  notes: String,         // 备注
  prepaidBalance: Number, // 预存余额
  totalSpent: Number,    // 总消费
  orderCount: Number,    // 订单数量
  lastOrderTime: Date,   // 最后下单时间
  createTime: Date,      // 创建时间
  updateTime: Date,      // 更新时间
  isActive: Boolean,     // 是否激活
  tags: [String]         // 标签
}
```

#### 2. 商品模型
```javascript
// products - 基础产品
{
  _id: ObjectId,
  name: String,          // 产品名称
  description: String,   // 产品描述
  category: String,      // 分类
  type: String,          // 类型
  brand: String,         // 品牌
  model: String,         // 型号
  price: Number,         // 价格
  originalPrice: Number, // 原价
  costPrice: Number,     // 成本价
  stock: Number,         // 库存
  minStock: Number,      // 最低库存
  maxStock: Number,      // 最高库存
  unit: String,          // 单位
  weight: Number,        // 重量
  volume: Number,        // 体积
  images: [String],      // 图片URLs
  specifications: Object, // 规格参数
  isActive: Boolean,     // 是否启用
  createTime: Date,      // 创建时间
  updateTime: Date       // 更新时间
}

// shopProducts - 商城产品 (继承products)
{
  // 继承products所有字段
  onSale: Boolean,       // 是否上架
  isRecommended: Boolean, // 是否推荐
  isFeatured: Boolean,   // 是否精选
  sortOrder: Number,     // 排序
  saleCount: Number,     // 销量
  viewCount: Number,     // 浏览量
  rating: Number,        // 评分
  reviewCount: Number,   // 评论数
  tags: [String],        // 标签
  seoTitle: String,      // SEO标题
  seoDescription: String, // SEO描述
  publishTime: Date      // 上架时间
}
```

#### 3. 订单模型
```javascript
// orders - 订单信息
{
  _id: ObjectId,
  orderNo: String,       // 订单号
  type: String,          // 订单类型: mall/backend
  userId: String,        // 用户ID (商城订单)
  customerId: String,    // 客户ID (后台订单)
  items: [               // 订单商品
    {
      productId: String,
      name: String,
      price: Number,
      quantity: Number,
      subtotal: Number,
      specifications: Object
    }
  ],
  totalAmount: Number,   // 总金额
  discountAmount: Number, // 优惠金额
  finalAmount: Number,   // 实付金额
  status: String,        // 订单状态
  paymentMethod: String, // 支付方式
  paymentStatus: String, // 支付状态
  shippingAddress: Object, // 收货地址
  shippingMethod: String, // 配送方式
  shippingFee: Number,   // 配送费
  trackingNumber: String, // 快递单号
  notes: String,         // 备注
  operatorId: String,    // 操作员ID
  createTime: Date,      // 创建时间
  updateTime: Date,      // 更新时间
  payTime: Date,         // 支付时间
  shipTime: Date,        // 发货时间
  deliverTime: Date,     // 送达时间
  cancelTime: Date,      // 取消时间
  cancelReason: String   // 取消原因
}
```

## 云函数架构

### 云函数分类

```
云函数架构
├── 认证相关
│   ├── login (用户登录)
│   ├── adminLogin (管理员登录)
│   └── syncUser (同步用户信息)
├── 商品相关
│   ├── getShopProducts (获取商城产品)
│   ├── getProductDetail (获取产品详情)
│   ├── initShopProducts (初始化商城产品)
│   └── deleteProduct (删除产品)
├── 订单相关
│   ├── submitOrder (提交订单)
│   ├── updateOrderStatus (更新订单状态)
│   └── batchUpdateOrders (批量更新订单)
├── 客户相关
│   ├── addPrestore (添加预存)
│   ├── getUserPoints (获取用户积分)
│   └── addPoints (添加积分)
├── 内容管理
│   ├── getBanners (获取轮播图)
│   ├── manageBanners (管理轮播图)
│   ├── manageHomepageConfig (管理首页配置)
│   └── homepageManagement (首页管理)
├── 系统相关
│   ├── createCollection (创建集合)
│   ├── createIndex (创建索引)
│   ├── initDatabase (初始化数据库)
│   └── getCosSts (获取COS临时密钥)
└── 工具相关
    ├── cleanupImageUrls (清理图片URL)
    └── testUpdatePrepaidRecord (测试更新预存记录)
```

### 云函数设计模式

#### 1. 统一响应格式
```javascript
// 标准响应格式
const response = {
  success: Boolean,      // 操作是否成功
  data: Object,          // 返回数据
  message: String,       // 消息
  code: Number,          // 错误码
  timestamp: Number      // 时间戳
}

// 成功响应
return {
  success: true,
  data: result,
  message: '操作成功',
  timestamp: Date.now()
}

// 错误响应
return {
  success: false,
  message: '操作失败',
  code: 500,
  error: error.message,
  timestamp: Date.now()
}
```

#### 2. 权限验证模式
```javascript
// 用户权限验证
const checkUserPermission = async (openid) => {
  if (!openid) {
    throw new Error('用户未登录')
  }
  
  const user = await db.collection('users')
    .where({ openid })
    .get()
    
  if (user.data.length === 0) {
    throw new Error('用户不存在')
  }
  
  return user.data[0]
}

// 管理员权限验证
const checkAdminPermission = async (openid) => {
  const admin = await db.collection('admins')
    .where({ openid, isActive: true })
    .get()
    
  if (admin.data.length === 0) {
    throw new Error('无管理员权限')
  }
  
  return admin.data[0]
}
```

#### 3. 事务处理模式
```javascript
// 订单处理事务示例
const processOrder = async (orderData) => {
  const transaction = await db.startTransaction()
  
  try {
    // 1. 创建订单
    const orderResult = await transaction.collection('orders').add({
      data: orderData
    })
    
    // 2. 更新库存
    for (const item of orderData.items) {
      await transaction.collection('products')
        .doc(item.productId)
        .update({
          data: { stock: db.command.inc(-item.quantity) }
        })
    }
    
    // 3. 更新用户积分
    await transaction.collection('users')
      .doc(orderData.userId)
      .update({
        data: { points: db.command.inc(Math.floor(orderData.totalAmount)) }
      })
    
    // 4. 提交事务
    await transaction.commit()
    
    return { success: true, orderId: orderResult._id }
  } catch (error) {
    // 回滚事务
    await transaction.rollback()
    throw error
  }
}
```

## 安全架构

### 1. 数据安全

```javascript
// 数据库权限配置
{
  "read": "auth",          // 需要登录才能读取
  "write": "auth",         // 需要登录才能写入
  "create": "auth",        // 需要登录才能创建
  "delete": "auth"         // 需要登录才能删除
}

// 敏感数据加密
const crypto = require('crypto')

const encryptSensitiveData = (data) => {
  const cipher = crypto.createCipher('aes192', process.env.SECRET_KEY)
  let encrypted = cipher.update(data, 'utf8', 'hex')
  encrypted += cipher.final('hex')
  return encrypted
}
```

### 2. 接口安全

```javascript
// 参数验证
const validateParams = (params, rules) => {
  for (const [key, rule] of Object.entries(rules)) {
    const value = params[key]
    
    if (rule.required && !value) {
      throw new Error(`参数 ${key} 不能为空`)
    }
    
    if (rule.type && typeof value !== rule.type) {
      throw new Error(`参数 ${key} 类型错误`)
    }
    
    if (rule.min && value < rule.min) {
      throw new Error(`参数 ${key} 不能小于 ${rule.min}`)
    }
    
    if (rule.max && value > rule.max) {
      throw new Error(`参数 ${key} 不能大于 ${rule.max}`)
    }
  }
}

// 使用示例
validateParams(event, {
  amount: { required: true, type: 'number', min: 0.01 },
  customerId: { required: true, type: 'string' }
})
```

### 3. 用户隔离

```javascript
// 确保用户只能访问自己的数据
const getUserData = async (collection, openid, additionalWhere = {}) => {
  return await db.collection(collection)
    .where({
      userId: openid,  // 关键：用户隔离
      ...additionalWhere
    })
    .get()
}

// 管理员数据访问（需要额外权限验证）
const getAdminData = async (collection, adminId, additionalWhere = {}) => {
  // 先验证管理员权限
  await checkAdminPermission(adminId)
  
  return await db.collection(collection)
    .where(additionalWhere)
    .get()
}
```

## 性能优化架构

### 1. 数据库优化

```javascript
// 索引策略
const indexes = [
  // 用户相关索引
  { collection: 'users', fields: { openid: 1 } },
  { collection: 'users', fields: { phone: 1 } },
  
  // 订单相关索引
  { collection: 'orders', fields: { userId: 1, createTime: -1 } },
  { collection: 'orders', fields: { orderNo: 1 } },
  { collection: 'orders', fields: { status: 1 } },
  
  // 商品相关索引
  { collection: 'products', fields: { category: 1, onSale: 1 } },
  { collection: 'products', fields: { name: 'text' } }, // 全文搜索
  
  // 复合索引
  { collection: 'orders', fields: { userId: 1, status: 1, createTime: -1 } }
]

// 分页查询优化
const getPaginatedData = async (collection, page, limit, where = {}) => {
  const skip = (page - 1) * limit
  
  const [data, total] = await Promise.all([
    db.collection(collection)
      .where(where)
      .skip(skip)
      .limit(limit)
      .orderBy('createTime', 'desc')
      .get(),
    db.collection(collection)
      .where(where)
      .count()
  ])
  
  return {
    data: data.data,
    total: total.total,
    page,
    limit,
    totalPages: Math.ceil(total.total / limit)
  }
}
```

### 2. 缓存策略

```javascript
// 内存缓存
const cache = new Map()

const getCachedData = async (key, fetchFunction, ttl = 300000) => {
  const cached = cache.get(key)
  
  if (cached && Date.now() - cached.timestamp < ttl) {
    return cached.data
  }
  
  const data = await fetchFunction()
  cache.set(key, {
    data,
    timestamp: Date.now()
  })
  
  return data
}

// 使用示例
const getProducts = async (category) => {
  return getCachedData(
    `products_${category}`,
    () => db.collection('products').where({ category }).get(),
    600000 // 10分钟缓存
  )
}
```

### 3. 图片优化

```javascript
// 图片压缩和CDN
const optimizeImage = async (imageUrl) => {
  // 腾讯云COS图片处理
  const processedUrl = `${imageUrl}?imageMogr2/thumbnail/800x800/quality/80/format/webp`
  return processedUrl
}

// 响应式图片
const getResponsiveImages = (baseUrl) => {
  return {
    thumbnail: `${baseUrl}?imageMogr2/thumbnail/200x200`,
    small: `${baseUrl}?imageMogr2/thumbnail/400x400`,
    medium: `${baseUrl}?imageMogr2/thumbnail/800x800`,
    large: `${baseUrl}?imageMogr2/thumbnail/1200x1200`
  }
}
```

## 监控和日志架构

### 1. 日志系统

```javascript
// 统一日志格式
const logger = {
  info: (message, data = {}) => {
    console.log(JSON.stringify({
      level: 'INFO',
      message,
      data,
      timestamp: new Date().toISOString(),
      requestId: context.requestId
    }))
  },
  
  error: (message, error = {}) => {
    console.error(JSON.stringify({
      level: 'ERROR',
      message,
      error: {
        message: error.message,
        stack: error.stack
      },
      timestamp: new Date().toISOString(),
      requestId: context.requestId
    }))
  }
}

// 操作日志记录
const logOperation = async (operation, userId, details) => {
  await db.collection('operationLogs').add({
    data: {
      operation,
      userId,
      details,
      timestamp: db.serverDate(),
      ip: context.clientIP,
      userAgent: context.userAgent
    }
  })
}
```

### 2. 性能监控

```javascript
// 性能监控装饰器
const performanceMonitor = (functionName) => {
  return (originalFunction) => {
    return async (event, context) => {
      const startTime = Date.now()
      
      try {
        const result = await originalFunction(event, context)
        const duration = Date.now() - startTime
        
        // 记录性能数据
        logger.info(`${functionName} 执行完成`, {
          duration,
          success: true
        })
        
        // 性能告警
        if (duration > 5000) {
          logger.error(`${functionName} 执行时间过长`, {
            duration,
            threshold: 5000
          })
        }
        
        return result
      } catch (error) {
        const duration = Date.now() - startTime
        logger.error(`${functionName} 执行失败`, {
          duration,
          error: error.message
        })
        throw error
      }
    }
  }
}
```

## 部署架构

### 1. 环境管理

```
环境架构
├── 开发环境 (dev)
│   ├── 云环境ID: cloudbase-dev-xxx
│   ├── 数据库: 测试数据
│   └── 域名: dev.example.com
├── 测试环境 (test)
│   ├── 云环境ID: cloudbase-test-xxx
│   ├── 数据库: 模拟数据
│   └── 域名: test.example.com
└── 生产环境 (prod)
    ├── 云环境ID: cloudbase-prod-xxx
    ├── 数据库: 生产数据
    └── 域名: www.example.com
```

### 2. CI/CD流程

```yaml
# GitHub Actions 示例
name: Deploy to CloudBase

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    
    - name: Setup Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '16'
    
    - name: Install dependencies
      run: npm install
    
    - name: Build project
      run: npm run build
    
    - name: Deploy to CloudBase
      run: |
        npm install -g @cloudbase/cli
        tcb login --apiKeyId ${{ secrets.API_KEY_ID }} --apiKey ${{ secrets.API_KEY }}
        tcb hosting deploy dist -e ${{ secrets.ENV_ID }}
```

这个架构说明文档详细描述了整个商城系统的技术架构、数据模型、安全策略和性能优化方案，为开发团队提供了全面的技术指导。