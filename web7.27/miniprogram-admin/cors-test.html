<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COS CORS配置测试工具</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 COS CORS配置测试工具</h1>
        
        <div class="test-section info">
            <h3>📋 当前配置信息</h3>
            <p><strong>存储桶:</strong> kohin-1327524326</p>
            <p><strong>地域:</strong> ap-guangzhou</p>
            <p><strong>当前域名:</strong> <span id="currentOrigin"></span></p>
        </div>

        <div class="test-section">
            <h3>🧪 CORS配置测试</h3>
            <button onclick="testCORS()">测试CORS配置</button>
            <button onclick="testPreflight()">测试预检请求</button>
            <button onclick="clearResults()">清除结果</button>
            <div id="corsResults"></div>
        </div>

        <div class="test-section">
            <h3>📝 推荐的CORS配置</h3>
            <p>请在腾讯云COS控制台中添加以下CORS规则：</p>
            <pre id="corsConfig"></pre>
        </div>

        <div class="test-section">
            <h3>🔍 问题排查步骤</h3>
            <ol>
                <li>登录腾讯云控制台</li>
                <li>进入对象存储COS → 存储桶列表</li>
                <li>找到存储桶 <code>kohin-1327524326</code></li>
                <li>点击「基础配置」→「跨域访问CORS设置」</li>
                <li>添加上述CORS配置</li>
                <li><strong>重要：</strong>确保在"操作 Methods"中包含 <code>OPTIONS</code> 方法</li>
                <li>保存后等待1-2分钟生效</li>
                <li>清除浏览器缓存后重新运行此测试</li>
            </ol>
            
            <div class="test-section info">
                <h4>💡 常见问题解决</h4>
                <ul>
                    <li><strong>预检请求失败：</strong>检查CORS配置中是否包含OPTIONS方法</li>
                    <li><strong>403错误：</strong>CORS配置正确，但需要有效的认证信息</li>
                    <li><strong>网络错误：</strong>检查存储桶名称和地域是否正确</li>
                    <li><strong>配置不生效：</strong>等待几分钟或清除浏览器缓存</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        const BUCKET = 'kohin-1327524326';
        const REGION = 'ap-guangzhou';
        const COS_ENDPOINT = `https://${BUCKET}.cos.${REGION}.myqcloud.com`;
        
        // 显示当前域名
        document.getElementById('currentOrigin').textContent = window.location.origin;
        
        // 生成推荐的CORS配置
        const corsConfig = {
            "AllowedOrigins": [
                window.location.origin,
                "http://localhost:5173",
                "http://127.0.0.1:5173",
                "http://localhost:3000"
            ],
            "AllowedMethods": ["GET", "POST", "PUT", "DELETE", "HEAD", "OPTIONS"],
            "AllowedHeaders": [
                "*",
                "Content-Type",
                "Content-MD5",
                "Content-Disposition",
                "Date",
                "Expect",
                "Host",
                "x-cos-*",
                "Authorization"
            ],
            "ExposeHeaders": [
                "ETag",
                "x-cos-request-id",
                "x-cos-version-id"
            ],
            "MaxAgeSeconds": 3600
        };
        
        document.getElementById('corsConfig').textContent = JSON.stringify(corsConfig, null, 2);
        
        function addResult(message, type = 'info') {
            const resultsDiv = document.getElementById('corsResults');
            const resultElement = document.createElement('div');
            resultElement.className = `test-section ${type}`;
            resultElement.innerHTML = `<p>${message}</p>`;
            resultsDiv.appendChild(resultElement);
        }
        
        function clearResults() {
            document.getElementById('corsResults').innerHTML = '';
        }
        
        async function testCORS() {
            addResult('🔄 开始测试CORS配置...', 'info');
            
            try {
                const response = await fetch(COS_ENDPOINT, {
                    method: 'HEAD',
                    mode: 'cors'
                });
                
                addResult('✅ 基本CORS配置正常！可以正常访问COS存储桶', 'success');
                
                // 检查响应头
                const corsHeaders = {
                    'Access-Control-Allow-Origin': response.headers.get('Access-Control-Allow-Origin'),
                    'Access-Control-Allow-Methods': response.headers.get('Access-Control-Allow-Methods'),
                    'Access-Control-Allow-Headers': response.headers.get('Access-Control-Allow-Headers'),
                    'Access-Control-Expose-Headers': response.headers.get('Access-Control-Expose-Headers')
                };
                
                addResult(`📋 CORS响应头信息：<pre>${JSON.stringify(corsHeaders, null, 2)}</pre>`, 'info');
                
                // 额外测试：尝试获取一个不存在的文件来测试更完整的CORS
                try {
                    const testResponse = await fetch(`${COS_ENDPOINT}/cors-test-file.txt`, {
                        method: 'GET',
                        mode: 'cors'
                    });
                    addResult('✅ GET请求CORS测试通过', 'success');
                } catch (getError) {
                    if (getError.message.includes('CORS')) {
                        addResult('⚠️ GET请求CORS可能有问题', 'error');
                    } else {
                        addResult('✅ GET请求CORS配置正常（文件不存在是正常的）', 'success');
                    }
                }
                
            } catch (error) {
                addResult(`❌ CORS配置有问题：${error.message}`, 'error');
                addResult('💡 请按照上述步骤配置CORS规则', 'info');
            }
        }
        
        async function testPreflight() {
            addResult('🔄 开始测试预检请求...', 'info');
            
            try {
                // 模拟一个会触发预检请求的复杂请求
                const testUrl = `${COS_ENDPOINT}/test-cors-file.txt`;
                
                const response = await fetch(testUrl, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'text/plain',
                        'x-cos-acl': 'public-read'
                    },
                    body: 'CORS test file',
                    mode: 'cors'
                });
                
                if (response.ok || response.status === 403 || response.status === 404) {
                    // 403/404 表示CORS通过了，但可能没有权限或文件不存在
                    addResult('✅ 预检请求成功！CORS配置正确，支持文件上传操作', 'success');
                    if (response.status === 403) {
                        addResult('ℹ️ 返回403是正常的，表示CORS通过但需要认证', 'info');
                    }
                } else {
                    addResult(`⚠️ 预检请求返回状态码：${response.status}`, 'error');
                }
                
            } catch (error) {
                if (error.message.includes('CORS')) {
                    addResult(`❌ CORS预检请求失败：${error.message}`, 'error');
                    addResult('💡 请检查CORS配置中的AllowedMethods是否包含OPTIONS和PUT', 'info');
                } else {
                    addResult(`❌ 预检请求失败：${error.message}`, 'error');
                    addResult('💡 这可能是网络问题或存储桶配置问题', 'info');
                }
            }
        }
    </script>
</body>
</html>