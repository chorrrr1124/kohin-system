# 🎫 优惠券条件规则系统使用说明

## 📋 系统概述

本系统为优惠券管理提供了完整的条件规则功能，支持多种自动发放条件，让小程序用户可以通过达成特定条件自动获得优惠券。

## 🚀 主要功能

### 1. 自动发放开关
- **启用自动发放**: 勾选后优惠券将根据条件自动发放
- **手动发放**: 不勾选时只能通过管理后台手动发放给指定用户

### 2. 支持的条件类型

#### 🆕 新用户相关
- **新用户注册**: 用户首次注册小程序时自动发放
- **首次下单**: 用户完成第一笔订单时自动发放

#### 💰 消费行为相关
- **订单金额达标**: 单笔订单金额达到设定值时自动发放
- **订单数量达标**: 累计订单数量达到设定值时自动发放

#### 👑 用户等级相关
- **用户等级达标**: 用户等级达到设定等级时自动发放
- 支持等级: 铜牌、银牌、金牌、铂金、钻石

#### 🎉 活动参与相关
- **参与活动**: 用户参与指定活动时自动发放
- **推荐新用户**: 推荐新用户数量达到设定值时自动发放

#### 🎂 时间相关
- **生日当天**: 用户生日当天自动发放
- **注册周年**: 用户注册周年纪念日自动发放

#### 🔧 自定义条件
- **自定义条件**: 可根据具体业务需求设置特殊条件

## 🛠️ 使用方法

### 1. 创建优惠券时设置条件

1. 点击"添加优惠券"按钮
2. 填写基本信息（名称、类型、金额等）
3. 勾选"启用自动发放"
4. 选择具体的发放条件
5. 根据条件类型填写相关参数
6. 保存优惠券

### 2. 条件参数说明

#### 订单金额条件
- **最低订单金额**: 设置触发优惠券发放的最低订单金额
- 例如: 设置为100元，则用户单笔订单≥100元时自动获得优惠券

#### 订单数量条件
- **最低订单数量**: 设置触发优惠券发放的最低订单数量
- 例如: 设置为5单，则用户累计完成5单后自动获得优惠券

#### 用户等级条件
- **用户等级**: 选择触发优惠券发放的用户等级
- 等级从低到高: 铜牌 < 银牌 < 金牌 < 铂金 < 钻石

#### 推荐用户条件
- **推荐用户数量**: 设置触发优惠券发放的推荐用户数量
- 例如: 设置为3人，则用户成功推荐3个新用户后自动获得优惠券

#### 活动参与条件
- **活动名称**: 填写具体的活动名称
- 用户参与该活动时自动获得优惠券

### 3. 查看条件规则

1. 在优惠券列表中，启用自动发放的优惠券会显示"自动"标签
2. 点击"查看规则"按钮（齿轮图标）可以查看详细的发放条件
3. 规则详情包括:
   - 优惠券基本信息
   - 自动发放条件列表
   - 条件参数详情
   - 有效期信息

## 🔄 工作流程

### 1. 实时触发条件
以下条件会在用户操作时实时检查并发放优惠券:
- 新用户注册
- 首次下单
- 订单金额达标
- 订单数量达标
- 用户等级达标
- 参与活动
- 推荐新用户

### 2. 定时检查条件
以下条件会通过定时任务检查并发放优惠券:
- 生日当天
- 注册周年

### 3. 发放流程
1. 系统检测到用户满足条件
2. 检查优惠券是否有效
3. 检查用户是否已拥有该优惠券
4. 自动创建用户优惠券记录
5. 记录触发动作和触发数据

## 📱 小程序端集成

### 1. 调用自动发放云函数

```javascript
// 在用户完成相应操作后调用
wx.cloud.callFunction({
  name: 'autoIssueCoupon',
  data: {
    action: 'firstOrder', // 触发动作
    userId: 'user_openid', // 用户ID
    data: {
      orderAmount: 150, // 订单金额
      orderId: 'order_123' // 订单ID
    }
  }
});
```

### 2. 支持的触发动作

| 动作名称 | 说明 | 适用条件 |
|---------|------|----------|
| `userRegister` | 用户注册 | 新用户注册 |
| `firstOrder` | 首次下单 | 首次下单 |
| `orderCompleted` | 订单完成 | 订单金额/数量达标 |
| `userLevelUp` | 用户升级 | 用户等级达标 |
| `activityParticipate` | 参与活动 | 参与活动 |
| `userReferral` | 推荐用户 | 推荐新用户 |
| `birthdayCheck` | 生日检查 | 生日当天 |
| `anniversaryCheck` | 周年检查 | 注册周年 |
| `customCheck` | 自定义检查 | 自定义条件 |

## ⚙️ 云函数部署

### 1. 自动发放云函数
```bash
cd cloudfunctions/autoIssueCoupon
npm install
# 在微信开发者工具中右键选择"上传并部署：云端安装依赖"
```

### 2. 定时检查云函数
```bash
cd cloudfunctions/scheduledCouponCheck
npm install
# 在微信开发者工具中右键选择"上传并部署：云端安装依赖"
```

### 3. 触发器配置
定时检查云函数配置了每日上午9点自动执行，用于检查生日和周年条件。

## 📊 数据监控

### 1. 发放记录
系统会在用户优惠券记录中记录:
- 触发动作 (`triggerAction`)
- 触发数据 (`triggerData`)
- 发放时间 (`issuedAt`)

### 2. 统计信息
可以通过以下方式统计优惠券发放情况:
- 按条件类型统计
- 按时间段统计
- 按用户群体统计

## ⚠️ 注意事项

### 1. 性能考虑
- 避免设置过于复杂的条件组合
- 合理设置定时检查频率
- 注意数据库查询性能

### 2. 数据一致性
- 确保用户数据完整性
- 避免重复发放同一优惠券
- 定期清理过期数据

### 3. 用户体验
- 条件设置要合理，避免过于苛刻
- 及时通知用户获得优惠券
- 提供优惠券使用说明

## 🔧 故障排除

### 1. 优惠券未自动发放
- 检查优惠券状态是否为"有效"
- 检查是否启用了自动发放
- 检查条件设置是否正确
- 查看云函数日志

### 2. 云函数调用失败
- 检查云函数是否正常部署
- 检查数据库权限配置
- 检查网络连接状态

### 3. 定时任务未执行
- 检查触发器配置是否正确
- 检查云函数是否正常运行
- 查看云函数执行日志

## 📞 技术支持

如有问题，请检查:
1. 云函数是否正常部署
2. 数据库权限是否正确配置
3. 条件规则设置是否合理
4. 云开发环境是否正常

---

*最后更新: 2024年12月* 