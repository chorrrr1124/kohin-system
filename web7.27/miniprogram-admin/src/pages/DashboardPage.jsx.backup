import React, { useState, useEffect } from 'react';
import {
  UsersIcon,
  ShoppingBagIcon,
  CreditCardIcon,
  CurrencyDollarIcon,
  ChartBarIcon,
  ExclamationTriangleIcon,
  BuildingStorefrontIcon,
  ChartPieIcon,
  ArrowTrendingUpIcon,
  EyeIcon,
  EyeSlashIcon
} from '@heroicons/react/24/outline';
import { useNavigate } from 'react-router-dom';
import { ContentLoading, CardLoading } from '../components/LoadingSpinner';
import { useResponsive } from '../utils/responsive';
import MobileCard, { MobileStatCard, MobileListItem } from '../components/MobileCard';
import MobileTable, { MobileStatusBadge, MobileTimeDisplay } from '../components/MobileTable';
import { isMobile } from '../utils/deviceDetection';
import { getDashboardStats, getRecentOrders, getLowStockProducts } from '../api/dashboardApi';

const DashboardPage = () => {
  const navigate = useNavigate();
  const { isMobile, isTablet } = useResponsive();
  const [loading, setLoading] = useState(true);
  const [showCharts, setShowCharts] = useState(true);
  const [stats, setStats] = useState({
    totalCustomers: 0,
    todayOrders: 0,
    todayPendingOrders: 0,
    todayCompletedOrders: 0,
    totalPrepaidRecords: 0,
    activePrepaidRecords: 0,
    totalPrepaidBalance: 0,
    todayRevenue: 0,
    totalRevenue: 0,
    lowStockProducts: 0,
    totalProducts: 0,
    customersByNature: {},
    ordersByStatus: {},
    recentStats: {
      last7Days: 0,
      last30Days: 0
    },
    dailyRevenue: [],
    monthlyOrders: []
  });
  const [recentOrders, setRecentOrders] = useState([]);
  const [lowStockProducts, setLowStockProducts] = useState([]);

  useEffect(() => {
    // 加载真实数据
    const loadData = async () => {
      setLoading(true);
      try {
        // 并行获取所有数据
        const [statsData, recentOrdersData, lowStockData] = await Promise.all([
          getDashboardStats(),
          getRecentOrders(5),
          getLowStockProducts(10)
        ]);
        
        setStats(statsData);
        setRecentOrders(recentOrdersData);
        setLowStockProducts(lowStockData);
        
      } catch (error) {
        console.error('加载数据失败:', error);
        // 如果API调用失败，显示错误信息但不阻塞界面
        setStats({
          totalCustomers: 0,
          todayOrders: 0,
          todayPendingOrders: 0,
          todayCompletedOrders: 0,
          totalPrepaidRecords: 0,
          activePrepaidRecords: 0,
          totalPrepaidBalance: 0,
          todayRevenue: 0,
          totalRevenue: 0,
          lowStockProducts: 0,
          totalProducts: 0,
          customersByNature: {},
          ordersByStatus: {},
          recentStats: {
            last7Days: 0,
            last30Days: 0
          },
          dailyRevenue: [],
          monthlyOrders: []
        });
        setRecentOrders([]);
        setLowStockProducts([]);
      } finally {
        setLoading(false);
      }
    };

    loadData();
  }, []);

  if (loading) {
    return <ContentLoading />;
  }

  return (
    <div className="space-y-6">
      {/* 页面标题 */}
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h1 className="text-2xl font-bold text-base-content">仪表板</h1>
          <p className="text-base-content/70 mt-1">欢迎回来，管理员</p>
        </div>
        <div className="flex items-center gap-2 mt-4 sm:mt-0">
          <button
            onClick={() => setShowCharts(!showCharts)}
            className="btn btn-outline btn-sm"
          >
            {showCharts ? <EyeSlashIcon className="w-4 h-4" /> : <EyeIcon className="w-4 h-4" />}
            {showCharts ? '隐藏图表' : '显示图表'}
          </button>
        </div>
      </div>

      {/* 统计卡片 */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        {/* 总客户数 */}
        <MobileStatCard
          title="总客户数"
          value={stats.totalCustomers.toLocaleString()}
          icon={<UsersIcon className="w-6 h-6" />}
          color="blue"
        />

        {/* 今日订单 */}
        <MobileStatCard
          title="今日订单"
          value={stats.todayOrders}
          subtitle={`待处理: ${stats.todayPendingOrders} | 已完成: ${stats.todayCompletedOrders}`}
          icon={<ShoppingBagIcon className="w-6 h-6" />}
          color="green"
        />

        {/* 今日收入 */}
        <MobileStatCard
          title="今日收入"
          value={`¥${stats.todayRevenue.toLocaleString()}`}
          subtitle={`总收入: ¥${stats.totalRevenue.toLocaleString()}`}
          icon={<CurrencyDollarIcon className="w-6 h-6" />}
          color="yellow"
        />

        {/* 库存预警 */}
        <MobileStatCard
          title="库存预警"
          value={stats.lowStockProducts}
          subtitle={`总商品: ${stats.totalProducts}`}
          icon={<ExclamationTriangleIcon className="w-6 h-6" />}
          color="red"
        />
      </div>

      {/* 最近订单 */}
      <MobileCard title="最近订单">
        {recentOrders.length === 0 ? (
          <div className="text-center py-8">
            <ShoppingBagIcon className="w-12 h-12 mx-auto text-gray-400 mb-2" />
            <p className="text-gray-500">暂无最近订单</p>
          </div>
        ) : (
          <MobileTable
            data={recentOrders}
            columns={[
              {
                key: 'id',
                title: '订单ID',
                render: (value) => value?.slice(-8) || '未知'
              },
              {
                key: 'customerName',
                title: '客户',
                render: (value) => value || '未知客户'
              },
              {
                key: 'amount',
                title: '金额',
                render: (value) => `¥${value || 0}`
              },
              {
                key: 'status',
                title: '状态',
                render: (value) => <MobileStatusBadge status={value} type="order" />
              },
              {
                key: 'createTime',
                title: '时间',
                render: (value) => <MobileTimeDisplay time={value} format="relative" />
              }
            ]}
          />
        )}
      </MobileCard>

      {/* 库存预警 */}
      {lowStockProducts.length > 0 && (
        <MobileCard title="库存预警" className="border-l-4 border-l-red-500">
          <MobileTable
            data={lowStockProducts}
            columns={[
              {
                key: 'name',
                title: '商品名称',
                render: (value) => value || '未知商品'
              },
              {
                key: 'stock',
                title: '当前库存',
                render: (value) => value || 0
              },
              {
                key: 'minStock',
                title: '最低库存',
                render: (value) => value || 0
              },
              {
                key: 'status',
                title: '状态',
                render: (value, row) => (
                  <MobileStatusBadge 
                    status="库存不足" 
                    type="inventory" 
                  />
                )
              }
            ]}
          />
        </MobileCard>
      )}
    </div>
  );
};

export default DashboardPage;
