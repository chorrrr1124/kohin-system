# 商城下单功能增强说明

## 功能概述

基于完成版小程序后台的实现，为Web管理后台的商城下单页面添加了完整的功能，包括：

1. **客户选择与管理**
2. **多种支付方式支持**
3. **预存功能集成**
4. **库存自动扣减**
5. **订单数据完整性**

## 新增功能详情

### 1. 客户选择功能
- **客户搜索**：支持按姓名或电话模糊搜索客户
- **客户信息自动填充**：选择客户后自动填充姓名、电话、地址
- **客户库集成**：从 `customers` 集合获取客户数据

### 2. 支付方式支持
- **现金支付**：传统现金交易
- **微信支付**：微信支付接口
- **支付宝**：支付宝支付接口
- **预存扣费**：使用客户预存余额支付
- **预存产品**：使用预存产品数量支付

### 3. 预存功能
- **预存记录查询**：自动查询客户的预存记录
- **预存余额显示**：显示可用预存余额
- **预存扣减**：支持预存余额和预存产品扣减
- **云函数集成**：通过 `updatePrepaidBalance` 云函数处理预存扣减

### 4. 订单数据增强
- **商品快照**：下单时保存商品关键信息，避免后续修改影响历史订单
- **完整字段**：包含 `id`、`status`、`paymentMethod`、`createTime`、`updateTime` 等
- **地址信息**：标准化的收货地址结构
- **预存信息**：记录预存扣减金额和产品

### 5. 库存管理
- **库存检查**：下单前检查商品库存是否充足
- **自动扣减**：下单成功后自动扣减商品库存
- **库存不足提示**：库存不足时阻止下单并提示

## 技术实现

### 前端组件
- **ShopOrderPage.jsx**：主要的下单页面组件
- **客户选择弹窗**：支持搜索和选择的客户选择器
- **支付方式选择**：多种支付方式的UI选择器
- **预存记录显示**：预存余额和产品的展示

### 云函数
- **updatePrepaidBalance**：处理预存余额扣减
- **事务处理**：确保预存扣减的原子性
- **错误处理**：完善的错误处理和回滚机制

### 数据库操作
- **orders集合**：存储订单信息
- **prepaidRecords集合**：存储预存记录
- **shopProducts集合**：商品库存管理
- **customers集合**：客户信息管理

## 使用流程

### 1. 商品选择
1. 浏览商品列表
2. 点击"加入购物车"添加商品
3. 在购物车中调整商品数量

### 2. 客户选择
1. 点击"选择客户"按钮
2. 搜索客户姓名或电话
3. 选择客户，自动填充信息

### 3. 支付设置
1. 选择支付方式
2. 如果选择预存支付，选择预存记录
3. 确认扣减金额

### 4. 提交订单
1. 填写收货地址和备注
2. 确认订单信息
3. 提交订单

## 数据流程

### 订单创建流程
```
1. 验证客户信息 → 2. 检查库存 → 3. 创建订单 → 4. 扣减库存 → 5. 扣减预存（如适用）
```

### 预存扣减流程
```
1. 查询预存记录 → 2. 验证余额充足 → 3. 开启事务 → 4. 扣减余额 → 5. 记录使用历史 → 6. 提交事务
```

## 注意事项

1. **库存检查**：下单前必须检查库存，避免超卖
2. **预存验证**：使用预存支付前必须验证余额充足
3. **事务处理**：预存扣减使用事务确保数据一致性
4. **错误处理**：完善的错误提示和回滚机制
5. **数据完整性**：订单数据包含完整的快照信息

## 部署说明

1. **云函数部署**：需要部署 `updatePrepaidBalance` 云函数
2. **数据库权限**：确保相关集合的读写权限正确
3. **前端构建**：使用 `npm run build` 构建前端代码
4. **静态托管**：将构建产物部署到云开发静态托管

## 后续优化

1. **预存产品扣减**：完善预存产品的扣减逻辑
2. **支付接口集成**：集成真实的微信支付和支付宝接口
3. **订单状态管理**：完善订单状态流转逻辑
4. **库存预警**：添加库存不足预警功能
5. **数据统计**：添加订单和预存的数据统计功能
