<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COSå›¾ç‰‡ä¸Šä¼ æµ‹è¯•</title>
    <script src="https://unpkg.com/cos-js-sdk-v5/dist/cos-js-sdk-v5.min.js"></script>
    <script src="https://unpkg.com/@cloudbase/js-sdk@latest/dist/index.umd.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .section h3 {
            margin-top: 0;
            color: #333;
        }
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background-color: #fafafa;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-area:hover {
            border-color: #007bff;
            background-color: #f0f8ff;
        }
        .upload-area.dragover {
            border-color: #007bff;
            background-color: #e6f3ff;
        }
        input[type="file"] {
            display: none;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .progress {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background-color: #007bff;
            width: 0%;
            transition: width 0.3s;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .success {
            color: #28a745;
        }
        .error {
            color: #dc3545;
        }
        .info {
            color: #17a2b8;
        }
        .image-preview {
            max-width: 200px;
            max-height: 200px;
            margin: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .category-select {
            margin: 10px 0;
        }
        .category-select select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª COSå›¾ç‰‡ä¸Šä¼ åŠŸèƒ½æµ‹è¯•</h1>
        
        <!-- ç¯å¢ƒé…ç½® -->
        <div class="section">
            <h3>ğŸ”§ ç¯å¢ƒé…ç½®</h3>
            <div>
                <label>ç¯å¢ƒID: </label>
                <input type="text" id="envId" placeholder="è¯·è¾“å…¥CloudBaseç¯å¢ƒID" style="width: 300px; padding: 5px;">
                <button onclick="initCloudBase()">åˆå§‹åŒ–ç¯å¢ƒ</button>
            </div>
            <div id="envStatus" style="margin-top: 10px;"></div>
        </div>

        <!-- ç™»å½•çŠ¶æ€ -->
        <div class="section">
            <h3>ğŸ” ç™»å½•çŠ¶æ€</h3>
            <div id="loginStatus">æœªç™»å½•</div>
            <button onclick="loginAnonymously()">åŒ¿åç™»å½•</button>
            <button onclick="checkLoginStatus()">æ£€æŸ¥ç™»å½•çŠ¶æ€</button>
        </div>

        <!-- äº‘å‡½æ•°æµ‹è¯• -->
        <div class="section">
            <h3>â˜ï¸ äº‘å‡½æ•°æµ‹è¯•</h3>
            <button onclick="testGetCosSts()">æµ‹è¯•è·å–COSä¸´æ—¶å¯†é’¥</button>
            <div id="cosStsResult" style="margin-top: 10px;"></div>
        </div>

        <!-- å›¾ç‰‡ä¸Šä¼  -->
        <div class="section">
            <h3>ğŸ“¸ å›¾ç‰‡ä¸Šä¼ æµ‹è¯•</h3>
            <div class="category-select">
                <label>é€‰æ‹©åˆ†ç±»: </label>
                <select id="categorySelect">
                    <option value="general">é€šç”¨å›¾ç‰‡</option>
                    <option value="banner">è½®æ’­å›¾</option>
                    <option value="banners">æ¨å¹¿å›¾</option>
                    <option value="category">åˆ†ç±»å›¾æ ‡</option>
                    <option value="products">å•†å“å›¾ç‰‡</option>
                    <option value="icons">å›¾æ ‡</option>
                    <option value="tab">æ ‡ç­¾æ </option>
                </select>
            </div>
            
            <div class="upload-area" onclick="document.getElementById('fileInput').click()" 
                 ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                <p>ï¿½ï¿½ ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</p>
                <p style="color: #666; font-size: 14px;">æ”¯æŒ JPGã€PNGã€GIF æ ¼å¼ï¼Œæœ€å¤§ 10MB</p>
            </div>
            <input type="file" id="fileInput" accept="image/*" multiple onchange="handleFileSelect(event)">
            
            <div class="progress" id="progressContainer" style="display: none;">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            
            <button onclick="uploadSelectedFiles()" id="uploadBtn" disabled>å¼€å§‹ä¸Šä¼ </button>
            <button onclick="clearFiles()">æ¸…ç©ºæ–‡ä»¶</button>
            
            <div id="fileList" style="margin-top: 15px;"></div>
        </div>

        <!-- ä¸Šä¼ ç»“æœ -->
        <div class="section">
            <h3>ğŸ“‹ ä¸Šä¼ ç»“æœ</h3>
            <div id="uploadResults"></div>
        </div>

        <!-- æ—¥å¿— -->
        <div class="section">
            <h3>ğŸ“ æ“ä½œæ—¥å¿—</h3>
            <div class="log" id="logContainer"></div>
            <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
    </div>

    <script>
        let app = null;
        let selectedFiles = [];
        let cosClient = null;

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog() {
            document.getElementById('logContainer').innerHTML = '';
        }

        // åˆå§‹åŒ–CloudBase
        async function initCloudBase() {
            const envId = document.getElementById('envId').value.trim();
            if (!envId) {
                log('è¯·è¾“å…¥ç¯å¢ƒID', 'error');
                return;
            }

            try {
                log('æ­£åœ¨åˆå§‹åŒ–CloudBase...', 'info');
                app = cloudbase.init({
                    env: envId
                });
                
                document.getElementById('envStatus').innerHTML = 
                    `<span class="success">âœ… ç¯å¢ƒåˆå§‹åŒ–æˆåŠŸ (${envId})</span>`;
                log(`ç¯å¢ƒåˆå§‹åŒ–æˆåŠŸ: ${envId}`, 'success');
            } catch (error) {
                log(`ç¯å¢ƒåˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                document.getElementById('envStatus').innerHTML = 
                    `<span class="error">âŒ ç¯å¢ƒåˆå§‹åŒ–å¤±è´¥</span>`;
            }
        }

        // åŒ¿åç™»å½•
        async function loginAnonymously() {
            if (!app) {
                log('è¯·å…ˆåˆå§‹åŒ–ç¯å¢ƒ', 'error');
                return;
            }

            try {
                log('æ­£åœ¨æ‰§è¡ŒåŒ¿åç™»å½•...', 'info');
                const auth = app.auth();
                await auth.signInAnonymously();
                
                const loginState = await auth.getLoginState();
                if (loginState && loginState.isLoggedIn) {
                    document.getElementById('loginStatus').innerHTML = 
                        `<span class="success">âœ… åŒ¿åç™»å½•æˆåŠŸ</span>`;
                    log('åŒ¿åç™»å½•æˆåŠŸ', 'success');
                } else {
                    throw new Error('ç™»å½•çŠ¶æ€å¼‚å¸¸');
                }
            } catch (error) {
                log(`åŒ¿åç™»å½•å¤±è´¥: ${error.message}`, 'error');
                document.getElementById('loginStatus').innerHTML = 
                    `<span class="error">âŒ ç™»å½•å¤±è´¥</span>`;
            }
        }

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        async function checkLoginStatus() {
            if (!app) {
                log('è¯·å…ˆåˆå§‹åŒ–ç¯å¢ƒ', 'error');
                return;
            }

            try {
                const auth = app.auth();
                const loginState = await auth.getLoginState();
                
                if (loginState && loginState.isLoggedIn) {
                    document.getElementById('loginStatus').innerHTML = 
                        `<span class="success">âœ… å·²ç™»å½• (${loginState.user?.uid || 'åŒ¿åç”¨æˆ·'})</span>`;
                    log('ç™»å½•çŠ¶æ€æ£€æŸ¥: å·²ç™»å½•', 'success');
                } else {
                    document.getElementById('loginStatus').innerHTML = 
                        `<span class="error">âŒ æœªç™»å½•</span>`;
                    log('ç™»å½•çŠ¶æ€æ£€æŸ¥: æœªç™»å½•', 'info');
                }
            } catch (error) {
                log(`æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•è·å–COSä¸´æ—¶å¯†é’¥
        async function testGetCosSts() {
            if (!app) {
                log('è¯·å…ˆåˆå§‹åŒ–ç¯å¢ƒ', 'error');
                return;
            }

            try {
                log('æ­£åœ¨è°ƒç”¨getCosStsäº‘å‡½æ•°...', 'info');
                
                const result = await app.callFunction({
                    name: 'getCosSts',
                    data: {
                        prefix: 'images/'
                    }
                });

                log('äº‘å‡½æ•°è°ƒç”¨ç»“æœ: ' + JSON.stringify(result, null, 2), 'info');
                
                if (result.result && result.result.success) {
                    const credentials = result.result.data.credentials;
                    document.getElementById('cosStsResult').innerHTML = 
                        `<div class="success">
                            âœ… è·å–ä¸´æ—¶å¯†é’¥æˆåŠŸ<br>
                            tmpSecretId: ${credentials.tmpSecretId ? 'å·²è·å–' : 'ç¼ºå¤±'}<br>
                            tmpSecretKey: ${credentials.tmpSecretKey ? 'å·²è·å–' : 'ç¼ºå¤±'}<br>
                            sessionToken: ${credentials.sessionToken ? 'å·²è·å–' : 'ç¼ºå¤±'}
                        </div>`;
                    log('è·å–COSä¸´æ—¶å¯†é’¥æˆåŠŸ', 'success');
                } else {
                    throw new Error(result.result?.error || 'äº‘å‡½æ•°è¿”å›å¤±è´¥');
                }
            } catch (error) {
                log(`è·å–COSä¸´æ—¶å¯†é’¥å¤±è´¥: ${error.message}`, 'error');
                document.getElementById('cosStsResult').innerHTML = 
                    `<div class="error">âŒ è·å–ä¸´æ—¶å¯†é’¥å¤±è´¥: ${error.message}</div>`;
            }
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            selectedFiles = files;
            displaySelectedFiles();
            log(`é€‰æ‹©äº† ${files.length} ä¸ªæ–‡ä»¶`, 'info');
        }

        // å¤„ç†æ‹–æ‹½
        function handleDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            
            const files = Array.from(event.dataTransfer.files).filter(file => 
                file.type.startsWith('image/')
            );
            selectedFiles = files;
            displaySelectedFiles();
            log(`æ‹–æ‹½é€‰æ‹©äº† ${files.length} ä¸ªå›¾ç‰‡æ–‡ä»¶`, 'info');
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
        }

        // æ˜¾ç¤ºé€‰ä¸­çš„æ–‡ä»¶
        function displaySelectedFiles() {
            const fileList = document.getElementById('fileList');
            const uploadBtn = document.getElementById('uploadBtn');
            
            if (selectedFiles.length === 0) {
                fileList.innerHTML = '';
                uploadBtn.disabled = true;
                return;
            }

            let html = '<h4>é€‰ä¸­çš„æ–‡ä»¶:</h4>';
            selectedFiles.forEach((file, index) => {
                html += `
                    <div style="display: flex; align-items: center; margin: 5px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <img src="${URL.createObjectURL(file)}" style="width: 50px; height: 50px; object-fit: cover; margin-right: 10px; border-radius: 3px;">
                        <div>
                            <div><strong>${file.name}</strong></div>
                            <div style="color: #666; font-size: 12px;">
                                å¤§å°: ${(file.size / 1024).toFixed(1)}KB | 
                                ç±»å‹: ${file.type}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            fileList.innerHTML = html;
            uploadBtn.disabled = false;
        }

        // æ¸…ç©ºæ–‡ä»¶
        function clearFiles() {
            selectedFiles = [];
            document.getElementById('fileInput').value = '';
            displaySelectedFiles();
            document.getElementById('uploadResults').innerHTML = '';
            log('å·²æ¸…ç©ºæ–‡ä»¶é€‰æ‹©', 'info');
        }

        // ä¸Šä¼ æ–‡ä»¶
        async function uploadSelectedFiles() {
            if (!app) {
                log('è¯·å…ˆåˆå§‹åŒ–ç¯å¢ƒ', 'error');
                return;
            }

            if (selectedFiles.length === 0) {
                log('è¯·å…ˆé€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶', 'error');
                return;
            }

            const category = document.getElementById('categorySelect').value;
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const uploadBtn = document.getElementById('uploadBtn');
            const uploadResults = document.getElementById('uploadResults');

            try {
                log(`å¼€å§‹ä¸Šä¼  ${selectedFiles.length} ä¸ªæ–‡ä»¶åˆ°åˆ†ç±»: ${category}`, 'info');
                
                uploadBtn.disabled = true;
                progressContainer.style.display = 'block';
                uploadResults.innerHTML = '';

                // è·å–COSä¸´æ—¶å¯†é’¥
                log('æ­£åœ¨è·å–COSä¸´æ—¶å¯†é’¥...', 'info');
                const stsResult = await app.callFunction({
                    name: 'getCosSts',
                    data: { prefix: 'images/' }
                });

                if (!stsResult.result?.success) {
                    throw new Error(stsResult.result?.error || 'è·å–ä¸´æ—¶å¯†é’¥å¤±è´¥');
                }

                const credentials = stsResult.result.data.credentials;
                log('COSä¸´æ—¶å¯†é’¥è·å–æˆåŠŸ', 'success');

                // åˆ›å»ºCOSå®¢æˆ·ç«¯
                cosClient = new COS({
                    getAuthorization: function(options, callback) {
                        callback({
                            TmpSecretId: credentials.tmpSecretId,
                            TmpSecretKey: credentials.tmpSecretKey,
                            SecurityToken: credentials.sessionToken,
                            StartTime: stsResult.result.data.startTime,
                            ExpiredTime: stsResult.result.data.expiredTime
                        });
                    }
                });

                // ä¸Šä¼ æ–‡ä»¶
                const results = [];
                for (let i = 0; i < selectedFiles.length; i++) {
                    const file = selectedFiles[i];
                    const progress = ((i + 1) / selectedFiles.length) * 100;
                    progressBar.style.width = progress + '%';
                    
                    log(`æ­£åœ¨ä¸Šä¼ æ–‡ä»¶ ${i + 1}/${selectedFiles.length}: ${file.name}`, 'info');
                    
                    const result = await uploadSingleFile(file, category);
                    results.push(result);
                    
                    log(`æ–‡ä»¶ä¸Šä¼ å®Œæˆ: ${file.name}`, 'success');
                }

                // æ˜¾ç¤ºä¸Šä¼ ç»“æœ
                displayUploadResults(results);
                log(`æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ å®Œæˆï¼Œå…± ${results.length} ä¸ªæ–‡ä»¶`, 'success');

            } catch (error) {
                log(`ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
                uploadResults.innerHTML = `<div class="error">âŒ ä¸Šä¼ å¤±è´¥: ${error.message}</div>`;
            } finally {
                uploadBtn.disabled = false;
                progressContainer.style.display = 'none';
                progressBar.style.width = '0%';
            }
        }

        // ä¸Šä¼ å•ä¸ªæ–‡ä»¶
        function uploadSingleFile(file, category) {
            return new Promise((resolve, reject) => {
                const timestamp = Date.now();
                const randomStr = Math.random().toString(36).substring(2, 8);
                const fileExtension = file.name.split('.').pop();
                const fileName = `${timestamp}_${randomStr}.${fileExtension}`;
                
                const categoryPath = {
                    'banner': 'images/banner/',
                    'banners': 'images/banners/',
                    'category': 'images/category/',
                    'products': 'images/products/',
                    'icons': 'images/icons/',
                    'tab': 'images/tab/',
                    'general': 'images/general/'
                };

                const uploadPath = categoryPath[category] || 'images/general/';
                const key = `${uploadPath}${fileName}`;

                cosClient.putObject({
                    Bucket: 'kohin-1327524326',
                    Region: 'ap-guangzhou',
                    Key: key,
                    Body: file,
                    Headers: {
                        'Cache-Control': 'max-age=31536000'
                    }
                }, (err, data) => {
                    if (err) {
                        reject(err);
                    } else {
                        const imageUrl = `https://kohin-1327524326.cos.ap-guangzhou.myqcloud.com/${key}`;
                        resolve({
                            fileName: file.name,
                            cosKey: key,
                            cosUrl: imageUrl,
                            size: file.size,
                            type: file.type
                        });
                    }
                });
            });
        }

        // æ˜¾ç¤ºä¸Šä¼ ç»“æœ
        function displayUploadResults(results) {
            const uploadResults = document.getElementById('uploadResults');
            let html = '<h4>ä¸Šä¼ ç»“æœ:</h4>';
            
            results.forEach((result, index) => {
                html += `
                    <div style="border: 1px solid #ddd; border-radius: 5px; padding: 15px; margin: 10px 0;">
                        <div class="success">âœ… æ–‡ä»¶ ${index + 1}: ${result.fileName}</div>
                        <div style="margin: 5px 0;">
                            <strong>æ–‡ä»¶å:</strong> ${result.fileName}<br>
                            <strong>å¤§å°:</strong> ${(result.size / 1024).toFixed(1)}KB<br>
                            <strong>ç±»å‹:</strong> ${result.type}<br>
                            <strong>COSè·¯å¾„:</strong> ${result.cosKey}<br>
                            <strong>è®¿é—®URL:</strong> <a href="${result.cosUrl}" target="_blank">${result.cosUrl}</a>
                        </div>
                        <img src="${result.cosUrl}" class="image-preview" alt="ä¸Šä¼ çš„å›¾ç‰‡">
                    </div>
                `;
            });
            
            uploadResults.innerHTML = html;
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('COSå›¾ç‰‡ä¸Šä¼ æµ‹è¯•é¡µé¢å·²åŠ è½½', 'info');
            log('è¯·å…ˆè¾“å…¥ç¯å¢ƒIDå¹¶åˆå§‹åŒ–ç¯å¢ƒ', 'info');
        });
    </script>
</body>
</html>
