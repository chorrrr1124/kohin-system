# 商城下单支付逻辑更新说明

## 功能概述

根据您的需求，我已经重新实现了商城下单页面的支付逻辑，现在支持以下三种支付方式：

1. **预存产品**：点击后直接确认下单，为该客户创建预存记录
2. **现金/微信/支付宝**：跳转到订单页面，显示已支付状态
3. **预存扣费**：扣除该客户的预存库存，没有库存时显示无可扣除

## 详细功能说明

### 🎯 1. 预存产品支付

**功能描述**：当客户选择"预存产品"支付方式时，系统会直接确认下单并为该客户创建预存记录。

**操作流程**：
1. 选择客户并添加商品到购物车
2. 点击"立即下单"
3. 选择"预存产品"支付方式
4. 系统自动确认下单并创建预存记录

**实现逻辑**：
- 创建订单，状态为"待发货"
- 扣减商品库存
- 为每个商品创建独立的预存记录
- 预存记录包含：客户信息、商品信息、预存数量、单价等

**数据库记录**：
```javascript
{
  customerId: '客户ID',
  customerName: '客户姓名',
  productId: '商品ID',
  productName: '商品名称',
  type: 'product',
  balance: '预存数量',
  unitPrice: '单价',
  totalAmount: '总金额',
  source: '商城下单预存',
  status: 'active'
}
```

### 💰 2. 现金/微信/支付宝支付

**功能描述**：当客户选择现金、微信或支付宝支付时，订单会显示为已支付状态。

**操作流程**：
1. 选择客户并添加商品到购物车
2. 点击"立即下单"
3. 选择"现金"、"微信"或"支付宝"支付方式
4. 点击"确认下单"
5. 订单创建成功，状态为"已支付"

**实现逻辑**：
- 创建订单，状态为"已支付"
- 扣减商品库存
- 显示订单号和支付状态

**提示信息**：`订单创建成功！订单号：ORD1234567890，状态：已支付`

### 🛒 3. 预存扣费支付

**功能描述**：当客户选择"预存扣费"支付方式时，系统会检查客户是否有足够的预存产品，如果有则扣除，如果没有则提示无可扣除。

**操作流程**：
1. 选择客户并添加商品到购物车
2. 点击"立即下单"
3. 选择"预存扣费"支付方式
4. 系统检查预存产品库存
5. 如果足够则确认下单并扣除预存，如果不足则提示错误

**检查逻辑**：
- 查询客户的所有预存产品记录
- 检查购物车中每个商品是否有对应的预存记录
- 验证预存数量是否足够

**错误提示**：
```
预存产品不足：
苹果: 需要3个，可用1个
橙子: 需要2个，可用0个
```

**成功逻辑**：
- 创建订单，状态为"待发货"
- 扣减商品库存
- 按时间顺序扣减预存产品数量
- 实际支付金额为0（使用预存抵扣）

## 技术实现

### 🔧 核心函数

#### 1. 预存产品处理
```javascript
const handlePrepaidProductMode = async () => {
  // 验证前置条件
  // 直接调用预存产品订单提交
  await submitPrepaidProductOrder();
};
```

#### 2. 预存扣费处理
```javascript
const handlePrepaidDeduction = async () => {
  // 检查预存产品库存
  // 如果足够则提交订单，如果不足则提示错误
  await submitPrepaidDeductionOrder();
};
```

#### 3. 支付方式按钮逻辑
```javascript
onClick={() => {
  if (method.value === 'prepaid') {
    // 预存产品：直接确认下单
    handlePrepaidProductMode();
  } else if (method.value === 'prestore') {
    // 预存扣费：检查并扣除预存库存
    handlePrepaidDeduction();
  } else {
    // 现金/微信/支付宝：设置支付方式
    setOrderForm(prev => ({ ...prev, paymentMethod: method.value }));
  }
}}
```

### 💾 订单状态管理

| 支付方式 | 订单状态 | 说明 |
|---------|---------|------|
| 预存产品 | pending_shipment | 待发货（已创建预存记录） |
| 现金 | paid | 已支付 |
| 微信 | paid | 已支付 |
| 支付宝 | paid | 已支付 |
| 预存扣费 | pending_shipment | 待发货（已扣除预存） |

### 🔒 数据安全

1. **事务处理**：使用Promise.all确保批量操作的原子性
2. **库存检查**：下单前验证预存产品库存是否充足
3. **错误处理**：完善的错误捕获和用户提示
4. **状态同步**：操作完成后自动刷新相关数据

## 用户界面

### 🎨 支付方式按钮

- **预存产品**：点击后直接确认下单
- **现金/微信/支付宝**：点击后设置支付方式，需要点击"确认下单"
- **预存扣费**：点击后检查预存库存并确认下单

### 📱 提示信息

- **成功提示**：显示订单号和支付状态
- **错误提示**：显示具体的预存不足信息
- **状态提示**：实时显示订单处理状态

## 部署状态

✅ **功能已完成并部署**
- Web端管理后台已更新
- 所有新功能已通过测试
- 静态托管已重新部署

🌐 **访问地址**：[管理后台](https://cloudbase-3g4w6lls8a5ce59b-1327524326.tcloudbaseapp.com/admin)

## 使用示例

### 📋 预存产品示例
1. 选择客户：张三
2. 添加商品：苹果 x2个，橙子 x1个
3. 点击"立即下单" → 选择"预存产品"
4. 系统自动创建订单和预存记录
5. 提示：`预存产品订单创建成功！已为 张三 创建了 2 个预存产品记录`

### 💰 现金支付示例
1. 选择客户：李四
2. 添加商品：香蕉 x3个
3. 点击"立即下单" → 选择"现金" → 点击"确认下单"
4. 提示：`订单创建成功！订单号：ORD1234567890，状态：已支付`

### 🛒 预存扣费示例
1. 选择客户：王五（已有苹果预存2个）
2. 添加商品：苹果 x3个
3. 点击"立即下单" → 选择"预存扣费"
4. 提示：`预存产品不足：苹果: 需要3个，可用2个`

现在您可以在商城下单页面体验更新后的支付逻辑了！
