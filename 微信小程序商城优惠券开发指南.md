# 微信小程序商城优惠券开发指南

## 目录

1. [概述](#概述)
2. [优惠券数据模型](#优惠券数据模型)
3. [开发步骤](#开发步骤)
   - [3.1 创建数据库集合](#31-创建数据库集合)
   - [3.2 开发云函数](#32-开发云函数)
   - [3.3 开发小程序前端页面](#33-开发小程序前端页面)
4. [优惠券应用流程](#优惠券应用流程)
   - [4.1 优惠券发放](#41-优惠券发放)
   - [4.2 优惠券领取](#42-优惠券领取)
   - [4.3 优惠券使用](#43-优惠券使用)
   - [4.4 优惠券核销](#44-优惠券核销)
5. [部署指南](#部署指南)
   - [5.1 云函数部署](#51-云函数部署)
   - [5.2 小程序前端部署](#52-小程序前端部署)
6. [常见问题与解决方案](#常见问题与解决方案)
7. [优化建议](#优化建议)

## 概述

优惠券是电商小程序中常见的营销工具，可以有效促进用户消费和提高用户粘性。本文档详细介绍了在微信小程序商城中如何开发和应用优惠券功能，包括数据模型设计、开发步骤、应用流程和部署指南。

## 优惠券数据模型

### 优惠券主表 (mall_coupons)

| 字段名 | 类型 | 必填 | 默认值 | 描述 | 索引 |
|--------|------|------|--------|------|------|
| _id | ObjectId | 是 | 自动生成 | 主键 | 主键 |
| code | String | 是 | 自动生成 | 优惠券码 | 唯一索引 |
| name | String | 是 | - | 优惠券名称 | - |
| description | String | 否 | "" | 描述 | - |
| type | String | 是 | - | 类型(fixed/percent) | 普通索引 |
| value | Number | 是 | 0 | 优惠值 | - |
| minAmount | Number | 否 | 0 | 最低消费金额 | - |
| maxDiscount | Number | 否 | 0 | 最大优惠金额 | - |
| totalCount | Number | 是 | 0 | 总发放数量 | - |
| usedCount | Number | 否 | 0 | 已使用数量 | - |
| remainingCount | Number | 否 | 0 | 剩余数量 | - |
| userLimit | Number | 否 | 1 | 每用户限领数量 | - |
| applicableProducts | Array | 否 | [] | 适用商品 | - |
| applicableCategories | Array | 否 | [] | 适用分类 | - |
| excludeProducts | Array | 否 | [] | 排除商品 | - |
| startTime | Date | 是 | - | 开始时间 | 普通索引 |
| endTime | Date | 是 | - | 结束时间 | 普通索引 |
| validDays | Number | 否 | 0 | 有效天数(0=按时间) | - |
| status | String | 否 | "active" | 状态 | 普通索引 |
| createBy | String | 是 | - | 创建人 | - |
| createTime | Date | 是 | 当前时间 | 创建时间 | 普通索引 |
| updateTime | Date | 是 | 当前时间 | 更新时间 | - |

### 用户优惠券表 (user_coupons)

| 字段名 | 类型 | 必填 | 默认值 | 描述 | 索引 |
|--------|------|------|--------|------|------|
| _id | ObjectId | 是 | 自动生成 | 主键 | 主键 |
| _openid | String | 是 | - | 用户openid | 普通索引 |
| couponId | String | 是 | - | 优惠券ID | 普通索引 |
| code | String | 是 | - | 优惠券码 | 普通索引 |
| status | String | 是 | "unused" | 状态(unused/used/expired) | 普通索引 |
| receiveTime | Date | 是 | 当前时间 | 领取时间 | 普通索引 |
| useTime | Date | 否 | null | 使用时间 | - |
| orderId | String | 否 | "" | 使用的订单ID | - |
| expireTime | Date | 是 | - | 过期时间 | 普通索引 |

## 开发步骤

### 3.1 创建数据库集合

1. **创建优惠券主表**

   在微信云开发控制台中创建 `mall_coupons` 集合，用于存储优惠券基本信息。

   ```javascript
   // 示例：创建优惠券
   const db = wx.cloud.database()
   db.collection('mall_coupons').add({
     data: {
       code: 'SUMMER2023',
       name: '夏季特惠券',
       description: '夏季促销活动优惠券',
       type: 'fixed',  // fixed: 固定金额, percent: 折扣比例
       value: 10,      // 10元 或 90%
       minAmount: 100, // 最低消费金额
       maxDiscount: 0, // 最大优惠金额，0表示无限制
       totalCount: 1000,
       usedCount: 0,
       remainingCount: 1000,
       userLimit: 1,   // 每用户限领1张
       applicableProducts: [],  // 空数组表示全部商品
       applicableCategories: [], // 空数组表示全部分类
       excludeProducts: [],     // 排除的商品
       startTime: new Date('2023-06-01'),
       endTime: new Date('2023-08-31'),
       validDays: 0,   // 0表示按startTime和endTime计算有效期
       status: 'active',
       createBy: 'admin',
       createTime: db.serverDate(),
       updateTime: db.serverDate()
     }
   })
   ```

2. **创建用户优惠券表**

   创建 `user_coupons` 集合，用于存储用户领取的优惠券信息。

   ```javascript
   // 示例：用户领取优惠券
   const db = wx.cloud.database()
   db.collection('user_coupons').add({
     data: {
       _openid: 'user_openid', // 自动关联当前用户
       couponId: 'coupon_id',
       code: 'SUMMER2023',
       status: 'unused',  // unused: 未使用, used: 已使用, expired: 已过期
       receiveTime: db.serverDate(),
       useTime: null,
       orderId: '',
       expireTime: new Date('2023-08-31')
     }
   })
   ```

### 3.2 开发云函数

1. **获取可用优惠券云函数**

   创建 `getActiveCoupons` 云函数，用于获取当前可领取的优惠券。

   ```javascript
   // cloudfunctions/getActiveCoupons/index.js
   const cloud = require('wx-server-sdk')
   
   cloud.init({
     env: cloud.DYNAMIC_CURRENT_ENV
   })
   
   const db = cloud.database()
   
   exports.main = async (event, context) => {
     try {
       const { limit = 10, status = 'active' } = event
       const now = new Date()
       
       // 从优惠券集合获取有效的优惠券
       const result = await db.collection('mall_coupons')
         .where({
           status: status,
           startTime: db.command.lte(now),
           endTime: db.command.gte(now),
           totalCount: db.command.gt(0) // 还有库存
         })
         .orderBy('createTime', 'desc')
         .limit(limit)
         .get()
   
       return {
         success: true,
         data: result.data || [],
         message: '获取优惠券成功'
       }
     } catch (error) {
       console.error('获取优惠券失败:', error)
       return {
         success: false,
         data: [],
         message: '获取优惠券失败'
       }
     }
   }
   ```

2. **领取优惠券云函数**

   创建 `receiveCoupon` 云函数，用于用户领取优惠券。

   ```javascript
   // cloudfunctions/receiveCoupon/index.js
   const cloud = require('wx-server-sdk')
   
   cloud.init({
     env: cloud.DYNAMIC_CURRENT_ENV
   })
   
   const db = cloud.database()
   
   exports.main = async (event, context) => {
     const wxContext = cloud.getWXContext()
     const openid = wxContext.OPENID
     const { couponId } = event
     
     if (!openid || !couponId) {
       return {
         success: false,
         message: '参数错误'
       }
     }
     
     try {
       // 开启事务
       const transaction = await db.startTransaction()
       
       // 1. 查询优惠券信息
       const couponRes = await transaction.collection('mall_coupons').doc(couponId).get()
       const coupon = couponRes.data
       
       if (!coupon) {
         await transaction.rollback()
         return {
           success: false,
           message: '优惠券不存在'
         }
       }
       
       // 2. 检查优惠券是否有效
       const now = new Date()
       if (coupon.status !== 'active' || 
           coupon.startTime > now || 
           coupon.endTime < now || 
           coupon.remainingCount <= 0) {
         await transaction.rollback()
         return {
           success: false,
           message: '优惠券已失效或已领完'
         }
       }
       
       // 3. 检查用户是否已领取过该优惠券
       const userCouponRes = await transaction.collection('user_coupons')
         .where({
           _openid: openid,
           couponId: couponId
         })
         .count()
       
       if (userCouponRes.total >= coupon.userLimit) {
         await transaction.rollback()
         return {
           success: false,
           message: `每位用户限领${coupon.userLimit}张`
         }
       }
       
       // 4. 更新优惠券库存
       await transaction.collection('mall_coupons').doc(couponId).update({
         data: {
           remainingCount: db.command.inc(-1),
           updateTime: db.serverDate()
         }
       })
       
       // 5. 添加用户优惠券记录
       const expireTime = coupon.validDays > 0 
         ? new Date(now.getTime() + coupon.validDays * 24 * 60 * 60 * 1000) 
         : new Date(coupon.endTime)
       
       await transaction.collection('user_coupons').add({
         data: {
           _openid: openid,
           couponId: couponId,
           code: coupon.code,
           status: 'unused',
           receiveTime: db.serverDate(),
           useTime: null,
           orderId: '',
           expireTime: expireTime
         }
       })
       
       // 6. 提交事务
       await transaction.commit()
       
       return {
         success: true,
         message: '领取成功'
       }
     } catch (error) {
       console.error('领取优惠券失败:', error)
       return {
         success: false,
         message: '领取失败，请稍后再试'
       }
     }
   }
   ```

3. **获取用户优惠券云函数**

   创建 `getUserCoupons` 云函数，用于获取用户已领取的优惠券。

   ```javascript
   // cloudfunctions/getUserCoupons/index.js
   const cloud = require('wx-server-sdk')
   
   cloud.init({
     env: cloud.DYNAMIC_CURRENT_ENV
   })
   
   const db = cloud.database()
   
   exports.main = async (event, context) => {
     const wxContext = cloud.getWXContext()
     const openid = wxContext.OPENID
     const { status = 'unused' } = event
     
     if (!openid) {
       return {
         success: false,
         message: '未登录'
       }
     }
     
     try {
       // 获取用户优惠券
       const userCouponsRes = await db.collection('user_coupons')
         .where({
           _openid: openid,
           status: status
         })
         .orderBy('expireTime', 'asc')
         .get()
       
       const userCoupons = userCouponsRes.data
       
       // 如果没有优惠券，直接返回
       if (userCoupons.length === 0) {
         return {
           success: true,
           data: [],
           message: '获取成功'
         }
       }
       
       // 获取优惠券详情
       const couponIds = userCoupons.map(item => item.couponId)
       const couponsRes = await db.collection('mall_coupons')
         .where({
           _id: db.command.in(couponIds)
         })
         .get()
       
       const couponsMap = {}
       couponsRes.data.forEach(coupon => {
         couponsMap[coupon._id] = coupon
       })
       
       // 合并优惠券信息
       const result = userCoupons.map(userCoupon => {
         const couponInfo = couponsMap[userCoupon.couponId] || {}
         return {
           ...userCoupon,
           name: couponInfo.name || '',
           description: couponInfo.description || '',
           type: couponInfo.type || '',
           value: couponInfo.value || 0,
           minAmount: couponInfo.minAmount || 0,
           maxDiscount: couponInfo.maxDiscount || 0
         }
       })
       
       return {
         success: true,
         data: result,
         message: '获取成功'
       }
     } catch (error) {
       console.error('获取用户优惠券失败:', error)
       return {
         success: false,
         data: [],
         message: '获取失败'
       }
     }
   }
   ```

4. **使用优惠券云函数**

   创建 `useCoupon` 云函数，用于在下单时使用优惠券。

   ```javascript
   // cloudfunctions/useCoupon/index.js
   const cloud = require('wx-server-sdk')
   
   cloud.init({
     env: cloud.DYNAMIC_CURRENT_ENV
   })
   
   const db = cloud.database()
   
   exports.main = async (event, context) => {
     const wxContext = cloud.getWXContext()
     const openid = wxContext.OPENID
     const { userCouponId, orderId, orderAmount } = event
     
     if (!openid || !userCouponId || !orderId || orderAmount === undefined) {
       return {
         success: false,
         message: '参数错误'
       }
     }
     
     try {
       // 开启事务
       const transaction = await db.startTransaction()
       
       // 1. 查询用户优惠券
       const userCouponRes = await transaction.collection('user_coupons').doc(userCouponId).get()
       const userCoupon = userCouponRes.data
       
       if (!userCoupon || userCoupon._openid !== openid) {
         await transaction.rollback()
         return {
           success: false,
           message: '优惠券不存在或不属于当前用户'
         }
       }
       
       // 2. 检查优惠券状态
       if (userCoupon.status !== 'unused') {
         await transaction.rollback()
         return {
           success: false,
           message: '优惠券已使用或已过期'
         }
       }
       
       // 3. 检查优惠券是否过期
       const now = new Date()
       if (userCoupon.expireTime < now) {
         // 更新优惠券状态为已过期
         await transaction.collection('user_coupons').doc(userCouponId).update({
           data: {
             status: 'expired'
           }
         })
         
         await transaction.commit()
         return {
           success: false,
           message: '优惠券已过期'
         }
       }
       
       // 4. 查询优惠券详情
       const couponRes = await transaction.collection('mall_coupons').doc(userCoupon.couponId).get()
       const coupon = couponRes.data
       
       if (!coupon) {
         await transaction.rollback()
         return {
           success: false,
           message: '优惠券信息不存在'
         }
       }
       
       // 5. 检查订单金额是否满足优惠券使用条件
       if (orderAmount < coupon.minAmount) {
         await transaction.rollback()
         return {
           success: false,
           message: `订单金额不满足优惠券使用条件，最低消费${coupon.minAmount}元`
         }
       }
       
       // 6. 计算优惠金额
       let discountAmount = 0
       if (coupon.type === 'fixed') {
         // 固定金额
         discountAmount = coupon.value
       } else if (coupon.type === 'percent') {
         // 折扣比例
         discountAmount = orderAmount * (1 - coupon.value / 100)
         // 检查最大优惠金额限制
         if (coupon.maxDiscount > 0 && discountAmount > coupon.maxDiscount) {
           discountAmount = coupon.maxDiscount
         }
       }
       
       // 7. 更新用户优惠券状态
       await transaction.collection('user_coupons').doc(userCouponId).update({
         data: {
           status: 'used',
           useTime: db.serverDate(),
           orderId: orderId
         }
       })
       
       // 8. 更新优惠券使用数量
       await transaction.collection('mall_coupons').doc(userCoupon.couponId).update({
         data: {
           usedCount: db.command.inc(1),
           updateTime: db.serverDate()
         }
       })
       
       // 9. 提交事务
       await transaction.commit()
       
       return {
         success: true,
         discountAmount: discountAmount,
         message: '优惠券使用成功'
       }
     } catch (error) {
       console.error('使用优惠券失败:', error)
       return {
         success: false,
         message: '使用优惠券失败，请稍后再试'
       }
     }
   }
   ```

### 3.3 开发小程序前端页面

1. **优惠券中心页面**

   创建优惠券中心页面，用于展示可领取的优惠券。

   ```html
   <!-- pages/coupon-center/coupon-center.wxml -->
   <view class="coupon-center">
     <view class="header">
       <text class="title">优惠券中心</text>
     </view>
     
     <view class="coupon-list">
       <block wx:for="{{coupons}}" wx:key="_id">
         <view class="coupon-item">
           <view class="coupon-left">
             <view class="coupon-value">
               <text wx:if="{{item.type === 'fixed'}}" class="value">¥{{item.value}}</text>
               <text wx:else class="value">{{item.value}}折</text>
             </view>
             <view class="coupon-condition">满{{item.minAmount}}元可用</view>
           </view>
           <view class="coupon-right">
             <view class="coupon-name">{{item.name}}</view>
             <view class="coupon-time">{{item.startTime}} - {{item.endTime}}</view>
             <view class="coupon-desc">{{item.description}}</view>
             <button class="receive-btn" data-id="{{item._id}}" bindtap="receiveCoupon">立即领取</button>
           </view>
         </view>
       </block>
     </view>
     
     <view class="empty-state" wx:if="{{coupons.length === 0}}">
       <image class="empty-image" src="/images/empty-coupon.png" mode="aspectFit"></image>
       <text class="empty-text">暂无可领取的优惠券</text>
     </view>
   </view>
   ```

   ```javascript
   // pages/coupon-center/coupon-center.js
   Page({
     data: {
       coupons: []
     },
     
     onLoad() {
       this.loadCoupons()
     },
     
     // 加载可领取的优惠券
     loadCoupons() {
       wx.showLoading({
         title: '加载中'
       })
       
       wx.cloud.callFunction({
         name: 'getActiveCoupons',
         data: {
           limit: 20
         }
       })
       .then(res => {
         if (res.result.success) {
           // 格式化日期
           const coupons = res.result.data.map(item => ({
             ...item,
             startTime: this.formatDate(item.startTime),
             endTime: this.formatDate(item.endTime)
           }))
           
           this.setData({
             coupons: coupons
           })
         } else {
           wx.showToast({
             title: res.result.message || '加载失败',
             icon: 'none'
           })
         }
       })
       .catch(err => {
         console.error('加载优惠券失败:', err)
         wx.showToast({
           title: '加载失败，请稍后再试',
           icon: 'none'
         })
       })
       .finally(() => {
         wx.hideLoading()
       })
     },
     
     // 领取优惠券
     receiveCoupon(e) {
       const couponId = e.currentTarget.dataset.id
       
       wx.showLoading({
         title: '领取中'
       })
       
       wx.cloud.callFunction({
         name: 'receiveCoupon',
         data: {
           couponId: couponId
         }
       })
       .then(res => {
         if (res.result.success) {
           wx.showToast({
             title: '领取成功',
             icon: 'success'
           })
           
           // 刷新优惠券列表
           this.loadCoupons()
         } else {
           wx.showToast({
             title: res.result.message || '领取失败',
             icon: 'none'
           })
         }
       })
       .catch(err => {
         console.error('领取优惠券失败:', err)
         wx.showToast({
           title: '领取失败，请稍后再试',
           icon: 'none'
         })
       })
       .finally(() => {
         wx.hideLoading()
       })
     },
     
     // 格式化日期
     formatDate(dateStr) {
       const date = new Date(dateStr)
       return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`
     }
   })
   ```

2. **我的优惠券页面**

   创建我的优惠券页面，用于展示用户已领取的优惠券。

   ```html
   <!-- pages/coupon/coupon.wxml -->
   <view class="coupon-container">
     <!-- 优惠券状态切换 -->
     <view class="tab-header">
       <view class="tab-item {{activeTab === 'unused' ? 'active' : ''}}" bindtap="switchTab" data-tab="unused">未使用</view>
       <view class="tab-item {{activeTab === 'used' ? 'active' : ''}}" bindtap="switchTab" data-tab="used">已使用</view>
       <view class="tab-item {{activeTab === 'expired' ? 'active' : ''}}" bindtap="switchTab" data-tab="expired">已过期</view>
     </view>
     
     <!-- 优惠券列表 -->
     <view class="coupon-list">
       <block wx:for="{{coupons}}" wx:key="_id">
         <view class="coupon-item {{item.status !== 'unused' ? 'disabled' : ''}}">
           <view class="coupon-main">
             <view class="coupon-left">
               <view class="coupon-value">
                 <text wx:if="{{item.type === 'fixed'}}" class="value">¥{{item.value}}</text>
                 <text wx:else class="value">{{item.value}}</text>
                 <text class="unit">{{item.type === 'fixed' ? '元' : '折'}}</text>
               </view>
               <view class="coupon-condition">满{{item.minAmount}}元可用</view>
             </view>
             <view class="coupon-right">
               <view class="coupon-title">{{item.name}}</view>
               <view class="coupon-validity">有效期至: {{item.expireTime}}</view>
             </view>
           </view>
           <view class="coupon-footer">
             <view class="usage-rules" bindtap="toggleRules" data-index="{{index}}">
               <text>使用规则</text>
               <image class="arrow {{item.rulesExpanded ? 'expanded' : ''}}" src="/images/icons/arrow-down.png" />
             </view>
             <view class="coupon-actions" wx:if="{{item.status === 'unused'}}">
               <button class="action-btn use-btn" data-id="{{item._id}}" bindtap="useCoupon">去使用</button>
             </view>
           </view>
           <view class="rules-details {{item.rulesExpanded ? 'expanded' : ''}}">
             <view class="rule-item">{{item.description}}</view>
             <view class="rule-item">有效期: {{item.receiveTime}} 至 {{item.expireTime}}</view>
             <view class="rule-item" wx:if="{{item.maxDiscount > 0}}">最高优惠{{item.maxDiscount}}元</view>
           </view>
           <view class="status-stamp" wx:if="{{item.status === 'used'}}">已使用</view>
           <view class="status-stamp" wx:if="{{item.status === 'expired'}}">已过期</view>
         </view>
       </block>
     </view>
     
     <!-- 空状态提示 -->
     <view class="empty-state" wx:if="{{coupons.length === 0}}">
       <image class="empty-image" src="/images/empty-coupon.png" mode="aspectFit"></image>
       <text class="empty-text">暂无{{activeTab === 'unused' ? '' : activeTab === 'used' ? '已使用' : '已过期'}}优惠券</text>
       <view class="get-coupon-btn" bindtap="goToCouponCenter">
         <text>去领券</text>
       </view>
     </view>
   </view>
   ```

   ```javascript
   // pages/coupon/coupon.js
   Page({
     data: {
       activeTab: 'unused', // unused, used, expired
       coupons: []
     },
     
     onLoad() {
       this.loadUserCoupons()
     },
     
     // 切换标签页
     switchTab(e) {
       const tab = e.currentTarget.dataset.tab
       this.setData({
         activeTab: tab
       })
       this.loadUserCoupons()
     },
     
     // 加载用户优惠券
     loadUserCoupons() {
       wx.showLoading({
         title: '加载中'
       })
       
       wx.cloud.callFunction({
         name: 'getUserCoupons',
         data: {
           status: this.data.activeTab
         }
       })
       .then(res => {
         if (res.result.success) {
           // 格式化日期并添加展开状态
           const coupons = res.result.data.map(item => ({
             ...item,
             receiveTime: this.formatDate(item.receiveTime),
             expireTime: this.formatDate(item.expireTime),
             rulesExpanded: false
           }))
           
           this.setData({
             coupons: coupons
           })
         } else {
           wx.showToast({
             title: res.result.message || '加载失败',
             icon: 'none'
           })
         }
       })
       .catch(err => {
         console.error('加载用户优惠券失败:', err)
         wx.showToast({
           title: '加载失败，请稍后再试',
           icon: 'none'
         })
       })
       .finally(() => {
         wx.hideLoading()
       })
     },
     
     // 切换使用规则展开/折叠
     toggleRules(e) {
       const index = e.currentTarget.dataset.index
       const coupons = this.data.coupons
       coupons[index].rulesExpanded = !coupons[index].rulesExpanded
       this.setData({
         coupons: coupons
       })
     },
     
     // 去使用优惠券
     useCoupon(e) {
       const couponId = e.currentTarget.dataset.id
       // 跳转到商品列表或购物车页面
       wx.switchTab({
         url: '/pages/index/index'
       })
     },
     
     // 去领券中心
     goToCouponCenter() {
       wx.navigateTo({
         url: '/pages/coupon-center/coupon-center'
       })
     },
     
     // 格式化日期
     formatDate(dateStr) {
       const date = new Date(dateStr)
       return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`
     }
   })
   ```

3. **订单确认页面中应用优惠券**

   在订单确认页面中添加优惠券选择功能。

   ```html
   <!-- pages/order/order.wxml 中添加优惠券选择部分 -->
   <view class="coupon-section">
     <view class="section-title">优惠券</view>
     <view class="section-content" bindtap="selectCoupon">
       <text wx:if="{{selectedCoupon}}">{{selectedCoupon.name}} - {{selectedCoupon.type === 'fixed' ? '¥' + selectedCoupon.value : selectedCoupon.value + '折'}}</text>
       <text wx:else>{{availableCoupons.length > 0 ? '有' + availableCoupons.length + '张可用' : '无可用优惠券'}}</text>
       <image class="arrow-right" src="/images/icons/arrow-right.png"></image>
     </view>
   </view>
   ```

   ```javascript
   // pages/order/order.js 中添加优惠券相关方法
   
   // 在data中添加
   data: {
     // 其他数据...
     availableCoupons: [],
     selectedCoupon: null,
     totalAmount: 0,      // 商品总金额
     discountAmount: 0,   // 优惠金额
     finalAmount: 0       // 最终支付金额
   },
   
   // 在onLoad中加载可用优惠券
   onLoad(options) {
     // 其他代码...
     this.loadAvailableCoupons()
   },
   
   // 加载可用优惠券
   loadAvailableCoupons() {
     const totalAmount = this.data.totalAmount
     
     wx.cloud.callFunction({
       name: 'getUserCoupons',
       data: {
         status: 'unused'
       }
     })
     .then(res => {
       if (res.result.success) {
         // 筛选出满足条件的优惠券
         const availableCoupons = res.result.data.filter(coupon => {
           return totalAmount >= coupon.minAmount
         })
         
         this.setData({
           availableCoupons: availableCoupons
         })
       }
     })
     .catch(err => {
       console.error('加载优惠券失败:', err)
     })
   },
   
   // 选择优惠券
   selectCoupon() {
     if (this.data.availableCoupons.length === 0) {
       wx.showToast({
         title: '暂无可用优惠券',
         icon: 'none'
       })
       return
     }
     
     wx.navigateTo({
       url: '/pages/select-coupon/select-coupon?totalAmount=' + this.data.totalAmount
     })
   },
   
   // 页面返回时更新选中的优惠券
   onShow() {
     const pages = getCurrentPages()
     const currPage = pages[pages.length - 1]
     
     // 如果有选中的优惠券
     if (currPage.data.selectedCoupon) {
       const coupon = currPage.data.selectedCoupon
       let discountAmount = 0
       
       // 计算优惠金额
       if (coupon.type === 'fixed') {
         discountAmount = coupon.value
       } else {
         discountAmount = this.data.totalAmount * (1 - coupon.value / 100)
         if (coupon.maxDiscount > 0 && discountAmount > coupon.maxDiscount) {
           discountAmount = coupon.maxDiscount
         }
       }
       
       // 更新金额
       this.setData({
         selectedCoupon: coupon,
         discountAmount: discountAmount,
         finalAmount: this.data.totalAmount - discountAmount
       })
     }
   },
   
   // 提交订单时使用优惠券
   submitOrder() {
     // 其他订单数据...
     const orderData = {
       // 订单基本信息...
       couponId: this.data.selectedCoupon ? this.data.selectedCoupon._id : '',
       couponAmount: this.data.discountAmount,
       // 其他订单数据...
     }
     
     // 提交订单
     wx.cloud.callFunction({
       name: 'submitOrder',
       data: {
         orderData: orderData
       }
     })
     .then(res => {
       if (res.result.ok) {
         // 如果使用了优惠券，调用使用优惠券接口
         if (this.data.selectedCoupon) {
           return wx.cloud.callFunction({
             name: 'useCoupon',
             data: {
               userCouponId: this.data.selectedCoupon._id,
               orderId: res.result.orderId,
               orderAmount: this.data.totalAmount
             }
           })
         }
         return res
       }
       return Promise.reject(res.result.message || '下单失败')
     })
     .then(res => {
       // 下单成功，跳转到支付页面
       wx.redirectTo({
         url: '/pages/pay/pay?orderId=' + res.result.orderId
       })
     })
     .catch(err => {
       console.error('提交订单失败:', err)
       wx.showToast({
         title: typeof err === 'string' ? err : '提交订单失败',
         icon: 'none'
       })
     })
   }
   ```

## 优惠券应用流程

### 4.1 优惠券发放

优惠券发放主要有以下几种方式：

1. **后台管理系统创建**
   - 管理员通过后台系统创建优惠券，设置优惠券类型、金额、使用条件等
   - 可以设置为公开领取或指定用户发放

2. **活动自动发放**
   - 用户完成特定活动（如首次注册、分享商品等）后自动发放优惠券
   - 通过云函数触发器实现自动发放逻辑

3. **定向发放**
   - 针对特定用户群体（如VIP用户、生日用户等）定向发放优惠券
   - 可以通过云函数定时触发器实现定期发放

### 4.2 优惠券领取

用户领取优惠券的流程：

1. 用户在优惠券中心浏览可领取的优惠券
2. 点击"立即领取"按钮，调用`receiveCoupon`云函数
3. 云函数验证优惠券是否有效、是否超过领取限制等
4. 如果验证通过，将优惠券添加到用户的优惠券列表中
5. 更新优惠券的剩余数量

### 4.3 优惠券使用

用户使用优惠券的流程：

1. 用户在购物车或订单确认页面选择使用优惠券
2. 系统根据订单金额筛选出可用的优惠券
3. 用户选择一张优惠券应用到当前订单
4. 系统计算优惠金额并更新订单总金额
5. 用户提交订单时，调用`useCoupon`云函数
6. 云函数验证优惠券是否有效、是否满足使用条件等
7. 如果验证通过，将优惠券标记为已使用，并与订单关联

### 4.4 优惠券核销

优惠券核销是指将优惠券标记为已使用的过程：

1. 用户成功提交订单并使用优惠券后，调用`useCoupon`云函数
2. 云函数将用户优惠券状态更新为"已使用"，记录使用时间和关联订单
3. 更新优惠券主表中的已使用数量
4. 如果用户取消订单，可以通过`cancelCouponUsage`云函数将优惠券恢复为未使用状态

## 部署指南

### 5.1 云函数部署

1. **准备工作**

   确保已安装微信开发者工具，并且已经创建了云开发环境。

2. **创建云函数**

   在项目根目录下的`cloudfunctions`文件夹中创建以下云函数：
   - `getActiveCoupons`
   - `receiveCoupon`
   - `getUserCoupons`
   - `useCoupon`

3. **安装依赖**

   在每个云函数目录下执行以下命令安装依赖：

   ```bash
   npm install --save wx-server-sdk
   ```

4. **上传云函数**

   在微信开发者工具中，右键点击每个云函数文件夹，选择"上传并部署：云端安装依赖"。

   或者使用命令行部署：

   ```bash
   # 在项目根目录下执行
   cd cloudfunctions/getActiveCoupons
   npm install
   wx cloud:deploy --env [环境ID]
   ```

5. **创建数据库集合**

   在云开发控制台中创建以下集合：
   - `mall_coupons`
   - `user_coupons`

6. **设置数据库权限**

   为了保证数据安全，需要设置合适的数据库权限：

   - `mall_coupons`：仅管理员可写，所有用户可读
   - `user_coupons`：仅创建者及管理员可读写

### 5.2 小程序前端部署

1. **创建页面**

   在项目的`pages`目录下创建以下页面：
   - `coupon`：我的优惠券页面
   - `coupon-center`：优惠券中心页面
   - `select-coupon`：选择优惠券页面

2. **修改app.json**

   在`app.json`中添加新页面的配置：

   ```json
   {
     "pages": [
       "pages/index/index",
       "pages/coupon/coupon",
       "pages/coupon-center/coupon-center",
       "pages/select-coupon/select-coupon",
       // 其他页面...
     ],
     // 其他配置...
   }
   ```

3. **添加页面入口**

   在用户中心页面添加"我的优惠券"入口：

   ```html
   <!-- pages/user/user.wxml -->
   <view class="menu-item" bindtap="navigateToCoupon">
     <image class="menu-icon" src="/images/icons/coupon.png"></image>
     <text class="menu-text">我的优惠券</text>
     <image class="arrow-right" src="/images/icons/arrow-right.png"></image>
   </view>
   ```

   ```javascript
   // pages/user/user.js
   navigateToCoupon() {
     wx.navigateTo({
       url: '/pages/coupon/coupon'
     })
   }
   ```

4. **在商品详情页添加优惠券展示**

   在商品详情页面添加可用优惠券展示：

   ```html
   <!-- pages/product-detail/product-detail.wxml -->
   <view class="coupon-section" wx:if="{{coupons.length > 0}}">
     <view class="section-title">优惠券</view>
     <scroll-view class="coupon-list" scroll-x="true">
       <view class="coupon-item" wx:for="{{coupons}}" wx:key="id" bindtap="onCouponTap" data-coupon="{{item}}">
         <view class="coupon-amount">¥{{item.amount}}</view>
         <view class="coupon-condition">满{{item.minAmount}}可用</view>
         <view class="coupon-btn">领取</view>
       </view>
     </scroll-view>
   </view>
   ```

5. **预览和发布**

   在微信开发者工具中预览小程序，确保所有功能正常运行后，点击"上传"按钮将代码上传到微信平台，然后在微信公众平台提交审核并发布。

## 常见问题与解决方案

1. **优惠券无法领取**

   - 检查优惠券是否已达到发放上限
   - 检查用户是否已达到领取上限
   - 检查优惠券是否在有效期内
   - 检查数据库权限设置是否正确

2. **优惠券无法使用**

   - 检查订单金额是否满足优惠券使用条件
   - 检查优惠券是否已过期
   - 检查优惠券状态是否为未使用
   - 检查商品是否在优惠券适用范围内

3. **优惠金额计算错误**

   - 检查优惠券类型和优惠值是否正确
   - 检查最大优惠金额限制是否正确应用
   - 检查订单金额计算逻辑是否正确

4. **数据库操作失败**

   - 检查云函数权限设置
   - 检查数据库集合权限设置
   - 使用事务确保数据一致性
   - 添加适当的错误处理和日志记录

## 8. Web端优惠券管理系统开发

### 8.1 Web端优惠券管理页面开发

1. **优惠券列表页面**

   创建优惠券列表页面，用于展示和管理所有优惠券。

   ```html
   <!-- views/coupon/list.vue -->
   <template>
     <div class="coupon-management">
       <div class="page-header">
         <h2>优惠券管理</h2>
         <el-button type="primary" @click="showAddDialog">新增优惠券</el-button>
       </div>
       
       <el-table :data="coupons" border style="width: 100%">
         <el-table-column prop="code" label="优惠券码" width="120"></el-table-column>
         <el-table-column prop="name" label="优惠券名称" width="150"></el-table-column>
         <el-table-column label="优惠类型" width="100">
           <template slot-scope="scope">
             {{ scope.row.type === 'fixed' ? '固定金额' : '折扣比例' }}
           </template>
         </el-table-column>
         <el-table-column label="优惠值" width="100">
           <template slot-scope="scope">
             {{ scope.row.type === 'fixed' ? '¥' + scope.row.value : scope.row.value + '%' }}
           </template>
         </el-table-column>
         <el-table-column prop="minAmount" label="最低消费" width="100"></el-table-column>
         <el-table-column label="有效期" width="220">
           <template slot-scope="scope">
             {{ formatDate(scope.row.startTime) }} 至 {{ formatDate(scope.row.endTime) }}
           </template>
         </el-table-column>
         <el-table-column label="库存" width="150">
           <template slot-scope="scope">
             {{ scope.row.remainingCount }}/{{ scope.row.totalCount }}
           </template>
         </el-table-column>
         <el-table-column label="状态" width="100">
           <template slot-scope="scope">
             <el-tag :type="scope.row.status === 'active' ? 'success' : 'info'">
               {{ scope.row.status === 'active' ? '启用' : '停用' }}
             </el-tag>
           </template>
         </el-table-column>
         <el-table-column label="操作" width="220">
           <template slot-scope="scope">
             <el-button size="mini" @click="editCoupon(scope.row)">编辑</el-button>
             <el-button size="mini" type="primary" @click="showRulesDialog(scope.row)">设置细则</el-button>
             <el-button 
               size="mini" 
               :type="scope.row.status === 'active' ? 'danger' : 'success'"
               @click="toggleStatus(scope.row)"
             >
               {{ scope.row.status === 'active' ? '停用' : '启用' }}
             </el-button>
           </template>
         </el-table-column>
       </el-table>
       
       <!-- 优惠券细则设置对话框 -->
       <el-dialog title="设置优惠券使用细则" :visible.sync="rulesDialogVisible" width="50%">
         <el-form :model="currentCoupon" label-width="120px">
           <el-form-item label="优惠券名称">
             <span>{{ currentCoupon.name }}</span>
           </el-form-item>
           
           <el-form-item label="使用细则">
             <el-input 
               type="textarea" 
               :rows="6" 
               placeholder="请输入优惠券使用细则，支持多条规则，每条规则将单独显示"
               v-model="currentCoupon.rules"
             ></el-input>
             <div class="tips">提示：每行一条规则，将在小程序中分条显示</div>
           </el-form-item>
           
           <el-form-item label="适用商品">
             <el-select 
               v-model="currentCoupon.applicableProducts" 
               multiple 
               placeholder="请选择适用商品，不选则适用于所有商品"
             >
               <el-option 
                 v-for="item in products" 
                 :key="item._id" 
                 :label="item.name" 
                 :value="item._id"
               ></el-option>
             </el-select>
           </el-form-item>
           
           <el-form-item label="适用分类">
             <el-select 
               v-model="currentCoupon.applicableCategories" 
               multiple 
               placeholder="请选择适用分类，不选则适用于所有分类"
             >
               <el-option 
                 v-for="item in categories" 
                 :key="item._id" 
                 :label="item.name" 
                 :value="item._id"
               ></el-option>
             </el-select>
           </el-form-item>
           
           <el-form-item label="排除商品">
             <el-select 
               v-model="currentCoupon.excludeProducts" 
               multiple 
               placeholder="请选择排除的商品"
             >
               <el-option 
                 v-for="item in products" 
                 :key="item._id" 
                 :label="item.name" 
                 :value="item._id"
               ></el-option>
             </el-select>
           </el-form-item>
         </el-form>
         <div slot="footer" class="dialog-footer">
           <el-button @click="rulesDialogVisible = false">取消</el-button>
           <el-button type="primary" @click="saveRules">保存</el-button>
         </div>
       </el-dialog>
     </div>
   </template>
   
   <script>
   export default {
     data() {
       return {
         coupons: [],
         products: [],
         categories: [],
         currentCoupon: {},
         rulesDialogVisible: false
       }
     },
     
     created() {
       this.fetchCoupons()
       this.fetchProducts()
       this.fetchCategories()
     },
     
     methods: {
       // 获取优惠券列表
       async fetchCoupons() {
         try {
           const res = await this.$http.get('/api/coupons')
           this.coupons = res.data
         } catch (error) {
           this.$message.error('获取优惠券列表失败')
           console.error(error)
         }
       },
       
       // 获取商品列表
       async fetchProducts() {
         try {
           const res = await this.$http.get('/api/products')
           this.products = res.data
         } catch (error) {
           this.$message.error('获取商品列表失败')
           console.error(error)
         }
       },
       
       // 获取分类列表
       async fetchCategories() {
         try {
           const res = await this.$http.get('/api/categories')
           this.categories = res.data
         } catch (error) {
           this.$message.error('获取分类列表失败')
           console.error(error)
         }
       },
       
       // 显示优惠券细则设置对话框
       showRulesDialog(coupon) {
         this.currentCoupon = JSON.parse(JSON.stringify(coupon))
         // 如果rules字段不存在，初始化为空字符串
         if (!this.currentCoupon.rules) {
           this.currentCoupon.rules = ''
         }
         this.rulesDialogVisible = true
       },
       
       // 保存优惠券细则
       async saveRules() {
         try {
           await this.$http.put(`/api/coupons/${this.currentCoupon._id}`, {
             rules: this.currentCoupon.rules,
             applicableProducts: this.currentCoupon.applicableProducts,
             applicableCategories: this.currentCoupon.applicableCategories,
             excludeProducts: this.currentCoupon.excludeProducts
           })
           
           this.$message.success('保存成功')
           this.rulesDialogVisible = false
           this.fetchCoupons() // 刷新列表
         } catch (error) {
           this.$message.error('保存失败')
           console.error(error)
         }
       },
       
       // 格式化日期
       formatDate(dateStr) {
         const date = new Date(dateStr)
         return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`
       },
       
       // 其他方法...
     }
   }
   </script>
   ```

2. **后端API接口开发**

   创建优惠券管理相关的API接口。

   ```javascript
   // server/controllers/coupon.js
   const db = require('../models/db')
   
   // 获取优惠券列表
   exports.getCoupons = async (req, res) => {
     try {
       const coupons = await db.collection('mall_coupons').get()
       res.json(coupons)
     } catch (error) {
       console.error('获取优惠券列表失败:', error)
       res.status(500).json({ message: '获取优惠券列表失败' })
     }
   }
   
   // 创建优惠券
   exports.createCoupon = async (req, res) => {
     try {
       const couponData = req.body
       
       // 设置默认值
       couponData.createTime = new Date()
       couponData.updateTime = new Date()
       couponData.usedCount = 0
       couponData.remainingCount = couponData.totalCount
       
       const result = await db.collection('mall_coupons').add(couponData)
       res.json({ id: result.id, message: '创建成功' })
     } catch (error) {
       console.error('创建优惠券失败:', error)
       res.status(500).json({ message: '创建优惠券失败' })
     }
   }
   
   // 更新优惠券
   exports.updateCoupon = async (req, res) => {
     try {
       const { id } = req.params
       const updateData = req.body
       
       // 更新时间
       updateData.updateTime = new Date()
       
       await db.collection('mall_coupons').doc(id).update(updateData)
       res.json({ message: '更新成功' })
     } catch (error) {
       console.error('更新优惠券失败:', error)
       res.status(500).json({ message: '更新优惠券失败' })
     }
   }
   
   // 更新优惠券状态
   exports.updateCouponStatus = async (req, res) => {
     try {
       const { id } = req.params
       const { status } = req.body
       
       await db.collection('mall_coupons').doc(id).update({
         status: status,
         updateTime: new Date()
       })
       
       res.json({ message: '状态更新成功' })
     } catch (error) {
       console.error('更新优惠券状态失败:', error)
       res.status(500).json({ message: '更新优惠券状态失败' })
     }
   }
   ```

### 8.2 优惠券细则数据模型扩展

在优惠券主表中添加以下字段，用于存储优惠券使用细则：

| 字段名 | 类型 | 必填 | 默认值 | 描述 | 索引 |
|--------|------|------|--------|------|------|
| rules | String | 否 | "" | 使用细则（多行文本） | - |

### 8.3 小程序展示优惠券细则

1. **修改云函数获取优惠券细则**

   更新 `getActiveCoupons` 和 `getUserCoupons` 云函数，确保返回优惠券细则信息。

   ```javascript
   // cloudfunctions/getActiveCoupons/index.js 中确保返回rules字段
   const result = await db.collection('mall_coupons')
     .where({
       status: status,
       startTime: db.command.lte(now),
       endTime: db.command.gte(now),
       totalCount: db.command.gt(0) // 还有库存
     })
     .field({
       _id: true,
       code: true,
       name: true,
       description: true,
       type: true,
       value: true,
       minAmount: true,
       maxDiscount: true,
       remainingCount: true,
       startTime: true,
       endTime: true,
       rules: true, // 确保返回rules字段
       applicableProducts: true,
       applicableCategories: true,
       excludeProducts: true
     })
     .orderBy('createTime', 'desc')
     .limit(limit)
     .get()
   ```

2. **优惠券详情页面展示细则**

   创建优惠券详情页面，用于展示优惠券的详细信息和使用细则。

   ```html
   <!-- pages/coupon-detail/coupon-detail.wxml -->
   <view class="coupon-detail">
     <view class="coupon-card">
       <view class="coupon-header">
         <view class="coupon-value">
           <text wx:if="{{coupon.type === 'fixed'}}" class="value">¥{{coupon.value}}</text>
           <text wx:else class="value">{{coupon.value}}折</text>
         </view>
         <view class="coupon-condition">满{{coupon.minAmount}}元可用</view>
       </view>
       
       <view class="coupon-body">
         <view class="coupon-name">{{coupon.name}}</view>
         <view class="coupon-validity">有效期: {{coupon.startTime}} - {{coupon.endTime}}</view>
       </view>
       
       <view class="coupon-footer">
         <button class="receive-btn" bindtap="receiveCoupon">立即领取</button>
       </view>
     </view>
     
     <view class="rules-section">
       <view class="section-title">使用规则</view>
       <view class="rules-list">
         <block wx:if="{{coupon.rules && coupon.rules.length > 0}}">
           <view wx:for="{{rulesArray}}" wx:key="index" class="rule-item">
             <text class="rule-dot">•</text>
             <text class="rule-text">{{item}}</text>
           </view>
         </block>
         <view wx:else class="rule-item">
           <text class="rule-dot">•</text>
           <text class="rule-text">满{{coupon.minAmount}}元可用</text>
         </view>
         <view class="rule-item">
           <text class="rule-dot">•</text>
           <text class="rule-text">有效期: {{coupon.startTime}} - {{coupon.endTime}}</text>
         </view>
         <view class="rule-item" wx:if="{{coupon.maxDiscount > 0}}">
           <text class="rule-dot">•</text>
           <text class="rule-text">最高优惠{{coupon.maxDiscount}}元</text>
         </view>
       </view>
     </view>
     
     <view class="applicable-section" wx:if="{{hasApplicableInfo}}">
       <view class="section-title">适用范围</view>
       <view class="applicable-info">
         <view wx:if="{{applicableProducts.length > 0}}" class="applicable-products">
           <view class="sub-title">适用商品</view>
           <view class="product-list">
             <view wx:for="{{applicableProducts}}" wx:key="_id" class="product-item">
               {{item.name}}
             </view>
           </view>
         </view>
         
         <view wx:if="{{applicableCategories.length > 0}}" class="applicable-categories">
           <view class="sub-title">适用分类</view>
           <view class="category-list">
             <view wx:for="{{applicableCategories}}" wx:key="_id" class="category-item">
               {{item.name}}
             </view>
           </view>
         </view>
       </view>
     </view>
   </view>
   ```

   ```javascript
   // pages/coupon-detail/coupon-detail.js
   Page({
     data: {
       couponId: '',
       coupon: {},
       rulesArray: [],
       applicableProducts: [],
       applicableCategories: [],
       hasApplicableInfo: false
     },
     
     onLoad(options) {
       if (options.id) {
         this.setData({
           couponId: options.id
         })
         this.loadCouponDetail()
       }
     },
     
     // 加载优惠券详情
     loadCouponDetail() {
       wx.showLoading({
         title: '加载中'
       })
       
       wx.cloud.callFunction({
         name: 'getCouponDetail',
         data: {
           couponId: this.data.couponId
         }
       })
       .then(res => {
         if (res.result.success) {
           const coupon = res.result.data
           
           // 格式化日期
           coupon.startTime = this.formatDate(coupon.startTime)
           coupon.endTime = this.formatDate(coupon.endTime)
           
           // 将规则字符串转换为数组
           const rulesArray = coupon.rules ? coupon.rules.split('\n').filter(rule => rule.trim() !== '') : []
           
           this.setData({
             coupon: coupon,
             rulesArray: rulesArray
           })
           
           // 加载适用商品和分类信息
           this.loadApplicableInfo()
         } else {
           wx.showToast({
             title: res.result.message || '加载失败',
             icon: 'none'
           })
         }
       })
       .catch(err => {
         console.error('加载优惠券详情失败:', err)
         wx.showToast({
           title: '加载失败，请稍后再试',
           icon: 'none'
         })
       })
       .finally(() => {
         wx.hideLoading()
       })
     },
     
     // 加载适用商品和分类信息
     loadApplicableInfo() {
       const { applicableProducts, applicableCategories } = this.data.coupon
       
       if ((applicableProducts && applicableProducts.length > 0) || 
           (applicableCategories && applicableCategories.length > 0)) {
         
         // 获取商品信息
         if (applicableProducts && applicableProducts.length > 0) {
           wx.cloud.callFunction({
             name: 'getProductsByIds',
             data: {
               productIds: applicableProducts
             }
           })
           .then(res => {
             if (res.result.success) {
               this.setData({
                 applicableProducts: res.result.data,
                 hasApplicableInfo: true
               })
             }
           })
         }
         
         // 获取分类信息
         if (applicableCategories && applicableCategories.length > 0) {
           wx.cloud.callFunction({
             name: 'getCategoriesByIds',
             data: {
               categoryIds: applicableCategories
             }
           })
           .then(res => {
             if (res.result.success) {
               this.setData({
                 applicableCategories: res.result.data,
                 hasApplicableInfo: true
               })
             }
           })
         }
       }
     },
     
     // 领取优惠券
     receiveCoupon() {
       wx.showLoading({
         title: '领取中'
       })
       
       wx.cloud.callFunction({
         name: 'receiveCoupon',
         data: {
           couponId: this.data.couponId
         }
       })
       .then(res => {
         if (res.result.success) {
           wx.showToast({
             title: '领取成功',
             icon: 'success'
           })
           
           // 延迟返回上一页
           setTimeout(() => {
             wx.navigateBack()
           }, 1500)
         } else {
           wx.showToast({
             title: res.result.message || '领取失败',
             icon: 'none'
           })
         }
       })
       .catch(err => {
         console.error('领取优惠券失败:', err)
         wx.showToast({
           title: '领取失败，请稍后再试',
           icon: 'none'
         })
       })
       .finally(() => {
         wx.hideLoading()
       })
     },
     
     // 格式化日期
     formatDate(dateStr) {
       const date = new Date(dateStr)
       return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`
     }
   })
   ```

3. **修改我的优惠券页面展示细则**

   更新我的优惠券页面，优化规则展示部分。

   ```html
   <!-- pages/coupon/coupon.wxml 中的规则详情部分 -->
   <view class="rules-details {{item.rulesExpanded ? 'expanded' : ''}}">
     <block wx:if="{{item.rules}}">
       <view wx:for="{{item.rulesArray}}" wx:for-item="rule" wx:key="index" class="rule-item">
         <text class="rule-dot">•</text>
         <text class="rule-text">{{rule}}</text>
       </view>
     </block>
     <view class="rule-item" wx:else>满{{item.minAmount}}元可用</view>
     <view class="rule-item">有效期: {{item.receiveTime}} 至 {{item.expireTime}}</view>
     <view class="rule-item" wx:if="{{item.maxDiscount > 0}}">最高优惠{{item.maxDiscount}}元</view>
   </view>
   ```

   ```javascript
   // pages/coupon/coupon.js 中添加处理规则数组的代码
   // 在loadUserCoupons方法中添加
   .then(res => {
     if (res.result.success) {
       // 格式化日期并添加展开状态
       const coupons = res.result.data.map(item => {
         // 将规则字符串转换为数组
         item.rulesArray = item.rules ? item.rules.split('\n').filter(rule => rule.trim() !== '') : []
         
         return {
           ...item,
           receiveTime: this.formatDate(item.receiveTime),
           expireTime: this.formatDate(item.expireTime),
           rulesExpanded: false
         }
       })
       
       this.setData({
         coupons: coupons
       })
     } else {
       // 错误处理...
     }
   })
   ```

## 9. 优化建议

1. **性能优化**

   - 为常用查询添加索引
   - 使用云函数聚合操作减少请求次数
   - 实现优惠券数据缓存，减少数据库查询

2. **用户体验优化**

   - 添加优惠券过期提醒
   - 实现优惠券自动推荐功能
   - 优化优惠券领取和使用流程
   - 添加优惠券分享功能

3. **营销功能扩展**

   - 实现优惠券组合使用
   - 添加会员专享优惠券
   - 实现优惠券兑换码功能
   - 添加优惠券活动页面

4. **安全性优化**

   - 加强优惠券验证逻辑
   - 实现优惠券使用频率限制
   - 添加异常使用监控和报警机制
   - 优化事务处理，确保数据一致性