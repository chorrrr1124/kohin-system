# 预存产品创建功能说明

## 功能概述

在商城下单页面新增了**预存产品创建功能**，当点击"预存产品"支付方式时，不再是使用现有的预存记录，而是为该客户创建新的预存产品记录。

## 主要特性

### 🎯 预存产品创建模式
- **触发方式**：点击"预存产品"支付方式按钮
- **前置条件**：必须先选择客户且购物车不为空
- **智能初始化**：自动将购物车中的商品作为待预存商品

### 📝 功能流程

#### 1. 进入创建模式
1. 在商城下单页面选择客户
2. 添加商品到购物车
3. 点击"立即下单"
4. 在支付方式中点击"预存产品"
5. 自动进入预存产品创建模式

#### 2. 选择预存商品
- **全选默认**：购物车中的所有商品默认被选中
- **灵活选择**：可以通过复选框选择或取消商品
- **实时统计**：动态显示预存总价值
- **商品信息**：显示商品名称、数量、单价、小计

#### 3. 创建预存记录
- **批量创建**：为每个选中的商品创建独立的预存记录
- **完整信息**：包含客户信息、商品信息、预存数量等
- **状态管理**：自动设置为活跃状态
- **来源标记**：标记为"商城下单预存"

## 技术实现

### 🔧 核心状态管理
```javascript
// 预存产品创建相关状态
const [createPrepaidMode, setCreatePrepaidMode] = useState(false);
const [prepaidProductData, setPrepaidProductData] = useState({
  selectedProducts: [], // 选中的商品
  totalAmount: 0 // 预存总金额
});
```

### 🛠 关键功能函数

#### 1. 进入预存产品模式
```javascript
const handlePrepaidProductMode = () => {
  // 验证前置条件
  // 设置创建模式
  // 初始化预存产品数据
};
```

#### 2. 创建预存产品记录
```javascript
const createPrepaidProductRecords = async () => {
  // 验证选择的商品
  // 批量创建预存记录
  // 重置状态和刷新数据
};
```

#### 3. 商品选择管理
```javascript
const togglePrepaidProductSelection = (productId) => {
  // 切换商品选择状态
  // 更新预存产品数据
};
```

### 💾 数据库记录结构
```javascript
const prepaidRecord = {
  customerId: '客户ID',
  customerName: '客户姓名',
  customerPhone: '客户电话',
  productId: '商品ID',
  productName: '商品名称',
  type: 'product', // 固定为产品类型
  balance: '预存数量',
  originalBalance: '原始预存数量',
  unitPrice: '单价',
  totalAmount: '总金额',
  createTime: '创建时间',
  updateTime: '更新时间',
  source: '商城下单预存', // 来源标记
  status: 'active' // 状态
};
```

## 用户界面

### 🎨 创建模式界面
- **警告提示**：明确显示当前处于预存产品创建模式
- **商品列表**：显示可选择的商品列表，支持复选框选择
- **价格统计**：实时显示选中商品的总价值
- **操作按钮**：提供"取消"和"创建预存记录"按钮

### 🔄 状态切换
- **自动切换**：选择"预存产品"支付方式时自动进入创建模式
- **手动取消**：可以随时取消创建模式，返回正常下单流程
- **完成重置**：创建完成后自动重置到初始状态

## 验证逻辑

### ✅ 前置条件检查
1. **客户验证**：必须选择客户
2. **购物车验证**：购物车不能为空
3. **商品选择验证**：至少选择一个商品进行预存

### 🔒 数据安全
- **事务处理**：使用Promise.all确保批量创建的原子性
- **错误处理**：完善的错误捕获和用户提示
- **状态同步**：创建完成后自动刷新预存记录列表

## 使用示例

### 📋 典型使用场景
1. **客户预付款**：客户提前支付商品费用，后续直接使用预存商品
2. **会员储值**：为VIP客户提供商品储值服务
3. **团购预存**：团购活动中为客户预存商品

### 🎯 操作步骤
1. 选择客户：0918
2. 添加商品：苹果 x2个，橙子 x1个
3. 点击"立即下单" → 选择"预存产品"
4. 在预存产品创建界面中确认选择的商品
5. 点击"创建预存记录"
6. 系统提示：成功为 0918 创建了 2 个预存产品记录

## 功能优势

### 🚀 业务价值
- **提升客户体验**：简化预存流程，提高操作便利性
- **增强资金流**：鼓励客户预存，改善现金流
- **精确管理**：每个商品独立记录，便于后续管理

### 💡 技术优势
- **状态分离**：预存创建与正常下单逻辑完全分离
- **UI清晰**：专门的创建界面，用户操作明确
- **数据完整**：完整记录预存信息，支持后续查询和管理

## 部署状态

✅ **功能已完成并部署**
- Web端管理后台已更新
- 所有新功能已通过测试
- 静态托管已重新部署

🌐 **访问地址**：[管理后台](https://cloudbase-3g4w6lls8a5ce59b-1327524326.tcloudbaseapp.com/admin)

现在您可以在商城下单页面体验新的预存产品创建功能！
