# 功能进展与下一步（Kohin 商城系统）

## 一、当前已完成（截至本次更新）
- **项目结构与文档**：项目多端（用户端小程序、管理端小程序、Web 后台）与大量技术/实施文档已就绪，`README.md`、`系统架构说明.md`、`数据库设计文档.md`、`API接口文档.md` 等完整。
- **云开发资源**：
  - `cloudbaserc.json` 已配置环境信息，支持 CLI 与控制台可视化管理。
  - 云函数目录 `cloudfunctions/` 已规范化，具备可独立部署能力。
- **云函数（本次重点）**：
  - `getCosSts` 已完成最小化健康探测版本的重建与部署，调用验证成功；修复了此前依赖安装与语法异常问题。
  - 运行链路验证通过（CLI 调用成功返回），当前未依赖第三方包，便于快速稳定运行与问题定位。
- **小程序与 Web**：
  - 用户端与管理端小程序目录齐备，可在开发者工具中导入构建。
  - Web 后台工程（`web7.27/miniprogram-admin`）具备构建产物与构建脚本说明。

## 二、关键变更（本次）
- 移除 `getCosSts` 的历史依赖，保留最小化实现，已成功部署并可正常调用。
- 便于后续切换至 Node16 运行时与追加环境变量配置。

## 三、待办与下一步计划
1. **云函数运行环境与配置**（控制台操作）
   - 将 `getCosSts` 运行时升级为 `Nodejs 16.13`。
   - 可选：超时时间设置为 `10s`。
   - 新增环境变量（控制台/CLI 配置）：
     - `TENCENT_SECRET_ID`
     - `TENCENT_SECRET_KEY`
     - `COS_BUCKET`
     - `COS_REGION`
2. **实现 STS 颁发逻辑（安全合规版）**
   - 在 `getCosSts/index.js` 中补全基于腾讯云 STS 的临时密钥颁发逻辑，限定允许的操作与资源范围（最小权限原则）。
   - 不强制引入三方包，优先调用官方 SDK/接口，减少依赖带来的部署不确定性。
   - 增加参数校验与错误处理，返回统一结构（`success/data/error`）。
3. **上传能力联调**
   - 前端/管理端中的图片上传路径改造为：前端请求 `getCosSts` 获取临时密钥 → 直传 COS。
   - 校验存储路径与访问域名：确认静态托管与 COS 桶的访问域名规划、CDN 缓存策略与资源前缀。
4. **Web 后台构建与托管**
   - 构建 `web7.27/miniprogram-admin` 并部署至云开发静态托管。
   - 采用相对路径资源引用，避免 CDN 路径不确定导致的 404。
   - 完成后将实际访问地址写入 `README.md` 与 `项目部署状态.md`。
5. **小程序导入与基础联测**
   - 在微信开发者工具导入 `商城小程序/`、`完成版小程序后台8.7/`，并配置云开发环境。
   - 回归核心流程：登录→商品→下单→订单→支付（如需，接入模拟/沙箱）。
6. **数据与权限**
   - 核对数据库集合权限（仅创建者可写/管理端可写等），符合前端直连/云函数访问场景。
   - 若涉及跨集合复杂事务，统一通过云函数侧实现，前端避免越权操作。
7. **质量与监控**
   - 增加云函数日志关注项、错误上报与埋点。
   - 编写基础 E2E/接口用例，覆盖上传/订单等核心路径。

## 四、交付与验收
- 完成上述运行时与环境变量配置后，交付“可用的 STS 颁发 + 前端直传 COS”闭环，并提供演示录屏与访问地址。
- 文档同步更新：在 `README.md` 与 `项目部署状态.md` 增补部署地址与环境变量清单。

## 五、后续规划（可选）
- 引入细粒度权限（如按角色拆分 Upload 前缀/路径）。
- 静态托管绑定自定义域名与 HTTPS 强制跳转。
- 接入监控/报警（函数错误率、超时、COS 写入失败等）。 