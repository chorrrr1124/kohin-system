# 商城小程序云函数部署指南

## 问题说明

在测试登录功能时出现以下错误：
```
登录失败: Error: cloud.callFunction:fail Error: errCode: -501000 | errMsg: FunctionName parameter could not be found.
```

这个错误表示云函数未正确部署到云开发环境中。

## 解决方案

### 1. 云函数依赖更新

已将以下云函数的 `wx-server-sdk` 版本更新为最新版本 `3.0.1`：
- `login` 云函数
- `syncUser` 云函数

### 2. 部署步骤

#### 方法一：使用微信开发者工具（推荐）

1. **打开微信开发者工具**
   - 导入项目：`c:\Users\chor\Desktop\code\finish\商城小程序`

2. **配置云开发环境**
   - 点击工具栏中的「云开发」按钮
   - 如果是首次使用，需要开通云开发服务
   - 记录环境ID（env-xxxxx）

3. **部署login云函数**
   - 在左侧文件树中找到 `cloudfunctions/login` 文件夹
   - 右键点击 `login` 文件夹
   - 选择「创建并部署：云端安装依赖（不上传node_modules）」
   - 等待部署完成

4. **部署syncUser云函数**
   - 在左侧文件树中找到 `cloudfunctions/syncUser` 文件夹
   - 右键点击 `syncUser` 文件夹
   - 选择「创建并部署：云端安装依赖（不上传node_modules）」
   - 等待部署完成

#### 方法二：使用命令行工具

1. **安装云开发CLI工具**
   ```bash
   npm install -g @cloudbase/cli
   ```

2. **登录云开发**
   ```bash
   tcb login
   ```

3. **部署云函数**
   ```bash
   # 进入项目目录
   cd "c:\Users\chor\Desktop\code\finish\商城小程序"
   
   # 部署login云函数
   tcb functions:deploy login
   
   # 部署syncUser云函数
   tcb functions:deploy syncUser
   ```

### 3. 验证部署

1. **在微信开发者工具中验证**
   - 打开「云开发控制台」
   - 点击「云函数」标签
   - 确认可以看到 `login` 和 `syncUser` 两个函数
   - 状态应该显示为「正常」

2. **测试云函数**
   - 在云开发控制台中点击函数名称
   - 点击「测试」按钮
   - 对于login函数，可以使用空的测试参数 `{}`
   - 应该返回包含openid的结果

### 4. 数据库配置

确保云开发数据库中存在以下集合：
- `users` - 用户信息集合
- `orders` - 订单信息集合（如果使用）

如果集合不存在，可以在云开发控制台的「数据库」标签中手动创建。

### 5. 权限配置

在云开发控制台的「数据库」→「权限设置」中，确保：
- `users` 集合的权限设置为「仅创建者可读写」或「所有用户可读，仅创建者可写」
- 根据实际需求调整权限设置

## 常见问题

### Q1: 部署时提示权限错误
A: 确保已正确登录微信开发者工具，并且账号有该小程序的开发权限。

### Q2: 云函数部署成功但调用失败
A: 检查小程序的 `app.js` 中是否正确初始化了云开发：
```javascript
wx.cloud.init({
  env: 'your-env-id' // 替换为你的环境ID
})
```

### Q3: 找不到云开发按钮
A: 确保使用的是最新版本的微信开发者工具，并且小程序已开通云开发服务。

### Q4: 部署后仍然报错
A: 
1. 清除小程序缓存：开发者工具 → 工具 → 清缓存
2. 重新编译小程序
3. 检查网络连接是否正常

## 部署完成后的测试

1. **打开小程序**
   - 在微信开发者工具中预览小程序

2. **测试登录功能**
   - 导航到首页，点击「测试登录弹窗」按钮
   - 或访问测试页面进行完整测试

3. **查看控制台**
   - 如果仍有错误，查看开发者工具的控制台输出
   - 检查云函数调用日志

## 注意事项

1. **环境ID配置**
   - 确保 `app.js` 中的环境ID与实际部署的环境一致

2. **网络环境**
   - 云函数部署需要稳定的网络连接
   - 如果网络不稳定，可能需要多次尝试

3. **版本兼容性**
   - 已更新 `wx-server-sdk` 到最新版本 `3.0.1`
   - 确保微信开发者工具版本不低于 1.02.1907300

---

完成以上步骤后，登录功能应该可以正常工作。如果仍有问题，请检查云开发控制台中的函数日志获取更详细的错误信息。