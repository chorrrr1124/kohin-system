# 🎫 优惠券系统说明文档

## 📋 系统概述

本优惠券系统实现了web端管理与小程序端使用的完整闭环，支持优惠券的创建、发放、领取、使用和统计等功能。

## 🏗️ 系统架构

### 数据集合结构

#### 1. `mall_coupons` - 优惠券模板集合
```javascript
{
  _id: "优惠券ID",
  name: "优惠券名称",
  type: "fixed|percentage", // 固定金额或百分比折扣
  value: 10, // 优惠金额或折扣比例
  minAmount: 50, // 最低消费金额
  startTime: "2024-01-01", // 开始时间
  endTime: "2024-12-31", // 结束时间（null表示永不过期）
  description: "优惠券描述",
  status: "active|inactive", // 状态
  totalCount: 999999, // 总数量
  usedCount: 0, // 已使用数量
  createTime: "创建时间",
  updateTime: "更新时间"
}
```

#### 2. `user_coupons` - 用户优惠券集合
```javascript
{
  _id: "用户优惠券ID",
  _openid: "用户openid",
  couponId: "优惠券模板ID",
  couponName: "优惠券名称",
  couponType: "fixed|percentage",
  value: 10,
  minAmount: 50,
  startTime: "开始时间",
  endTime: "结束时间",
  expireTime: "过期时间",
  status: "unused|used|expired", // 状态
  issuedAt: "发放时间",
  createTime: "创建时间",
  condition: "领取条件" // 记录如何获得的
}
```

## 🔄 工作流程

### 1. 优惠券创建流程
```
Web端管理 → 创建优惠券 → 保存到mall_coupons → 设置状态为active
```

### 2. 优惠券领取流程
```
用户进入优惠券中心 → 查看可用优惠券 → 点击领取 → 调用claimCoupon云函数 → 创建user_coupons记录
```

### 3. 优惠券统计流程
```
页面加载 → 调用getUserCouponCount云函数 → 聚合查询有效优惠券 → 返回数量 → 更新UI显示
```

## 🛠️ 核心功能

### Web端管理功能
- ✅ 优惠券创建（支持固定金额和百分比折扣）
- ✅ 优惠券编辑和删除
- ✅ 优惠券状态管理
- ✅ 批量发放给指定用户
- ✅ 优惠券列表查看

### 小程序端功能
- ✅ 优惠券中心展示
- ✅ 优惠券领取
- ✅ 我的优惠券查看
- ✅ 优惠券数量统计
- ✅ 优惠券使用规则展示

## 📱 页面说明

### 1. 优惠券中心 (`/pages/coupon-center/coupon-center`)
- **功能**: 展示所有可领取的优惠券
- **特点**: 美观的卡片式设计，支持下拉刷新
- **入口**: 首页和"我的"页面的优惠券统计项

### 2. 我的优惠券 (`/pages/coupon/coupon`)
- **功能**: 展示用户已拥有的优惠券
- **特点**: 显示优惠券详细信息和使用规则
- **入口**: 首页和"我的"页面的优惠券统计项

## 🔌 云函数说明

### 1. `claimCoupon` - 优惠券领取
- **功能**: 处理用户领取优惠券请求
- **验证**: 检查优惠券有效性、用户是否已拥有、是否在有效期内
- **返回**: 领取结果和状态信息

### 2. `getActiveCoupons` - 获取可用优惠券
- **功能**: 获取所有可领取的优惠券列表
- **筛选**: 按状态、时间、库存等条件筛选
- **排序**: 按创建时间倒序排列

### 3. `getUserCouponCount` - 获取用户优惠券数量
- **功能**: 统计用户可用的优惠券数量
- **逻辑**: 聚合查询，确保只统计有效且未过期的优惠券
- **性能**: 使用聚合管道优化查询性能

## 🎯 使用场景

### 1. 新用户引导
- 新用户注册后可获得新人优惠券
- 通过优惠券中心引导用户了解产品

### 2. 营销活动
- 节假日发放专属优惠券
- 满减活动配合优惠券使用

### 3. 用户留存
- 定期发放优惠券保持用户活跃
- 根据用户行为发放个性化优惠券

## ⚠️ 注意事项

### 1. 数据一致性
- Web端和小程序端使用相同的数据集合
- 字段名称和格式保持统一

### 2. 性能优化
- 优惠券数量统计使用聚合查询
- 避免频繁的数据库查询

### 3. 用户体验
- 优惠券领取有明确的反馈
- 支持下拉刷新获取最新数据

## 🚀 部署说明

### 1. 云函数部署
```bash
# 部署claimCoupon云函数
cd cloudfunctions/claimCoupon
npm install
# 在微信开发者工具中右键选择"上传并部署：云端安装依赖"
```

### 2. 数据库权限
- `mall_coupons`: 所有用户可读，仅管理端可写
- `user_coupons`: 仅创建者可读写

### 3. 小程序配置
- 确保在`app.json`中添加了优惠券中心页面路由
- 检查云开发环境配置是否正确

## 🔧 维护建议

### 1. 定期清理
- 清理已过期的优惠券记录
- 清理长期未使用的用户优惠券

### 2. 监控告警
- 监控优惠券领取成功率
- 监控数据库查询性能

### 3. 数据分析
- 分析优惠券使用效果
- 优化优惠券发放策略

## 📞 技术支持

如有问题，请检查：
1. 云函数是否正常部署
2. 数据库权限是否正确配置
3. 小程序页面路由是否正确
4. 云开发环境是否正常

---

*最后更新: 2024年12月* 