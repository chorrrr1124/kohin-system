<!--pages/products/products.wxml-->
<view class="page-container">
  <!-- ÊêúÁ¥¢Ê†è -->
  <view class="search-bar">
    <view class="search-input-container">
      <input 
        class="search-input" 
        placeholder="ÊêúÁ¥¢ÂïÜÂìÅ" 
        value="{{searchKeyword}}"
        bindinput="onSearchInput"
        bindconfirm="onSearchConfirm"
      />
      <view class="search-btn" bindtap="onSearchConfirm">
        <text class="iconfont icon-search">üîç</text>
      </view>
    </view>
  </view>

  <!-- Á≠õÈÄâÊ†è -->
  <view class="filter-bar">
    <view class="filter-tabs">
      <view 
        class="filter-tab {{activeFilter === 'all' ? 'active' : ''}}"
        bindtap="onFilterTap"
        data-filter="all"
      >
        ÂÖ®ÈÉ®
      </view>
      <view 
        class="filter-tab {{activeFilter === 'hot' ? 'active' : ''}}"
        bindtap="onFilterTap"
        data-filter="hot"
      >
        ÁÉ≠ÈîÄ
      </view>
      <view 
        class="filter-tab {{activeFilter === 'new' ? 'active' : ''}}"
        bindtap="onFilterTap"
        data-filter="new"
      >
        Êñ∞ÂìÅ
      </view>
      <view 
        class="filter-tab {{activeFilter === 'price' ? 'active' : ''}}"
        bindtap="onSortByPrice"
      >
        ‰ª∑Ê†º {{priceSort === 'asc' ? '‚Üë' : priceSort === 'desc' ? '‚Üì' : ''}}
      </view>
    </view>
  </view>

  <!-- ÂïÜÂìÅÂàóË°® -->
  <view class="products-container">
    <view class="products-grid">
      <block wx:for="{{filteredProducts.length > 0 ? filteredProducts : products}}" wx:key="_id">
        <view 
          class="product-card" 
          bindtap="onProductTap" 
          data-id="{{item._id}}"
        >
          <image-placeholder 
            src="{{item.image}}" 
            type="product"
            custom-class="product-image"
            mode="aspectFill"
            lazy-load="true"
            bind:imageerror="onImageError"
            data-id="{{item._id}}"
            data-index="{{index}}"
          />
          
          <!-- ÂïÜÂìÅÊ†áÁ≠æ -->
          <view class="product-tags" wx:if="{{item.tags && item.tags.length > 0}}">
            <block wx:for="{{item.tags}}" wx:key="*this" wx:for-item="tag">
              <view class="product-tag">{{tag}}</view>
            </block>
          </view>
          
          <view class="product-info">
            <view class="product-name">{{item.productName}}</view>
            <view class="product-spec" wx:if="{{item.specification}}">
              {{item.specification}}
            </view>
            
            <view class="product-price-row">
              <view class="price-container">
                <text class="product-price">¬•{{item.currentPrice || item.price}}</text>
                <text 
                  class="product-original-price" 
                  wx:if="{{item.originalPrice && item.originalPrice > (item.currentPrice || item.price)}}"
                >
                  ¬•{{item.originalPrice}}
                </text>
              </view>
              
              <view class="product-actions">
                <view class="stock-info">
                  <text class="stock-text {{item.stock > 10 ? 'in-stock' : item.stock > 0 ? 'low-stock' : 'out-of-stock'}}">
                    {{item.stock > 10 ? 'ÊúâÂ∫ìÂ≠ò' : item.stock > 0 ? 'Â∫ìÂ≠òÁ¥ßÂº†' : 'Áº∫Ë¥ß'}}
                  </text>
                </view>
                
                <view 
                  class="add-cart-btn {{item.stock <= 0 ? 'disabled' : ''}}"
                  catchtap="onAddToCart"
                  data-id="{{item._id}}"
                >
                  {{item.stock <= 0 ? 'Áº∫Ë¥ß' : 'Âä†Ë¥≠Áâ©ËΩ¶'}}
                </view>
              </view>
            </view>
          </view>
        </view>
      </block>
    </view>
  </view>

  <!-- Âä†ËΩΩÁä∂ÊÄÅ -->
  <view class="loading" wx:if="{{loading}}">
    <text>Âä†ËΩΩ‰∏≠...</text>
  </view>

  <!-- Âä†ËΩΩÊõ¥Â§ö -->
  <view class="load-more" wx:if="{{!loading && hasMore}}" bindtap="loadMoreProducts">
    <text>Âä†ËΩΩÊõ¥Â§ö</text>
  </view>

  <!-- Ê≤°ÊúâÊõ¥Â§ö -->
  <view class="no-more" wx:if="{{!loading && !hasMore && products.length > 0}}">
    <text>Ê≤°ÊúâÊõ¥Â§öÂïÜÂìÅ‰∫Ü</text>
  </view>

  <!-- Á©∫Áä∂ÊÄÅ -->
  <view class="empty" wx:if="{{!loading && products.length === 0}}">
    <view class="empty-icon">üì¶</view>
    <text>{{searchKeyword ? 'Ê≤°ÊúâÊâæÂà∞Áõ∏ÂÖ≥ÂïÜÂìÅ' : 'ÊöÇÊó†ÂïÜÂìÅ'}}</text>
    <view class="empty-btn" bindtap="onBackToHome" wx:if="{{searchKeyword}}">
      ËøîÂõûÈ¶ñÈ°µ
    </view>
  </view>
</view>

<!-- Ëá™ÂÆö‰πâÊ†∑Âºè -->
<style>
.search-bar {
  background-color: #fff;
  padding: 20rpx;
  border-bottom: 2rpx solid #f0f0f0;
}

.search-input-container {
  display: flex;
  align-items: center;
  background-color: #f5f5f5;
  border-radius: 50rpx;
  padding: 0 20rpx;
}

.search-input {
  flex: 1;
  height: 70rpx;
  font-size: 28rpx;
  padding: 0 20rpx;
}

.search-btn {
  width: 60rpx;
  height: 60rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #007aff;
}

.filter-bar {
  background-color: #fff;
  border-bottom: 2rpx solid #f0f0f0;
}

.filter-tabs {
  display: flex;
  padding: 0 20rpx;
}

.filter-tab {
  flex: 1;
  text-align: center;
  padding: 24rpx 0;
  font-size: 28rpx;
  color: #666;
  position: relative;
}

.filter-tab.active {
  color: #007aff;
  font-weight: 600;
}

.filter-tab.active::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 40rpx;
  height: 4rpx;
  background-color: #007aff;
  border-radius: 2rpx;
}

.products-container {
  padding: 20rpx;
}

.products-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20rpx;
}

.product-card {
  background-color: #fff;
  border-radius: 16rpx;
  overflow: hidden;
  box-shadow: 0 2rpx 8rpx rgba(0, 0, 0, 0.1);
  position: relative;
}

.product-image {
  width: 100%;
  height: 240rpx;
}

.product-tags {
  position: absolute;
  top: 10rpx;
  left: 10rpx;
  display: flex;
  gap: 8rpx;
}

.product-tag {
  background-color: rgba(255, 59, 48, 0.9);
  color: #fff;
  font-size: 20rpx;
  padding: 4rpx 8rpx;
  border-radius: 8rpx;
}

.product-info {
  padding: 20rpx;
}

.product-name {
  font-size: 28rpx;
  font-weight: 600;
  color: #1d1d1f;
  margin-bottom: 8rpx;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.product-spec {
  font-size: 24rpx;
  color: #8e8e93;
  margin-bottom: 12rpx;
}

.product-price-row {
  display: flex;
  flex-direction: column;
  gap: 12rpx;
}

.price-container {
  display: flex;
  align-items: baseline;
  gap: 8rpx;
}

.product-price {
  font-size: 32rpx;
  font-weight: 700;
  color: #ff3b30;
}

.product-original-price {
  font-size: 24rpx;
  color: #8e8e93;
  text-decoration: line-through;
}

.product-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.stock-info {
  flex: 1;
}

.stock-text {
  font-size: 22rpx;
}

.stock-text.in-stock {
  color: #34c759;
}

.stock-text.low-stock {
  color: #ff9500;
}

.stock-text.out-of-stock {
  color: #ff3b30;
}

.add-cart-btn {
  background: linear-gradient(135deg, #007aff 0%, #5856d6 100%);
  color: #fff;
  font-size: 22rpx;
  padding: 8rpx 16rpx;
  border-radius: 20rpx;
  white-space: nowrap;
}

.add-cart-btn.disabled {
  background: #d1d1d6;
  color: #8e8e93;
}

.load-more, .no-more {
  text-align: center;
  padding: 40rpx;
  color: #8e8e93;
  font-size: 28rpx;
}

.load-more {
  color: #007aff;
}

.empty-btn {
  margin-top: 30rpx;
  background-color: #007aff;
  color: #fff;
  padding: 20rpx 40rpx;
  border-radius: 50rpx;
  font-size: 28rpx;
}
</style> 