# 商城小程序授权登录功能使用指南

## 功能概述

本指南介绍了为商城小程序实现的美团风格授权登录弹窗功能。该功能提供了专业、美观的用户登录体验，支持微信授权登录和完整的登录状态管理。

## 功能特点

### 🎨 视觉设计
- **美团风格UI**: 底部弹出式设计，符合用户使用习惯
- **渐变背景**: 现代化的渐变色背景，提升视觉体验
- **品牌Logo**: 支持自定义品牌标识显示
- **响应式设计**: 适配不同屏幕尺寸

### 🔐 登录功能
- **微信授权登录**: 集成微信getUserProfile API
- **手机号显示**: 模拟显示用户手机号信息
- **一键登录**: 简化登录流程，提升用户体验
- **登录状态管理**: 完整的登录状态持久化

### 🛡️ 安全特性
- **用户隐私保护**: 遵循微信小程序隐私规范
- **错误处理**: 完善的错误处理和用户提示
- **状态同步**: 登录状态实时同步到全局

## 文件结构

```
components/login-modal/
├── login-modal.wxml     # 弹窗模板文件
├── login-modal.wxss     # 弹窗样式文件
├── login-modal.js       # 弹窗逻辑文件
└── login-modal.json     # 弹窗配置文件

pages/login-test/        # 测试页面
├── login-test.wxml      # 测试页面模板
├── login-test.wxss      # 测试页面样式
├── login-test.js        # 测试页面逻辑
└── login-test.json      # 测试页面配置
```

## 使用方法

### 1. 在页面中引入组件

在页面的 `.json` 配置文件中添加组件引用：

```json
{
  "usingComponents": {
    "login-modal": "/components/login-modal/login-modal"
  }
}
```

### 2. 在页面模板中使用组件

在页面的 `.wxml` 文件中添加登录弹窗组件：

```xml
<!-- 登录弹窗 -->
<login-modal 
  show="{{showLoginModal}}"
  bind:close="onLoginModalClose"
  bind:success="onLoginModalSuccess"
  bind:fail="onLoginModalFail"
  bind:reject="onLoginModalReject"
></login-modal>
```

### 3. 在页面逻辑中处理事件

在页面的 `.js` 文件中添加相关数据和方法：

```javascript
Page({
  data: {
    showLoginModal: false  // 控制弹窗显示
  },

  // 显示登录弹窗
  showLogin() {
    this.setData({
      showLoginModal: true
    });
  },

  // 关闭弹窗
  onLoginModalClose() {
    this.setData({
      showLoginModal: false
    });
  },

  // 登录成功
  onLoginModalSuccess(e) {
    const { userInfo, openid } = e.detail;
    console.log('登录成功:', { userInfo, openid });
    
    this.setData({
      showLoginModal: false
    });
    
    // 处理登录成功后的逻辑
    this.handleLoginSuccess(userInfo, openid);
  },

  // 登录失败
  onLoginModalFail(e) {
    const { error } = e.detail;
    console.error('登录失败:', error);
  },

  // 用户拒绝登录
  onLoginModalReject() {
    this.setData({
      showLoginModal: false
    });
    
    wx.showToast({
      title: '您可以继续浏览，但部分功能需要登录后使用',
      icon: 'none'
    });
  }
});
```

## 组件属性

### Properties

| 属性名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| show | Boolean | false | 控制弹窗显示/隐藏 |

### Events

| 事件名 | 说明 | 回调参数 |
|--------|------|----------|
| close | 弹窗关闭时触发 | - |
| success | 登录成功时触发 | { userInfo, openid } |
| fail | 登录失败时触发 | { error } |
| reject | 用户拒绝登录时触发 | - |

## 集成到现有系统

### 1. 修改 app.js 中的 showLoginModal 方法

原有的系统弹窗已经被替换为使用新的登录组件：

```javascript
// app.js
showLoginModal() {
  const pages = getCurrentPages();
  const currentPage = pages[pages.length - 1];
  
  if (currentPage && currentPage.setData) {
    currentPage.setData({
      showLoginModal: true
    });
  }
}
```

### 2. 在主要页面中添加组件支持

已经在以下页面中集成了登录弹窗组件：
- `pages/index/index` - 首页
- `pages/login-test/login-test` - 测试页面

其他页面可以按照相同方式集成。

## 测试功能

### 访问测试页面

1. 在微信开发者工具中打开小程序
2. 导航到 `pages/login-test/login-test` 页面
3. 点击"显示登录弹窗"按钮测试功能

### 测试场景

1. **正常登录流程**
   - 点击"显示登录弹窗"
   - 点击"手机号一键登录"
   - 授权用户信息
   - 查看登录成功状态

2. **拒绝登录**
   - 点击"显示登录弹窗"
   - 点击"不允许"
   - 查看拒绝提示

3. **清除登录状态**
   - 点击"清除登录状态"
   - 验证状态重置

## 自定义配置

### 修改样式

可以在 `components/login-modal/login-modal.wxss` 中修改：

```css
/* 修改主色调 */
.modal-content {
  background: linear-gradient(135deg, #your-color-1 0%, #your-color-2 100%);
}

/* 修改按钮颜色 */
.login-btn.primary {
  background: linear-gradient(90deg, #your-primary-color 0%, #your-secondary-color 100%);
}
```

### 修改文案

可以在 `components/login-modal/login-modal.wxml` 中修改：

```xml
<view class="title">您的品牌名称</view>
<view class="subtitle">自定义授权说明文案</view>
```

## 注意事项

### 1. 云函数依赖

确保以下云函数已部署：
- `login` - 获取用户openid
- `syncUser` - 同步用户信息到数据库

### 2. 权限配置

在 `app.json` 中确保已配置必要权限：

```json
{
  "permission": {
    "scope.userInfo": {
      "desc": "用于完善用户资料"
    }
  }
}
```

### 3. 隐私协议

根据实际需求修改组件中的用户协议和隐私政策内容。

## 常见问题

### Q: 弹窗不显示？
A: 检查页面是否正确引入组件，以及 `showLoginModal` 数据是否正确设置。

### Q: 登录失败？
A: 检查云函数是否正确部署，网络连接是否正常。

### Q: 样式显示异常？
A: 检查 wxss 文件是否正确加载，可能存在样式冲突。

## 更新日志

### v1.0.0 (2024-01-XX)
- ✨ 新增美团风格登录弹窗组件
- ✨ 支持微信授权登录
- ✨ 完整的登录状态管理
- ✨ 响应式设计适配
- 📝 完善的使用文档和测试页面

---

如有问题或建议，请联系开发团队。