# 数据库初始化指南

## 问题描述

如果您遇到以下错误：
```
404 Not Found
Code: NoSuchKey
Message: The specified key does not exist.
Key: coupons
```

这通常意味着数据库集合还没有被创建。本指南将帮助您解决这个问题。

## 解决方案

### 方案1：运行数据库初始化云函数（推荐）

1. **确保云函数已部署**
   - 检查 `cloudfunctions/initDatabase` 目录是否存在
   - 如果不存在，请先部署该云函数

2. **调用初始化云函数**
   ```javascript
   // 在小程序中调用
   wx.cloud.callFunction({
     name: 'initDatabase',
     success: (res) => {
       console.log('数据库初始化成功:', res);
       wx.showToast({
         title: '数据库初始化成功',
         icon: 'success'
       });
     },
     fail: (err) => {
       console.error('数据库初始化失败:', err);
       wx.showToast({
         title: '初始化失败',
         icon: 'error'
       });
     }
   });
   ```

3. **检查初始化结果**
   - 初始化成功后，会创建以下集合：
     - `coupons` - 小程序端优惠券集合
     - `mall_coupons` - Web端优惠券模板集合
     - `user_coupons` - 用户优惠券关联集合
     - `users` - 用户集合
     - `orders` - 订单集合
     - `products` - 商品集合
     - `categories` - 分类集合
     - `operationLogs` - 操作日志集合
     - `systemSettings` - 系统设置集合

### 方案2：手动创建集合

如果云函数无法使用，可以手动创建必要的集合：

1. **登录微信开发者工具**
2. **打开云开发控制台**
3. **进入数据库页面**
4. **手动创建以下集合**：
   - `coupons`
   - `mall_coupons`
   - `user_coupons`
   - `users`
   - `orders`
   - `products`
   - `categories`

### 方案3：使用通用数据访问云函数

我们已经创建了 `getData` 云函数来绕过免费版本的限制：

1. **确保 `getData` 云函数已部署**
2. **修改代码使用云函数而不是直接访问数据库**

## 测试步骤

1. **运行数据库初始化**
2. **检查集合是否创建成功**
3. **测试优惠券功能**

## 常见问题

### Q: 初始化云函数调用失败怎么办？
A: 检查云函数是否正确部署，确保环境ID配置正确。

### Q: 集合创建后仍然报错怎么办？
A: 检查数据库权限设置，确保小程序有读取权限。

### Q: 免费版本有什么限制？
A: 免费版本可能限制直接数据库访问，建议使用云函数。

## 联系支持

如果问题仍然存在，请：
1. 检查云开发控制台的错误日志
2. 确认云函数部署状态
3. 验证数据库权限配置

## 预防措施

1. **在应用启动时检查数据库状态**
2. **使用云函数而不是直接访问数据库**
3. **实现优雅的错误处理和降级方案**
4. **定期备份重要数据** 