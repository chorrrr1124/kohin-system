# 商城小程序用户隔离功能测试指南

## 功能概述

用户隔离功能确保每个用户只能访问和操作自己的数据，防止数据泄露和越权访问。本指南将帮助您测试和验证用户隔离功能的有效性。

## 已实现的用户隔离功能

### 1. 订单页面隔离
- **位置**: `pages/orders/orders.js`
- **实现**: 通过检查登录状态和openid，调用`getUserOrders`云函数获取当前用户的订单
- **隔离机制**: 云函数使用`wxContext.OPENID`确保只返回当前用户的订单数据

### 2. 个人中心页面隔离
- **位置**: `pages/profile/profile.js`
- **实现**: 通过`_openid`字段查询数据库，确保只获取当前用户的个人信息
- **隔离机制**: 数据库查询条件`{ _openid: openid }`确保数据隔离

### 3. 云函数级别隔离
- **getUserOrders**: 使用`wxContext.OPENID`过滤订单数据
- **syncUser**: 使用`wxContext.OPENID`进行用户信息同步
- **login**: 返回当前用户的openid用于身份识别

## 测试步骤

### 准备工作

1. **确保云函数已部署**
   - 参考《云函数部署指南.md》完成云函数部署
   - 确认`login`、`syncUser`、`getUserOrders`等云函数正常运行

2. **准备测试数据**
   - 在云开发数据库中创建测试用户和订单数据
   - 确保有多个不同用户的数据用于隔离测试

### 测试场景一：登录状态隔离测试

#### 步骤1：未登录状态测试
1. 清除小程序缓存和登录状态
2. 打开订单页面
3. **预期结果**: 显示"请先登录"提示，订单列表为空

#### 步骤2：登录后数据访问测试
1. 使用用户A的微信账号登录
2. 访问订单页面和个人中心
3. **预期结果**: 只显示用户A的订单和个人信息

### 测试场景二：多用户数据隔离测试

#### 步骤1：用户A数据验证
1. 使用用户A登录小程序
2. 记录显示的订单数量和个人信息
3. 在云开发控制台验证数据库中用户A的实际数据

#### 步骤2：切换用户B验证隔离
1. 清除登录状态，使用用户B登录
2. 访问相同页面
3. **预期结果**: 显示的数据与用户A完全不同
4. **验证点**: 订单列表、个人信息、积分余额等都应该是用户B的数据

### 测试场景三：云函数隔离测试

#### 步骤1：直接调用云函数测试
1. 在微信开发者工具的控制台中执行：
```javascript
// 测试获取订单
wx.cloud.callFunction({
  name: 'getUserOrders'
}).then(res => {
  console.log('当前用户订单:', res.result.data)
})
```

2. **验证点**: 返回的订单数据应该只包含当前登录用户的订单

#### 步骤2：云函数日志验证
1. 在云开发控制台查看云函数调用日志
2. 确认每次调用都正确获取了当前用户的openid
3. 验证查询条件中包含正确的用户标识

### 测试场景四：数据库权限测试

#### 步骤1：数据库直接访问测试
1. 在小程序中尝试直接查询数据库：
```javascript
// 尝试查询所有用户数据（应该被限制）
wx.cloud.database().collection('users').get().then(res => {
  console.log('查询结果:', res.data)
})
```

2. **预期结果**: 根据数据库权限设置，应该只能访问当前用户的数据

#### 步骤2：越权访问测试
1. 尝试查询其他用户的数据：
```javascript
// 尝试查询特定用户数据（应该失败）
wx.cloud.database().collection('users').where({
  _openid: 'other-user-openid'
}).get().then(res => {
  console.log('越权查询结果:', res.data)
})
```

2. **预期结果**: 查询应该失败或返回空结果

## 安全检查清单

### ✅ 基础隔离检查
- [ ] 未登录用户无法访问个人数据
- [ ] 登录用户只能看到自己的订单
- [ ] 登录用户只能看到自己的个人信息
- [ ] 不同用户之间数据完全隔离

### ✅ 云函数安全检查
- [ ] 所有云函数都使用`wxContext.OPENID`进行用户识别
- [ ] 云函数查询条件包含用户标识过滤
- [ ] 云函数返回数据不包含其他用户信息
- [ ] 云函数错误处理不泄露敏感信息

### ✅ 数据库安全检查
- [ ] 数据库权限设置正确
- [ ] 用户数据包含正确的`_openid`字段
- [ ] 直接数据库查询受到权限限制
- [ ] 敏感数据字段有适当的访问控制

## 常见问题排查

### Q1: 用户看到了其他用户的数据
**排查步骤**:
1. 检查云函数是否正确使用`wxContext.OPENID`
2. 验证数据库查询条件是否包含用户标识
3. 确认数据库权限设置是否正确
4. 检查前端是否正确处理登录状态

### Q2: 登录后仍然无法访问数据
**排查步骤**:
1. 确认登录流程是否正确获取openid
2. 检查云函数部署状态
3. 验证数据库中是否存在用户数据
4. 查看云函数调用日志

### Q3: 数据显示不一致
**排查步骤**:
1. 清除小程序缓存
2. 检查本地存储和全局数据状态
3. 验证云函数返回的数据格式
4. 确认前端数据绑定逻辑

## 性能监控

### 监控指标
1. **云函数调用延迟**: 用户隔离查询的响应时间
2. **数据库查询效率**: 带用户标识的查询性能
3. **错误率**: 隔离相关的错误发生频率
4. **并发处理**: 多用户同时访问的处理能力

### 优化建议
1. 为`_openid`字段创建数据库索引
2. 使用云函数缓存减少重复查询
3. 实施数据分页减少单次查询量
4. 监控和优化慢查询

## 安全最佳实践

1. **永远不要信任前端数据**: 所有用户身份验证都在云函数中进行
2. **使用白名单而非黑名单**: 明确定义允许的操作而不是禁止的操作
3. **最小权限原则**: 用户只能访问必需的最少数据
4. **定期安全审计**: 定期检查和测试用户隔离功能
5. **日志记录**: 记录所有数据访问操作用于审计

## 测试报告模板

```
测试日期: ____
测试人员: ____
小程序版本: ____

测试结果:
□ 登录状态隔离: 通过/失败
□ 多用户数据隔离: 通过/失败
□ 云函数隔离: 通过/失败
□ 数据库权限: 通过/失败

发现的问题:
1. ____
2. ____

建议改进:
1. ____
2. ____
```

---

完成以上测试后，用户隔离功能应该能够有效保护用户数据安全。如果发现任何问题，请及时修复并重新测试。