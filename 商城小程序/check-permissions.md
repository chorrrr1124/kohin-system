# 云函数权限配置检查指南

## 🔍 问题诊断

根据错误信息 `errCode: -604101 function has no permission to call this API`，这是云函数权限配置问题。

## 🛠 解决方案

### 1. 检查云函数配置文件

确保 `cloudfunctions/decryptPhoneNumber/config.json` 文件存在并包含以下内容：

```json
{
  "permissions": {
    "openapi": [
      "auth.getPhoneNumber"
    ]
  }
}
```

### 2. 重新部署云函数

#### 方法一：使用微信开发者工具
1. 在微信开发者工具中打开项目
2. 右键点击 `cloudfunctions/decryptPhoneNumber` 文件夹
3. 选择 "上传并部署：云端安装依赖"
4. 等待部署完成

#### 方法二：使用云开发CLI
```bash
# 安装云开发CLI
npm install -g @cloudbase/cli

# 登录云开发
tcb login

# 部署云函数
tcb fn deploy decryptPhoneNumber
```

### 3. 检查云开发控制台

1. 登录 [微信云开发控制台](https://mp.weixin.qq.com/)
2. 进入云函数管理页面
3. 找到 `decryptPhoneNumber` 函数
4. 检查函数配置和权限设置

### 4. 验证权限配置

在云开发控制台中：
1. 进入云函数详情页
2. 查看 "权限配置" 部分
3. 确保已开通 "微信API调用" 权限
4. 检查是否包含 `auth.getPhoneNumber` 权限

## 🔧 常见问题

### 问题1：权限配置不生效
**解决方案：**
- 重新部署云函数
- 清除云函数缓存
- 检查云开发环境配置

### 问题2：API调用失败
**解决方案：**
- 确认小程序已开通手机号快速验证功能
- 检查云开发环境ID是否正确
- 验证云函数代码是否正确

### 问题3：code参数错误
**解决方案：**
- 确保code参数格式正确
- 检查code是否已过期
- 验证code来源是否正确

## 📞 调试步骤

### 1. 查看云函数日志
在云开发控制台中查看云函数执行日志，确认：
- 函数是否正常执行
- API调用是否成功
- 错误信息详情

### 2. 测试云函数
使用云开发控制台的测试功能：
1. 进入云函数详情页
2. 点击 "测试" 按钮
3. 输入测试参数
4. 查看执行结果

### 3. 检查网络连接
确保云函数能够正常访问微信API：
- 检查云函数网络配置
- 验证API域名是否可访问
- 确认防火墙设置

## ✅ 验证清单

- [ ] 云函数配置文件存在且正确
- [ ] 云函数已重新部署
- [ ] 权限配置已生效
- [ ] 云开发环境ID正确
- [ ] 小程序已开通相关功能
- [ ] 云函数日志显示正常
- [ ] API调用权限已开通

## 🚀 下一步

完成以上步骤后，重新测试手机号获取功能。如果仍有问题，请查看云函数日志获取更详细的错误信息。 