# 快速修复404错误指南

## 🚨 紧急修复步骤

如果您遇到以下错误：
```
404 Not Found
Code: NoSuchKey
Message: The specified key does not exist.
Key: coupons
```

请按照以下步骤快速修复：

## 步骤1：立即修复代码（5分钟）

### 1.1 修改优惠券页面
我们已经修改了 `pages/coupon/coupon.js`，使其使用云函数而不是直接访问数据库。

### 1.2 检查其他页面
确保所有页面都使用云函数访问数据，而不是直接调用 `wx.cloud.database().collection()`

## 步骤2：部署云函数（10分钟）

### 2.1 部署getData云函数
```bash
# 在微信开发者工具中
# 右键点击 cloudfunctions/getData 目录
# 选择"上传并部署：云端安装依赖"
```

### 2.2 部署initDatabase云函数
```bash
# 右键点击 cloudfunctions/initDatabase 目录
# 选择"上传并部署：云端安装依赖"
```

## 步骤3：初始化数据库（5分钟）

### 3.1 使用调试页面
1. 打开小程序
2. 进入"我的" -> "调试页面"
3. 点击"初始化数据库"按钮
4. 等待初始化完成

### 3.2 手动调用云函数
```javascript
wx.cloud.callFunction({
  name: 'initDatabase',
  success: (res) => {
    console.log('数据库初始化成功:', res);
  },
  fail: (err) => {
    console.error('初始化失败:', err);
  }
});
```

## 步骤4：验证修复（5分钟）

### 4.1 检查集合状态
在调试页面点击"检查集合状态"按钮

### 4.2 测试优惠券功能
1. 进入优惠券页面
2. 检查是否还有404错误
3. 测试优惠券领取功能

## 🔧 根本原因分析

### 问题原因
1. **集合不存在**：`coupons` 集合还没有被创建
2. **直接数据库访问**：代码直接调用数据库，而不是通过云函数
3. **免费版本限制**：CloudBase免费版本可能限制直接数据库访问

### 解决方案
1. **创建必要集合**：通过initDatabase云函数
2. **使用云函数访问**：通过getData云函数
3. **优雅降级**：实现错误处理和用户提示

## 📱 测试清单

- [ ] 数据库初始化成功
- [ ] 所有必要集合已创建
- [ ] 优惠券页面无404错误
- [ ] 优惠券功能正常工作
- [ ] 其他页面无数据库访问错误

## 🚀 预防措施

1. **应用启动检查**：在app.js中检查数据库状态
2. **统一数据访问**：所有数据操作都通过云函数
3. **错误处理**：实现友好的错误提示和重试机制
4. **监控告警**：监控云函数调用状态

## 📞 紧急联系

如果问题仍然存在：
1. 检查云开发控制台错误日志
2. 确认云函数部署状态
3. 验证环境ID配置
4. 检查数据库权限设置

## ⚡ 快速命令

```bash
# 一键部署所有云函数
cd cloudfunctions
for dir in */; do
  echo "部署 $dir"
  # 在微信开发者工具中手动部署每个云函数
done
```

## 🎯 预期结果

修复完成后：
- ✅ 404错误消失
- ✅ 优惠券功能正常
- ✅ 数据库集合完整
- ✅ 应用运行稳定 