# 🗃️ 数据库图片URL清理指南

## 📋 问题描述

如果小程序中出现以下错误：
```
Failed to load image https://via.placeholder.com/300x300?text=%E5%95%86%E5%93%81%E5%9B%BE%E7%89%87
net::ERR_NAME_NOT_RESOLVED
```

这表示数据库中存储了外部的placeholder图片URL，需要进行清理。

## 🔧 解决方案

### 方法1: 使用微信开发者工具控制台

1. 打开微信开发者工具
2. 在控制台中执行以下代码：

```javascript
// 调用清理云函数
wx.cloud.callFunction({
  name: 'cleanupImageUrls',
  success: (res) => {
    console.log('清理结果:', res.result);
    if (res.result.success) {
      console.log('✅ 清理成功:', res.result.message);
    } else {
      console.log('❌ 清理失败:', res.result.message);
    }
  },
  fail: (err) => {
    console.error('❌ 调用失败:', err);
  }
});
```

### 方法2: 在任意页面的JS文件中临时添加

1. 选择任意页面的JS文件（如 `pages/index/index.js`）
2. 在 `onLoad` 函数中临时添加清理代码：

```javascript
onLoad: function() {
  // 临时清理代码 - 使用后请删除
  wx.cloud.callFunction({
    name: 'cleanupImageUrls',
    success: (res) => {
      console.log('清理完成:', res.result);
      wx.showToast({
        title: res.result.success ? '清理成功' : '清理失败',
        icon: res.result.success ? 'success' : 'none'
      });
    }
  });
  
  // 原有的代码...
}
```

3. 重新编译并运行小程序
4. 查看控制台输出确认清理完成
5. **删除临时添加的代码**

## 📦 部署清理云函数

如果云函数还未部署，请按以下步骤操作：

1. 在微信开发者工具中找到 `cloudfunctions/cleanupImageUrls` 文件夹
2. 右键点击该文件夹
3. 选择 **"上传并部署：云端安装依赖"**
4. 等待部署完成

## ✅ 验证清理结果

清理完成后，可以验证：

1. **查看控制台输出**：确认更新了多少个商品
2. **重新加载商品页面**：检查图片是否正常显示
3. **测试获取商品数据**：

```javascript
wx.cloud.callFunction({
  name: 'getShopProducts',
  data: { limit: 5, skip: 0, onSale: true },
  success: (res) => {
    console.log('商品数据:', res.result.data);
    res.result.data.forEach(product => {
      console.log(`${product.name}: ${product.image}`);
    });
  }
});
```

## 🛡️ 预防措施

为避免类似问题再次发生：

1. **使用本地图片路径**：始终使用 `/images/placeholder.png`
2. **数据验证**：在保存商品数据前验证图片URL
3. **错误处理**：所有图片标签都添加 `binderror` 处理
4. **定期检查**：定期检查数据库中的图片URL格式

## 🔍 常见问题

**Q: 清理后图片仍然加载失败？**
A: 请清除开发者工具缓存并重新编译项目

**Q: 云函数调用失败？**
A: 确认云函数已正确部署，检查云开发环境配置

**Q: 需要清理其他集合的数据？**
A: 修改云函数代码，添加其他集合的清理逻辑 