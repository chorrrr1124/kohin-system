# 美团风格登录弹窗实现示例

根据您提供的美团外卖登录弹窗截图，我为您提供了一个类似风格的登录弹窗实现方案。

## 效果预览

参考美团外卖的设计风格：
- 底部弹出的半屏弹窗
- 品牌Logo和名称
- 清晰的权限说明
- 手机号显示（部分隐藏）
- 主要操作按钮和次要操作选项

## 实现方案

### 1. 自定义弹窗组件

**创建 `components/login-modal/login-modal.wxml`**
```xml
<view class="login-modal-mask" wx:if="{{show}}" catchtouchmove="preventTouchMove">
  <view class="login-modal-container" animation="{{animationData}}">
    <!-- 关闭按钮 -->
    <view class="close-btn" bindtap="onClose">
      <text class="close-icon">×</text>
    </view>
    
    <!-- Logo和品牌信息 -->
    <view class="brand-section">
      <image class="brand-logo" src="/images/logo.png" mode="aspectFit"></image>
      <text class="brand-name">{{brandName || '商城小程序'}}</text>
    </view>
    
    <!-- 权限说明 -->
    <view class="permission-section">
      <view class="permission-title">申请获取并验证您的手机号</view>
      <view class="permission-desc">您可以完成注册和登录操作</view>
    </view>
    
    <!-- 手机号显示区域 -->
    <view class="phone-section" wx:if="{{phoneNumber}}">
      <text class="phone-number">{{phoneNumber}}</text>
      <text class="phone-source">上次提供</text>
    </view>
    
    <!-- 操作按钮区域 -->
    <view class="action-section">
      <button class="primary-btn" bindtap="onConfirm" loading="{{loading}}">
        {{confirmText || '手机号一键登录'}}
      </button>
      
      <view class="secondary-actions">
        <text class="secondary-btn" bindtap="onCancel">不允许</text>
        <text class="secondary-btn" bindtap="onUseOther">使用其它号码</text>
      </view>
    </view>
  </view>
</view>
```

**创建 `components/login-modal/login-modal.wxss`**
```css
.login-modal-mask {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 9999;
  display: flex;
  align-items: flex-end;
}

.login-modal-container {
  width: 100%;
  background: #fff;
  border-radius: 20rpx 20rpx 0 0;
  padding: 60rpx 40rpx 80rpx;
  position: relative;
  max-height: 80vh;
}

.close-btn {
  position: absolute;
  top: 30rpx;
  right: 30rpx;
  width: 60rpx;
  height: 60rpx;
  display: flex;
  align-items: center;
  justify-content: center;
}

.close-icon {
  font-size: 40rpx;
  color: #999;
  font-weight: 300;
}

.brand-section {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-bottom: 60rpx;
}

.brand-logo {
  width: 120rpx;
  height: 120rpx;
  border-radius: 24rpx;
  margin-bottom: 20rpx;
}

.brand-name {
  font-size: 32rpx;
  font-weight: 500;
  color: #333;
}

.permission-section {
  text-align: center;
  margin-bottom: 60rpx;
}

.permission-title {
  font-size: 36rpx;
  font-weight: 600;
  color: #333;
  margin-bottom: 20rpx;
  line-height: 1.4;
}

.permission-desc {
  font-size: 28rpx;
  color: #666;
  line-height: 1.4;
}

.phone-section {
  background: #f8f8f8;
  border-radius: 16rpx;
  padding: 40rpx 30rpx;
  margin-bottom: 60rpx;
  text-align: center;
  position: relative;
}

.phone-number {
  font-size: 36rpx;
  font-weight: 500;
  color: #333;
  letter-spacing: 2rpx;
}

.phone-source {
  position: absolute;
  top: 10rpx;
  right: 20rpx;
  font-size: 22rpx;
  color: #999;
  background: #fff;
  padding: 8rpx 16rpx;
  border-radius: 20rpx;
}

.action-section {
  display: flex;
  flex-direction: column;
  gap: 40rpx;
}

.primary-btn {
  width: 100%;
  height: 96rpx;
  background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
  border: none;
  border-radius: 48rpx;
  font-size: 32rpx;
  font-weight: 600;
  color: #333;
  display: flex;
  align-items: center;
  justify-content: center;
}

.primary-btn::after {
  border: none;
}

.secondary-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.secondary-btn {
  font-size: 28rpx;
  color: #666;
  padding: 20rpx;
  position: relative;
}

.secondary-btn:active {
  opacity: 0.6;
}
```

**创建 `components/login-modal/login-modal.js`**
```javascript
Component({
  properties: {
    show: {
      type: Boolean,
      value: false
    },
    brandName: {
      type: String,
      value: '商城小程序'
    },
    phoneNumber: {
      type: String,
      value: ''
    },
    confirmText: {
      type: String,
      value: '手机号一键登录'
    }
  },

  data: {
    animationData: null,
    loading: false
  },

  observers: {
    'show': function(show) {
      this.updateAnimation(show);
    }
  },

  methods: {
    updateAnimation(show) {
      const animation = wx.createAnimation({
        duration: 300,
        timingFunction: 'ease-out'
      });

      if (show) {
        animation.translateY(0).opacity(1).step();
      } else {
        animation.translateY('100%').opacity(0).step();
      }

      this.setData({
        animationData: animation.export()
      });
    },

    preventTouchMove() {
      // 阻止背景滚动
      return false;
    },

    onClose() {
      this.triggerEvent('close');
    },

    async onConfirm() {
      this.setData({ loading: true });
      
      try {
        // 获取手机号授权
        const res = await wx.getPhoneNumber();
        this.triggerEvent('confirm', {
          phoneNumber: res.phoneNumber,
          encryptedData: res.encryptedData,
          iv: res.iv
        });
      } catch (error) {
        console.error('获取手机号失败:', error);
        wx.showToast({
          title: '获取手机号失败',
          icon: 'none'
        });
        this.triggerEvent('error', { error });
      } finally {
        this.setData({ loading: false });
      }
    },

    onCancel() {
      this.triggerEvent('cancel');
    },

    onUseOther() {
      this.triggerEvent('useother');
    }
  }
});
```

**创建 `components/login-modal/login-modal.json`**
```json
{
  "component": true,
  "usingComponents": {}
}
```

### 2. 在 app.js 中集成使用

```javascript
// 修改 showLoginModal 方法
showLoginModal() {
  // 获取当前页面
  const pages = getCurrentPages();
  const currentPage = pages[pages.length - 1];
  
  // 检查当前页面是否支持显示登录弹窗
  if (currentPage && currentPage.showLoginModal) {
    // 获取上次使用的手机号（部分显示）
    const lastPhone = wx.getStorageSync('lastPhoneNumber');
    const maskedPhone = lastPhone ? this.maskPhoneNumber(lastPhone) : '';
    
    currentPage.showLoginModal({
      phoneNumber: maskedPhone,
      onConfirm: this.handleLoginConfirm.bind(this),
      onCancel: this.handleLoginCancel.bind(this),
      onUseOther: this.handleUseOtherPhone.bind(this)
    });
  } else {
    // 降级到原来的 wx.showModal
    this.showSimpleLoginModal();
  }
},

// 手机号掩码处理
maskPhoneNumber(phone) {
  if (!phone || phone.length < 11) return '';
  return phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2');
},

// 处理登录确认
async handleLoginConfirm(data) {
  try {
    // 调用云函数解密手机号并登录
    const result = await wx.cloud.callFunction({
      name: 'phoneLogin',
      data: {
        encryptedData: data.encryptedData,
        iv: data.iv
      }
    });
    
    const { openid, phoneNumber } = result.result;
    
    // 保存登录信息
    this.globalData.openid = openid;
    this.globalData.phoneNumber = phoneNumber;
    this.globalData.isLoggedIn = true;
    
    wx.setStorageSync('openid', openid);
    wx.setStorageSync('phoneNumber', phoneNumber);
    wx.setStorageSync('lastPhoneNumber', phoneNumber);
    wx.setStorageSync('hasEverLoggedIn', true);
    
    wx.showToast({
      title: '登录成功',
      icon: 'success'
    });
    
  } catch (error) {
    console.error('手机号登录失败:', error);
    wx.showToast({
      title: '登录失败，请重试',
      icon: 'none'
    });
  }
},

// 处理取消登录
handleLoginCancel() {
  console.log('用户取消登录');
},

// 处理使用其他手机号
handleUseOtherPhone() {
  // 清除上次手机号记录，重新获取
  wx.removeStorageSync('lastPhoneNumber');
  // 可以跳转到手动输入手机号页面或重新授权
  this.handleLoginConfirm({ encryptedData: null, iv: null });
}
```

### 3. 在页面中使用组件

**在需要显示登录弹窗的页面 JSON 中注册组件：**
```json
{
  "usingComponents": {
    "login-modal": "/components/login-modal/login-modal"
  }
}
```

**在页面 WXML 中添加组件：**
```xml
<login-modal 
  show="{{showLoginModal}}"
  brand-name="商城小程序"
  phone-number="{{maskedPhone}}"
  bind:confirm="onLoginConfirm"
  bind:cancel="onLoginCancel"
  bind:close="onLoginClose"
  bind:useother="onUseOtherPhone"
/>
```

**在页面 JS 中添加相关方法：**
```javascript
Page({
  data: {
    showLoginModal: false,
    maskedPhone: ''
  },

  // 显示登录弹窗
  showLoginModal(options = {}) {
    this.setData({
      showLoginModal: true,
      maskedPhone: options.phoneNumber || ''
    });
    
    // 保存回调函数
    this.loginCallbacks = {
      onConfirm: options.onConfirm,
      onCancel: options.onCancel,
      onUseOther: options.onUseOther
    };
  },

  // 登录确认
  onLoginConfirm(e) {
    const { detail } = e;
    this.setData({ showLoginModal: false });
    
    if (this.loginCallbacks && this.loginCallbacks.onConfirm) {
      this.loginCallbacks.onConfirm(detail);
    }
  },

  // 取消登录
  onLoginCancel() {
    this.setData({ showLoginModal: false });
    
    if (this.loginCallbacks && this.loginCallbacks.onCancel) {
      this.loginCallbacks.onCancel();
    }
  },

  // 关闭弹窗
  onLoginClose() {
    this.setData({ showLoginModal: false });
  },

  // 使用其他手机号
  onUseOtherPhone() {
    if (this.loginCallbacks && this.loginCallbacks.onUseOther) {
      this.loginCallbacks.onUseOther();
    }
  }
});
```

### 4. 云函数支持（phoneLogin）

**创建 `cloudfunctions/phoneLogin/index.js`**
```javascript
const cloud = require('wx-server-sdk');

cloud.init({
  env: cloud.DYNAMIC_CURRENT_ENV
});

const db = cloud.database();

exports.main = async (event, context) => {
  const wxContext = cloud.getWXContext();
  const { encryptedData, iv } = event;
  
  try {
    let phoneNumber = '';
    
    if (encryptedData && iv) {
      // 解密手机号
      const result = await cloud.cloudPay.utils.getOpenData({
        list: [{
          data: encryptedData,
          iv: iv,
          type: 'phoneNumber'
        }]
      });
      
      phoneNumber = result.list[0].data.phoneNumber;
    }
    
    // 查询或创建用户记录
    const userCollection = db.collection('users');
    const userQuery = await userCollection.where({
      _openid: wxContext.OPENID
    }).get();
    
    let userData = {
      _openid: wxContext.OPENID,
      phoneNumber: phoneNumber,
      loginTime: new Date(),
      updateTime: new Date()
    };
    
    if (userQuery.data.length === 0) {
      // 新用户，创建记录
      await userCollection.add({
        data: userData
      });
    } else {
      // 老用户，更新记录
      await userCollection.doc(userQuery.data[0]._id).update({
        data: {
          phoneNumber: phoneNumber,
          loginTime: new Date(),
          updateTime: new Date()
        }
      });
    }
    
    return {
      success: true,
      openid: wxContext.OPENID,
      phoneNumber: phoneNumber
    };
    
  } catch (error) {
    console.error('手机号登录失败:', error);
    return {
      success: false,
      error: error.message
    };
  }
};
```

## 使用说明

1. **组件特点**：
   - 底部弹出动画效果
   - 美团风格的UI设计
   - 支持手机号授权登录
   - 显示上次使用的手机号（部分隐藏）
   - 提供多种操作选项

2. **集成步骤**：
   - 复制组件文件到项目中
   - 在需要的页面注册并使用组件
   - 创建对应的云函数处理手机号登录
   - 在 app.js 中集成弹窗逻辑

3. **自定义选项**：
   - 品牌名称和Logo
   - 按钮文案
   - 颜色主题
   - 动画效果

这个实现方案完全参考了美团外卖的设计风格，提供了更好的用户体验和视觉效果。