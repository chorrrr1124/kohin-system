# 腾讯云模板部署指南

## 错误分析

您遇到的新错误：
```
Error: TencentCloud API error: {
    "Response": {
        "Error": {
            "Code": "ResourceNotFound.Function",
            "Message": "未找到指定的Function，请创建后再试。"
        }
    }
}
```

**错误原因：** 云函数还没有在腾讯云环境中创建，需要先部署云函数。

## 解决方案一：使用腾讯云模板快速创建

### 1. 访问腾讯云控制台

1. 打开 [腾讯云控制台](https://console.cloud.tencent.com/tcb)
2. 登录您的腾讯云账号
3. 选择云开发环境：`cloudbase-3g4w6lls8a5ce59b`

### 2. 使用云函数模板

#### 2.1 创建登录云函数
1. 进入「云函数」页面
2. 点击「新建」
3. 选择「微信支付用户手机号」模板（适用于用户认证）
4. 函数名称：`login`
5. 运行环境：`Node.js 16.13`
6. 点击「下一步」

#### 2.2 替换函数代码
将模板代码替换为我们的 login 云函数代码：

```javascript
const cloud = require('wx-server-sdk')

cloud.init({
  env: cloud.DYNAMIC_CURRENT_ENV
})

const db = cloud.database()

exports.main = async (event, context) => {
  const wxContext = cloud.getWXContext()
  const { OPENID } = wxContext
  
  if (!OPENID) {
    return {
      success: false,
      message: '获取用户信息失败'
    }
  }
  
  try {
    // 检查用户是否已存在
    const userQuery = await db.collection('users').where({
      _openid: OPENID
    }).get()
    
    if (userQuery.data.length === 0) {
      // 创建新用户
      await db.collection('users').add({
        data: {
          _openid: OPENID,
          createTime: new Date(),
          lastLoginTime: new Date(),
          userInfo: event.userInfo || {}
        }
      })
    } else {
      // 更新最后登录时间
      await db.collection('users').doc(userQuery.data[0]._id).update({
        data: {
          lastLoginTime: new Date(),
          userInfo: event.userInfo || userQuery.data[0].userInfo
        }
      })
    }
    
    return {
      success: true,
      openid: OPENID,
      message: '登录成功'
    }
  } catch (error) {
    console.error('登录失败:', error)
    return {
      success: false,
      message: '登录失败，请重试'
    }
  }
}
```

#### 2.3 创建用户同步云函数
1. 重复上述步骤，创建 `syncUser` 云函数
2. 选择「用户管理 SQL 模板」
3. 替换为我们的 syncUser 代码

#### 2.4 创建订单查询云函数
1. 创建 `getUserOrders` 云函数
2. 选择「文章管理模板」（适用于数据查询）
3. 替换为我们的 getUserOrders 代码

### 3. 配置云函数依赖

在每个云函数的 `package.json` 中添加：
```json
{
  "name": "login",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "dependencies": {
    "wx-server-sdk": "^3.0.1"
  }
}
```

## 解决方案二：直接上传现有云函数

### 1. 使用微信开发者工具

#### 方法一：右键上传
1. 在微信开发者工具中打开项目
2. 右键点击 `cloudfunctions/login` 文件夹
3. 选择「上传并部署：云端安装依赖（不上传 node_modules）」
4. 等待部署完成

#### 方法二：批量上传
1. 右键点击 `cloudfunctions` 文件夹
2. 选择「同步云函数列表」
3. 选择需要上传的云函数
4. 点击「上传」

### 2. 使用命令行工具

#### 安装 TCB CLI
```bash
npm install -g @cloudbase/cli
```

#### 登录并部署
```bash
# 登录
tcb login

# 切换到项目目录
cd "商城小程序"

# 部署云函数
tcb functions:deploy login --envId cloudbase-3g4w6lls8a5ce59b
tcb functions:deploy syncUser --envId cloudbase-3g4w6lls8a5ce59b
tcb functions:deploy getUserOrders --envId cloudbase-3g4w6lls8a5ce59b
```

## 解决方案三：使用腾讯云 Web 控制台

### 1. 手动创建云函数

1. 访问 [腾讯云云函数控制台](https://console.cloud.tencent.com/scf)
2. 选择地域（与云开发环境一致）
3. 点击「新建」
4. 选择「从头开始」
5. 函数名称：`login`
6. 运行环境：`Node.js 16.13`
7. 复制粘贴云函数代码
8. 点击「完成」

### 2. 配置触发器

1. 在云函数详情页面
2. 点击「触发管理」
3. 点击「创建触发器」
4. 触发方式：「云开发触发」
5. 事件：「云函数调用」

## 数据库配置

### 1. 创建数据库集合

在腾讯云控制台中：
1. 进入「数据库」页面
2. 点击「创建集合」
3. 创建以下集合：
   - `users`（用户信息）
   - `orders`（订单信息）

### 2. 设置权限

为每个集合设置权限：
- 权限类型：「仅创建者可读写」
- 这确保了用户数据隔离

## 验证部署

### 1. 检查云函数状态

在腾讯云控制台中：
1. 进入「云函数」页面
2. 确认以下函数已部署：
   - ✅ login
   - ✅ syncUser
   - ✅ getUserOrders

### 2. 测试云函数

1. 点击云函数名称进入详情
2. 点击「测试」
3. 输入测试数据
4. 查看执行结果

### 3. 查看日志

1. 在云函数详情页面
2. 点击「日志查询」
3. 查看执行日志和错误信息

## 常见问题解决

### Q1: 权限不足
**错误信息：** `Access denied`
**解决方案：**
- 确认腾讯云账号有云开发权限
- 检查小程序与腾讯云账号的关联

### Q2: 环境不存在
**错误信息：** `Environment not found`
**解决方案：**
- 确认环境 ID 正确：`cloudbase-3g4w6lls8a5ce59b`
- 检查云开发服务是否正常

### Q3: 依赖安装失败
**错误信息：** `npm install failed`
**解决方案：**
- 使用「云端安装依赖」选项
- 检查 package.json 格式
- 确认网络连接正常

## 推荐部署流程

### 优先级顺序：
1. **微信开发者工具**（最简单）
2. **腾讯云模板**（快速创建）
3. **命令行工具**（批量操作）
4. **Web 控制台**（精细控制）

### 部署检查清单：
- [ ] 云函数代码已上传
- [ ] 依赖已正确安装
- [ ] 数据库集合已创建
- [ ] 权限已正确配置
- [ ] 云函数测试通过
- [ ] 小程序调用正常

---

**注意：** 使用腾讯云模板可以快速创建云函数框架，但需要替换为我们的具体业务代码。建议优先使用微信开发者工具进行部署，这是最直接和可靠的方法。