# 🧹 清除小程序缓存指南

## 问题说明
如果遇到图片加载失败或显示旧的外部图片URL错误，可能是小程序缓存或数据库中的外部URL导致的。

## 解决方案

### 🔧 1. 使用调试工具清理数据库（推荐）
1. 在微信开发者工具中，切换到 `pages/debug/debug` 页面
2. 点击 **🧹 清理图片URL** 按钮
3. 观察日志输出，确认清理完成
4. 点击 **📦 测试获取商品** 按钮验证数据

### 2. 清除微信开发者工具缓存
1. 在微信开发者工具中点击 **工具** > **清缓存**
2. 选择 **清除全部缓存**
3. 重新编译项目

### 3. 清除手机端小程序缓存
1. 在手机微信中删除小程序
2. 重新扫码进入小程序

### 4. 强制刷新数据
在小程序中下拉刷新页面，触发数据重新加载

### 5. 检查网络设置
确保 `project.config.json` 中设置了：
```json
{
  "setting": {
    "urlCheck": false
  }
}
```

## 已修复的问题

✅ 替换所有外部图片URL为本地路径
✅ 添加图片错误处理机制
✅ 修复中文字符编码问题
✅ 添加全局图片URL验证
✅ 创建数据库清理云函数
✅ 修复商品列表图片显示逻辑

## 新增功能

🔧 **调试工具页面** (`pages/debug/debug`)
- 一键清理数据库中的外部图片URL
- 测试商品数据获取功能
- 实时日志监控

🧹 **数据库清理云函数** (`cleanupImageUrls`)
- 自动检测并替换外部placeholder URL
- 支持 `image`、`imagePath`、`images` 字段
- 批量更新商品数据

## 预防措施

- 所有图片都使用本地路径 `/images/placeholder.png`
- 添加了 `binderror` 事件处理图片加载失败
- 在app.js中添加了全局图片URL验证函数
- 商品列表正确显示过滤后的商品数据

## 部署步骤

1. **部署清理云函数**：
   ```bash
   # 在微信开发者工具中右键 cloudfunctions/cleanupImageUrls
   # 选择 "上传并部署：云端安装依赖"
   ```

2. **运行清理工具**：
   - 访问调试页面：`pages/debug/debug`
   - 点击"清理图片URL"按钮

3. **验证修复**：
   - 重新加载商品页面
   - 检查图片是否正常显示 