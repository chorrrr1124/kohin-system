# 商城小程序数据库权限配置指南

## 数据库集合列表

商城小程序需要以下数据库集合，请确保在云开发控制台中创建：

### 核心集合（必需）

| 集合名称 | 用途 | 权限设置 | 索引建议 |
|---------|------|----------|----------|
| `shopProducts` | 商品信息 | 所有用户可读，仅管理员可写 | category, onSale, createdAt |
| `users` | 用户信息 | 仅创建者及管理员可读写 | openid, phone |
| `orders` | 订单信息 | 仅创建者及管理员可读写 | userId, status, createdAt |
| `banners` | 轮播图 | 所有用户可读，仅管理员可写 | sort, isActive |
| `categories` | 商品分类 | 所有用户可读，仅管理员可写 | sort, isActive |

### 功能集合（推荐）

| 集合名称 | 用途 | 权限设置 | 索引建议 |
|---------|------|----------|----------|
| `userCart` | 购物车 | 仅创建者及管理员可读写 | userId |
| `coupons` | 优惠券模板 | 所有用户可读，仅管理员可写 | isActive, validUntil |
| `userCoupons` | 用户优惠券 | 仅创建者及管理员可读写 | userId, couponId, status |
| `homepageConfig` | 首页配置 | 所有用户可读，仅管理员可写 | configKey |

## 权限配置步骤

### 第一步：创建数据库集合

1. 打开微信开发者工具
2. 点击「云开发」按钮
3. 进入「数据库」页面
4. 点击「+」创建集合
5. 按照上表创建所有必需的集合

### 第二步：配置集合权限

**方法一：使用预设权限模板**

对于每个集合，点击「设置」→「权限设置」，选择合适的权限模板：

```
商品相关集合（shopProducts, banners, categories）：
✅ 选择「所有用户可读，仅创建者及管理员可写」

用户相关集合（users, orders, userCart, userCoupons）：
✅ 选择「仅创建者及管理员可读写」

配置相关集合（homepageConfig, coupons）：
✅ 选择「所有用户可读，仅管理员可写」
```

**方法二：自定义权限规则**

如果需要更精细的权限控制，可以使用自定义规则：

```javascript
// shopProducts 集合权限规则
{
  "read": true,  // 所有用户可读
  "write": "auth.uid != null && auth.uid == 'ADMIN_UID'"  // 仅管理员可写
}

// users 集合权限规则
{
  "read": "auth.uid == doc.openid",  // 仅用户本人可读
  "write": "auth.uid == doc.openid"  // 仅用户本人可写
}

// orders 集合权限规则
{
  "read": "auth.uid == doc.userId",  // 仅订单所有者可读
  "write": "auth.uid == doc.userId"  // 仅订单所有者可写
}

// userCart 集合权限规则
{
  "read": "auth.uid == doc.userId",  // 仅购物车所有者可读
  "write": "auth.uid == doc.userId"  // 仅购物车所有者可写
}
```

### 第三步：创建数据库索引

为了提高查询性能，建议为以下字段创建索引：

**shopProducts 集合索引：**
```javascript
// 复合索引
{ "category": 1, "onSale": 1 }
{ "createdAt": -1 }
{ "price": 1 }
{ "sales": -1 }
```

**orders 集合索引：**
```javascript
// 复合索引
{ "userId": 1, "status": 1 }
{ "userId": 1, "createdAt": -1 }
{ "status": 1, "createdAt": -1 }
```

**users 集合索引：**
```javascript
// 单字段索引
{ "openid": 1 }
{ "phone": 1 }
```

**创建索引的步骤：**
1. 在数据库集合页面点击「索引管理」
2. 点击「添加索引」
3. 输入索引字段和排序方式
4. 点击「确定」创建

## 数据库安全规则

### 基本安全原则

1. **最小权限原则**：用户只能访问自己的数据
2. **数据验证**：在云函数中验证数据格式和内容
3. **敏感信息保护**：不在客户端存储敏感信息
4. **访问日志**：启用数据库访问日志监控

### 推荐的安全配置

```javascript
// 通用安全规则模板
{
  // 读权限：用户只能读取自己的数据
  "read": "auth.uid != null && (auth.uid == doc.userId || auth.uid == doc.openid)",
  
  // 写权限：用户只能修改自己的数据，且不能修改关键字段
  "write": "auth.uid != null && auth.uid == doc.userId && !('userId' in resource.data) && !('createdAt' in resource.data)"
}
```

## 数据初始化脚本

### 在云开发控制台执行

```javascript
// 初始化商品分类
db.collection('categories').add({
  data: [
    { name: '热销商品', key: 'hot', sort: 1, isActive: true },
    { name: '新品推荐', key: 'new', sort: 2, isActive: true },
    { name: '特价商品', key: 'sale', sort: 3, isActive: true },
    { name: '精选好物', key: 'featured', sort: 4, isActive: true }
  ]
});

// 初始化轮播图
db.collection('banners').add({
  data: [
    {
      imageUrl: '/images/banner1.jpg',
      title: '新品上市',
      linkType: 'product',
      linkValue: '',
      sort: 1,
      isActive: true
    },
    {
      imageUrl: '/images/banner2.jpg', 
      title: '限时特惠',
      linkType: 'category',
      linkValue: 'sale',
      sort: 2,
      isActive: true
    }
  ]
});

// 初始化首页配置
db.collection('homepageConfig').add({
  data: {
    configKey: 'homepage',
    showBanners: true,
    showCategories: true,
    showHotProducts: true,
    showNewProducts: true,
    maxProductsPerSection: 10
  }
});
```

## 权限验证测试

### 测试步骤

1. **登录测试**
   ```javascript
   // 在小程序中测试用户登录
   wx.cloud.callFunction({
     name: 'login',
     success: res => {
       console.log('登录成功:', res);
     }
   });
   ```

2. **数据读取测试**
   ```javascript
   // 测试商品数据读取
   wx.cloud.callFunction({
     name: 'getShopProducts',
     data: { limit: 10 },
     success: res => {
       console.log('商品数据:', res.result);
     }
   });
   ```

3. **权限边界测试**
   ```javascript
   // 测试用户是否能访问他人数据
   db.collection('orders').where({
     userId: 'other_user_id'  // 尝试访问他人订单
   }).get().then(res => {
     console.log('应该返回空结果:', res.data);
   });
   ```

## 常见权限问题解决

### 问题1：Permission denied
**错误信息：** `Permission denied. User does not have permission to access this resource`

**解决方案：**
```
1. 检查集合权限设置是否正确
2. 确认用户已正确登录
3. 验证权限规则语法
4. 检查字段名称是否匹配
```

### 问题2：数据无法写入
**错误信息：** `Write operation failed`

**解决方案：**
```
1. 检查写权限配置
2. 确认数据格式符合规则
3. 验证必需字段是否完整
4. 检查数据类型是否正确
```

### 问题3：查询结果为空
**错误信息：** 查询返回空数组

**解决方案：**
```
1. 确认数据已正确初始化
2. 检查查询条件是否正确
3. 验证索引是否生效
4. 检查权限是否允许读取
```

## 监控和维护

### 性能监控

1. **查询性能**
   - 监控慢查询
   - 优化索引配置
   - 分析查询模式

2. **存储使用**
   - 监控存储容量
   - 清理无用数据
   - 优化数据结构

3. **访问频率**
   - 分析热点数据
   - 优化缓存策略
   - 调整权限规则

### 定期维护任务

```javascript
// 清理过期数据的云函数示例
exports.main = async (event, context) => {
  const db = cloud.database();
  const _ = db.command;
  
  // 清理过期优惠券
  await db.collection('userCoupons').where({
    validUntil: _.lt(new Date()),
    status: 'unused'
  }).update({
    data: { status: 'expired' }
  });
  
  // 清理临时购物车数据
  const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
  await db.collection('userCart').where({
    updatedAt: _.lt(thirtyDaysAgo)
  }).remove();
  
  return { success: true };
};
```

## 🚨 免费体验版特殊配置

### 问题说明
CloudBase免费体验版对某些数据访问功能有限制，可能导致权限配置后仍然无法正常读取数据。

### 解决方案

#### 方案1：使用最宽松权限（临时解决）
```javascript
// 对于所有集合，使用最宽松的权限设置
{
  "read": true,   // 所有用户可读
  "write": true   // 所有用户可写（注意：生产环境不推荐）
}
```

#### 方案2：通过云函数访问（推荐）
由于免费版本限制，建议所有数据访问都通过云函数进行：

1. **创建数据访问云函数**
```javascript
// cloudfunctions/getData/index.js
const cloud = require('wx-server-sdk')
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV })
const db = cloud.database()

exports.main = async (event, context) => {
  const { collection, where = {}, limit = 20 } = event
  
  try {
    const result = await db.collection(collection)
      .where(where)
      .limit(limit)
      .get()
    
    return {
      success: true,
      data: result.data
    }
  } catch (error) {
    return {
      success: false,
      error: error.message
    }
  }
}
```

2. **前端调用云函数而非直接访问数据库**
```javascript
// 不要这样做（可能被免费版本限制）
wx.cloud.database().collection('products').get()

// 应该这样做
wx.cloud.callFunction({
  name: 'getData',
  data: { collection: 'products' }
})
```

#### 方案3：升级套餐
如果业务需要，建议升级到付费版本以获得完整的数据访问权限。

### 免费版本权限配置建议

```javascript
// 所有集合使用相同权限
{
  "read": true,
  "write": "auth != null"  // 登录用户可写
}
```

---

**配置完成后，您的数据库就具备了完善的权限控制和性能优化！**

如有问题，请参考微信云开发官方文档或联系技术支持。