# å•†åŸå°ç¨‹åºæ•°æ®åº“æƒé™é…ç½®æŒ‡å—

## æ•°æ®åº“é›†åˆåˆ—è¡¨

å•†åŸå°ç¨‹åºéœ€è¦ä»¥ä¸‹æ•°æ®åº“é›†åˆï¼Œè¯·ç¡®ä¿åœ¨äº‘å¼€å‘æ§åˆ¶å°ä¸­åˆ›å»ºï¼š

### æ ¸å¿ƒé›†åˆï¼ˆå¿…éœ€ï¼‰

| é›†åˆåç§° | ç”¨é€” | æƒé™è®¾ç½® | ç´¢å¼•å»ºè®® |
|---------|------|----------|----------|
| `shopProducts` | å•†å“ä¿¡æ¯ | æ‰€æœ‰ç”¨æˆ·å¯è¯»ï¼Œä»…ç®¡ç†å‘˜å¯å†™ | category, onSale, createdAt |
| `users` | ç”¨æˆ·ä¿¡æ¯ | ä»…åˆ›å»ºè€…åŠç®¡ç†å‘˜å¯è¯»å†™ | openid, phone |
| `orders` | è®¢å•ä¿¡æ¯ | ä»…åˆ›å»ºè€…åŠç®¡ç†å‘˜å¯è¯»å†™ | userId, status, createdAt |
| `banners` | è½®æ’­å›¾ | æ‰€æœ‰ç”¨æˆ·å¯è¯»ï¼Œä»…ç®¡ç†å‘˜å¯å†™ | sort, isActive |
| `categories` | å•†å“åˆ†ç±» | æ‰€æœ‰ç”¨æˆ·å¯è¯»ï¼Œä»…ç®¡ç†å‘˜å¯å†™ | sort, isActive |

### åŠŸèƒ½é›†åˆï¼ˆæ¨èï¼‰

| é›†åˆåç§° | ç”¨é€” | æƒé™è®¾ç½® | ç´¢å¼•å»ºè®® |
|---------|------|----------|----------|
| `userCart` | è´­ç‰©è½¦ | ä»…åˆ›å»ºè€…åŠç®¡ç†å‘˜å¯è¯»å†™ | userId |
| `coupons` | ä¼˜æƒ åˆ¸æ¨¡æ¿ | æ‰€æœ‰ç”¨æˆ·å¯è¯»ï¼Œä»…ç®¡ç†å‘˜å¯å†™ | isActive, validUntil |
| `userCoupons` | ç”¨æˆ·ä¼˜æƒ åˆ¸ | ä»…åˆ›å»ºè€…åŠç®¡ç†å‘˜å¯è¯»å†™ | userId, couponId, status |
| `homepageConfig` | é¦–é¡µé…ç½® | æ‰€æœ‰ç”¨æˆ·å¯è¯»ï¼Œä»…ç®¡ç†å‘˜å¯å†™ | configKey |

## æƒé™é…ç½®æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºæ•°æ®åº“é›†åˆ

1. æ‰“å¼€å¾®ä¿¡å¼€å‘è€…å·¥å…·
2. ç‚¹å‡»ã€Œäº‘å¼€å‘ã€æŒ‰é’®
3. è¿›å…¥ã€Œæ•°æ®åº“ã€é¡µé¢
4. ç‚¹å‡»ã€Œ+ã€åˆ›å»ºé›†åˆ
5. æŒ‰ç…§ä¸Šè¡¨åˆ›å»ºæ‰€æœ‰å¿…éœ€çš„é›†åˆ

### ç¬¬äºŒæ­¥ï¼šé…ç½®é›†åˆæƒé™

**æ–¹æ³•ä¸€ï¼šä½¿ç”¨é¢„è®¾æƒé™æ¨¡æ¿**

å¯¹äºæ¯ä¸ªé›†åˆï¼Œç‚¹å‡»ã€Œè®¾ç½®ã€â†’ã€Œæƒé™è®¾ç½®ã€ï¼Œé€‰æ‹©åˆé€‚çš„æƒé™æ¨¡æ¿ï¼š

```
å•†å“ç›¸å…³é›†åˆï¼ˆshopProducts, banners, categoriesï¼‰ï¼š
âœ… é€‰æ‹©ã€Œæ‰€æœ‰ç”¨æˆ·å¯è¯»ï¼Œä»…åˆ›å»ºè€…åŠç®¡ç†å‘˜å¯å†™ã€

ç”¨æˆ·ç›¸å…³é›†åˆï¼ˆusers, orders, userCart, userCouponsï¼‰ï¼š
âœ… é€‰æ‹©ã€Œä»…åˆ›å»ºè€…åŠç®¡ç†å‘˜å¯è¯»å†™ã€

é…ç½®ç›¸å…³é›†åˆï¼ˆhomepageConfig, couponsï¼‰ï¼š
âœ… é€‰æ‹©ã€Œæ‰€æœ‰ç”¨æˆ·å¯è¯»ï¼Œä»…ç®¡ç†å‘˜å¯å†™ã€
```

**æ–¹æ³•äºŒï¼šè‡ªå®šä¹‰æƒé™è§„åˆ™**

å¦‚æœéœ€è¦æ›´ç²¾ç»†çš„æƒé™æ§åˆ¶ï¼Œå¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰è§„åˆ™ï¼š

```javascript
// shopProducts é›†åˆæƒé™è§„åˆ™
{
  "read": true,  // æ‰€æœ‰ç”¨æˆ·å¯è¯»
  "write": "auth.uid != null && auth.uid == 'ADMIN_UID'"  // ä»…ç®¡ç†å‘˜å¯å†™
}

// users é›†åˆæƒé™è§„åˆ™
{
  "read": "auth.uid == doc.openid",  // ä»…ç”¨æˆ·æœ¬äººå¯è¯»
  "write": "auth.uid == doc.openid"  // ä»…ç”¨æˆ·æœ¬äººå¯å†™
}

// orders é›†åˆæƒé™è§„åˆ™
{
  "read": "auth.uid == doc.userId",  // ä»…è®¢å•æ‰€æœ‰è€…å¯è¯»
  "write": "auth.uid == doc.userId"  // ä»…è®¢å•æ‰€æœ‰è€…å¯å†™
}

// userCart é›†åˆæƒé™è§„åˆ™
{
  "read": "auth.uid == doc.userId",  // ä»…è´­ç‰©è½¦æ‰€æœ‰è€…å¯è¯»
  "write": "auth.uid == doc.userId"  // ä»…è´­ç‰©è½¦æ‰€æœ‰è€…å¯å†™
}
```

### ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºæ•°æ®åº“ç´¢å¼•

ä¸ºäº†æé«˜æŸ¥è¯¢æ€§èƒ½ï¼Œå»ºè®®ä¸ºä»¥ä¸‹å­—æ®µåˆ›å»ºç´¢å¼•ï¼š

**shopProducts é›†åˆç´¢å¼•ï¼š**
```javascript
// å¤åˆç´¢å¼•
{ "category": 1, "onSale": 1 }
{ "createdAt": -1 }
{ "price": 1 }
{ "sales": -1 }
```

**orders é›†åˆç´¢å¼•ï¼š**
```javascript
// å¤åˆç´¢å¼•
{ "userId": 1, "status": 1 }
{ "userId": 1, "createdAt": -1 }
{ "status": 1, "createdAt": -1 }
```

**users é›†åˆç´¢å¼•ï¼š**
```javascript
// å•å­—æ®µç´¢å¼•
{ "openid": 1 }
{ "phone": 1 }
```

**åˆ›å»ºç´¢å¼•çš„æ­¥éª¤ï¼š**
1. åœ¨æ•°æ®åº“é›†åˆé¡µé¢ç‚¹å‡»ã€Œç´¢å¼•ç®¡ç†ã€
2. ç‚¹å‡»ã€Œæ·»åŠ ç´¢å¼•ã€
3. è¾“å…¥ç´¢å¼•å­—æ®µå’Œæ’åºæ–¹å¼
4. ç‚¹å‡»ã€Œç¡®å®šã€åˆ›å»º

## æ•°æ®åº“å®‰å…¨è§„åˆ™

### åŸºæœ¬å®‰å…¨åŸåˆ™

1. **æœ€å°æƒé™åŸåˆ™**ï¼šç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
2. **æ•°æ®éªŒè¯**ï¼šåœ¨äº‘å‡½æ•°ä¸­éªŒè¯æ•°æ®æ ¼å¼å’Œå†…å®¹
3. **æ•æ„Ÿä¿¡æ¯ä¿æŠ¤**ï¼šä¸åœ¨å®¢æˆ·ç«¯å­˜å‚¨æ•æ„Ÿä¿¡æ¯
4. **è®¿é—®æ—¥å¿—**ï¼šå¯ç”¨æ•°æ®åº“è®¿é—®æ—¥å¿—ç›‘æ§

### æ¨èçš„å®‰å…¨é…ç½®

```javascript
// é€šç”¨å®‰å…¨è§„åˆ™æ¨¡æ¿
{
  // è¯»æƒé™ï¼šç”¨æˆ·åªèƒ½è¯»å–è‡ªå·±çš„æ•°æ®
  "read": "auth.uid != null && (auth.uid == doc.userId || auth.uid == doc.openid)",
  
  // å†™æƒé™ï¼šç”¨æˆ·åªèƒ½ä¿®æ”¹è‡ªå·±çš„æ•°æ®ï¼Œä¸”ä¸èƒ½ä¿®æ”¹å…³é”®å­—æ®µ
  "write": "auth.uid != null && auth.uid == doc.userId && !('userId' in resource.data) && !('createdAt' in resource.data)"
}
```

## æ•°æ®åˆå§‹åŒ–è„šæœ¬

### åœ¨äº‘å¼€å‘æ§åˆ¶å°æ‰§è¡Œ

```javascript
// åˆå§‹åŒ–å•†å“åˆ†ç±»
db.collection('categories').add({
  data: [
    { name: 'çƒ­é”€å•†å“', key: 'hot', sort: 1, isActive: true },
    { name: 'æ–°å“æ¨è', key: 'new', sort: 2, isActive: true },
    { name: 'ç‰¹ä»·å•†å“', key: 'sale', sort: 3, isActive: true },
    { name: 'ç²¾é€‰å¥½ç‰©', key: 'featured', sort: 4, isActive: true }
  ]
});

// åˆå§‹åŒ–è½®æ’­å›¾
db.collection('banners').add({
  data: [
    {
      imageUrl: '/images/banner1.jpg',
      title: 'æ–°å“ä¸Šå¸‚',
      linkType: 'product',
      linkValue: '',
      sort: 1,
      isActive: true
    },
    {
      imageUrl: '/images/banner2.jpg', 
      title: 'é™æ—¶ç‰¹æƒ ',
      linkType: 'category',
      linkValue: 'sale',
      sort: 2,
      isActive: true
    }
  ]
});

// åˆå§‹åŒ–é¦–é¡µé…ç½®
db.collection('homepageConfig').add({
  data: {
    configKey: 'homepage',
    showBanners: true,
    showCategories: true,
    showHotProducts: true,
    showNewProducts: true,
    maxProductsPerSection: 10
  }
});
```

## æƒé™éªŒè¯æµ‹è¯•

### æµ‹è¯•æ­¥éª¤

1. **ç™»å½•æµ‹è¯•**
   ```javascript
   // åœ¨å°ç¨‹åºä¸­æµ‹è¯•ç”¨æˆ·ç™»å½•
   wx.cloud.callFunction({
     name: 'login',
     success: res => {
       console.log('ç™»å½•æˆåŠŸ:', res);
     }
   });
   ```

2. **æ•°æ®è¯»å–æµ‹è¯•**
   ```javascript
   // æµ‹è¯•å•†å“æ•°æ®è¯»å–
   wx.cloud.callFunction({
     name: 'getShopProducts',
     data: { limit: 10 },
     success: res => {
       console.log('å•†å“æ•°æ®:', res.result);
     }
   });
   ```

3. **æƒé™è¾¹ç•Œæµ‹è¯•**
   ```javascript
   // æµ‹è¯•ç”¨æˆ·æ˜¯å¦èƒ½è®¿é—®ä»–äººæ•°æ®
   db.collection('orders').where({
     userId: 'other_user_id'  // å°è¯•è®¿é—®ä»–äººè®¢å•
   }).get().then(res => {
     console.log('åº”è¯¥è¿”å›ç©ºç»“æœ:', res.data);
   });
   ```

## å¸¸è§æƒé™é—®é¢˜è§£å†³

### é—®é¢˜1ï¼šPermission denied
**é”™è¯¯ä¿¡æ¯ï¼š** `Permission denied. User does not have permission to access this resource`

**è§£å†³æ–¹æ¡ˆï¼š**
```
1. æ£€æŸ¥é›†åˆæƒé™è®¾ç½®æ˜¯å¦æ­£ç¡®
2. ç¡®è®¤ç”¨æˆ·å·²æ­£ç¡®ç™»å½•
3. éªŒè¯æƒé™è§„åˆ™è¯­æ³•
4. æ£€æŸ¥å­—æ®µåç§°æ˜¯å¦åŒ¹é…
```

### é—®é¢˜2ï¼šæ•°æ®æ— æ³•å†™å…¥
**é”™è¯¯ä¿¡æ¯ï¼š** `Write operation failed`

**è§£å†³æ–¹æ¡ˆï¼š**
```
1. æ£€æŸ¥å†™æƒé™é…ç½®
2. ç¡®è®¤æ•°æ®æ ¼å¼ç¬¦åˆè§„åˆ™
3. éªŒè¯å¿…éœ€å­—æ®µæ˜¯å¦å®Œæ•´
4. æ£€æŸ¥æ•°æ®ç±»å‹æ˜¯å¦æ­£ç¡®
```

### é—®é¢˜3ï¼šæŸ¥è¯¢ç»“æœä¸ºç©º
**é”™è¯¯ä¿¡æ¯ï¼š** æŸ¥è¯¢è¿”å›ç©ºæ•°ç»„

**è§£å†³æ–¹æ¡ˆï¼š**
```
1. ç¡®è®¤æ•°æ®å·²æ­£ç¡®åˆå§‹åŒ–
2. æ£€æŸ¥æŸ¥è¯¢æ¡ä»¶æ˜¯å¦æ­£ç¡®
3. éªŒè¯ç´¢å¼•æ˜¯å¦ç”Ÿæ•ˆ
4. æ£€æŸ¥æƒé™æ˜¯å¦å…è®¸è¯»å–
```

## ç›‘æ§å’Œç»´æŠ¤

### æ€§èƒ½ç›‘æ§

1. **æŸ¥è¯¢æ€§èƒ½**
   - ç›‘æ§æ…¢æŸ¥è¯¢
   - ä¼˜åŒ–ç´¢å¼•é…ç½®
   - åˆ†ææŸ¥è¯¢æ¨¡å¼

2. **å­˜å‚¨ä½¿ç”¨**
   - ç›‘æ§å­˜å‚¨å®¹é‡
   - æ¸…ç†æ— ç”¨æ•°æ®
   - ä¼˜åŒ–æ•°æ®ç»“æ„

3. **è®¿é—®é¢‘ç‡**
   - åˆ†æçƒ­ç‚¹æ•°æ®
   - ä¼˜åŒ–ç¼“å­˜ç­–ç•¥
   - è°ƒæ•´æƒé™è§„åˆ™

### å®šæœŸç»´æŠ¤ä»»åŠ¡

```javascript
// æ¸…ç†è¿‡æœŸæ•°æ®çš„äº‘å‡½æ•°ç¤ºä¾‹
exports.main = async (event, context) => {
  const db = cloud.database();
  const _ = db.command;
  
  // æ¸…ç†è¿‡æœŸä¼˜æƒ åˆ¸
  await db.collection('userCoupons').where({
    validUntil: _.lt(new Date()),
    status: 'unused'
  }).update({
    data: { status: 'expired' }
  });
  
  // æ¸…ç†ä¸´æ—¶è´­ç‰©è½¦æ•°æ®
  const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
  await db.collection('userCart').where({
    updatedAt: _.lt(thirtyDaysAgo)
  }).remove();
  
  return { success: true };
};
```

## ğŸš¨ å…è´¹ä½“éªŒç‰ˆç‰¹æ®Šé…ç½®

### é—®é¢˜è¯´æ˜
CloudBaseå…è´¹ä½“éªŒç‰ˆå¯¹æŸäº›æ•°æ®è®¿é—®åŠŸèƒ½æœ‰é™åˆ¶ï¼Œå¯èƒ½å¯¼è‡´æƒé™é…ç½®åä»ç„¶æ— æ³•æ­£å¸¸è¯»å–æ•°æ®ã€‚

### è§£å†³æ–¹æ¡ˆ

#### æ–¹æ¡ˆ1ï¼šä½¿ç”¨æœ€å®½æ¾æƒé™ï¼ˆä¸´æ—¶è§£å†³ï¼‰
```javascript
// å¯¹äºæ‰€æœ‰é›†åˆï¼Œä½¿ç”¨æœ€å®½æ¾çš„æƒé™è®¾ç½®
{
  "read": true,   // æ‰€æœ‰ç”¨æˆ·å¯è¯»
  "write": true   // æ‰€æœ‰ç”¨æˆ·å¯å†™ï¼ˆæ³¨æ„ï¼šç”Ÿäº§ç¯å¢ƒä¸æ¨èï¼‰
}
```

#### æ–¹æ¡ˆ2ï¼šé€šè¿‡äº‘å‡½æ•°è®¿é—®ï¼ˆæ¨èï¼‰
ç”±äºå…è´¹ç‰ˆæœ¬é™åˆ¶ï¼Œå»ºè®®æ‰€æœ‰æ•°æ®è®¿é—®éƒ½é€šè¿‡äº‘å‡½æ•°è¿›è¡Œï¼š

1. **åˆ›å»ºæ•°æ®è®¿é—®äº‘å‡½æ•°**
```javascript
// cloudfunctions/getData/index.js
const cloud = require('wx-server-sdk')
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV })
const db = cloud.database()

exports.main = async (event, context) => {
  const { collection, where = {}, limit = 20 } = event
  
  try {
    const result = await db.collection(collection)
      .where(where)
      .limit(limit)
      .get()
    
    return {
      success: true,
      data: result.data
    }
  } catch (error) {
    return {
      success: false,
      error: error.message
    }
  }
}
```

2. **å‰ç«¯è°ƒç”¨äº‘å‡½æ•°è€Œéç›´æ¥è®¿é—®æ•°æ®åº“**
```javascript
// ä¸è¦è¿™æ ·åšï¼ˆå¯èƒ½è¢«å…è´¹ç‰ˆæœ¬é™åˆ¶ï¼‰
wx.cloud.database().collection('products').get()

// åº”è¯¥è¿™æ ·åš
wx.cloud.callFunction({
  name: 'getData',
  data: { collection: 'products' }
})
```

#### æ–¹æ¡ˆ3ï¼šå‡çº§å¥—é¤
å¦‚æœä¸šåŠ¡éœ€è¦ï¼Œå»ºè®®å‡çº§åˆ°ä»˜è´¹ç‰ˆæœ¬ä»¥è·å¾—å®Œæ•´çš„æ•°æ®è®¿é—®æƒé™ã€‚

### å…è´¹ç‰ˆæœ¬æƒé™é…ç½®å»ºè®®

```javascript
// æ‰€æœ‰é›†åˆä½¿ç”¨ç›¸åŒæƒé™
{
  "read": true,
  "write": "auth != null"  // ç™»å½•ç”¨æˆ·å¯å†™
}
```

---

**é…ç½®å®Œæˆåï¼Œæ‚¨çš„æ•°æ®åº“å°±å…·å¤‡äº†å®Œå–„çš„æƒé™æ§åˆ¶å’Œæ€§èƒ½ä¼˜åŒ–ï¼**

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒå¾®ä¿¡äº‘å¼€å‘å®˜æ–¹æ–‡æ¡£æˆ–è”ç³»æŠ€æœ¯æ”¯æŒã€‚