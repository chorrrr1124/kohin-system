# 优惠券数量统计功能更新说明

## 功能概述

本次更新实现了首页和"我的"页面中优惠券数量的自动统计功能，并添加了点击跳转到优惠券页面的功能。

## 主要更新内容

### 1. 新增云函数：getUserCouponCount

- **功能**：统计用户当前可用的优惠券数量
- **位置**：`cloudfunctions/getUserCouponCount/`
- **逻辑**：查询 `user_coupons` 集合中状态为 `unused` 且未过期的优惠券数量

### 2. 首页优惠券数量统计

- **位置**：`pages/index/index.js`
- **更新**：
  - 添加 `loadUserCouponCount()` 方法
  - 在 `refreshUserInfo()` 中调用优惠券数量统计
  - 删除静态优惠券数据，改为动态获取

### 3. "我的"页面优惠券数量统计

- **位置**：`pages/profile/profile.js`
- **更新**：
  - 添加 `loadUserCouponCount()` 方法
  - 在 `refreshUserInfo()` 中调用优惠券数量统计
  - 删除静态优惠券数据，改为动态获取
  - 添加 `onCouponTap()` 方法处理点击事件

### 4. 优惠券页面数据源更新

- **位置**：`pages/coupon/coupon.js`
- **更新**：
  - 删除静态优惠券数据
  - 修改 `loadCoupons()` 方法从 `user_coupons` 集合获取数据
  - 新增 `loadCouponDetails()` 方法获取优惠券详情
  - 数据来源改为真实的云数据库

### 5. 点击跳转功能

- **首页**：悬浮用户卡片中的优惠券区域点击后跳转到优惠券页面
- **我的页面**：我的资产卡片中的优惠券区域点击后跳转到优惠券页面

## 技术实现

### 数据流程

1. 用户进入首页或"我的"页面
2. 调用 `getUserCouponCount` 云函数
3. 云函数查询 `user_coupons` 集合
4. 返回可用优惠券数量
5. 前端更新显示

### 数据库集合

- `mall_coupons`：优惠券主表，存储优惠券基本信息
- `user_coupons`：用户优惠券表，存储用户领取的优惠券

### 权限设置

- `mall_coupons`：仅管理员可写，所有用户可读
- `user_coupons`：用户可读写自己的优惠券

## 部署说明

### 云函数部署

```bash
cd 商城小程序/cloudfunctions/getUserCouponCount
npm install
# 在微信开发者工具中右键选择"上传并部署：云端安装依赖"
```

### 前端更新

前端代码已更新完成，无需额外部署。

## 测试验证

### 功能测试

1. 进入首页，检查优惠券数量是否正确显示
2. 进入"我的"页面，检查优惠券数量是否正确显示
3. 点击优惠券区域，验证是否跳转到优惠券页面
4. 在优惠券页面检查是否显示真实的优惠券数据

### 数据验证

1. 检查云函数日志，确认查询正常
2. 检查数据库集合，确认数据结构正确
3. 验证优惠券数量统计的准确性

## 注意事项

1. 确保云开发环境已正确配置
2. 确保数据库集合已创建并设置正确的权限
3. 优惠券数量统计基于 `status: 'unused'` 和 `expireTime` 字段
4. 首次使用可能需要创建测试数据

## 后续优化建议

1. 添加优惠券数量缓存机制，减少云函数调用
2. 实现优惠券过期自动清理
3. 添加优惠券使用状态实时更新
4. 优化优惠券列表的加载性能 