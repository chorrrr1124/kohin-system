# 商城小程序云函数部署指南

## 问题诊断

您遇到的商城页面问题很可能是由于云函数未部署导致的。根据错误分析，需要部署以下关键云函数：

## 必需部署的云函数

### 1. 核心云函数（必须部署）
- `getShopProducts` - 获取商城商品数据
- `login` - 用户登录
- `syncUser` - 同步用户信息

### 2. 商城功能云函数（推荐部署）
- `getProductDetail` - 获取商品详情
- `getBanners` - 获取轮播图
- `getCategories` - 获取商品分类
- `submitOrder` - 提交订单
- `getUserOrders` - 获取用户订单
- `updateOrderStatus` - 更新订单状态

### 3. 购物车功能云函数
- `getUserCart` - 获取用户购物车
- `updateUserCart` - 更新购物车

### 4. 优惠券功能云函数
- `getActiveCoupons` - 获取活动优惠券
- `claimCoupon` - 领取优惠券
- `getUserCouponCount` - 获取用户优惠券数量

## 部署步骤

### 方法一：使用微信开发者工具（推荐）

1. **打开微信开发者工具**
   - 导入项目：`商城小程序`
   - 确认AppID配置正确

2. **配置云开发环境**
   - 点击工具栏中的「云开发」按钮
   - 确认环境ID：`cloudbase-3g4w6lls8a5ce59b`

3. **批量部署云函数**
   按以下顺序部署（重要性从高到低）：

   **第一批：核心功能**
   ```
   1. 右键 cloudfunctions/login 文件夹
   2. 选择「上传并部署：云端安装依赖（不上传 node_modules）」
   3. 等待部署完成
   
   重复上述步骤部署：
   - syncUser
   - getShopProducts
   ```

   **第二批：商城功能**
   ```
   - getProductDetail
   - getBanners
   - getCategories
   - submitOrder
   - getUserOrders
   ```

   **第三批：购物车和优惠券**
   ```
   - getUserCart
   - updateUserCart
   - getActiveCoupons
   - claimCoupon
   ```

### 方法二：使用云开发CLI工具

```bash
# 安装CLI工具
npm install -g @cloudbase/cli

# 登录
tcb login

# 进入项目目录
cd "C:\Users\chor\Desktop\code\finish\商城小程序"

# 批量部署云函数
tcb functions:deploy login
tcb functions:deploy syncUser
tcb functions:deploy getShopProducts
tcb functions:deploy getProductDetail
tcb functions:deploy getBanners
tcb functions:deploy getCategories
```

## 验证部署

### 1. 检查云函数状态
1. 在微信开发者工具中点击「云开发」
2. 进入「云函数」页面
3. 确认以下函数显示为「正常」状态：
   - ✅ login
   - ✅ syncUser
   - ✅ getShopProducts
   - ✅ getProductDetail

### 2. 测试商城页面
1. 在小程序中导航到商品列表页面
2. 检查是否能正常加载商品数据
3. 查看开发者工具控制台是否还有错误

### 3. 检查数据库
1. 在云开发控制台进入「数据库」
2. 确认存在以下集合：
   - `shopProducts` - 商城商品数据
   - `users` - 用户信息
   - `orders` - 订单信息
   - `banners` - 轮播图数据

## 常见问题解决

### Q1: 部署时提示权限错误
**解决方案：**
- 确认微信开发者工具已登录正确账号
- 确认账号有该小程序的开发权限
- 检查云开发环境是否已开通

### Q2: 云函数部署成功但调用失败
**解决方案：**
1. 检查云函数代码是否有语法错误
2. 查看云函数执行日志
3. 确认数据库集合权限设置正确

### Q3: 商品数据加载失败
**解决方案：**
1. 确认 `shopProducts` 集合存在且有数据
2. 检查集合权限设置为「所有用户可读，仅管理员可写」
3. 验证商品数据格式是否正确

### Q4: 图片显示异常
**解决方案：**
1. 确认图片路径正确
2. 检查 `image-placeholder` 组件是否正确注册
3. 验证图片文件是否存在于小程序包中

## 数据库权限配置

在云开发控制台的「数据库」→「权限设置」中配置：

```json
{
  "shopProducts": "所有用户可读，仅管理员可写",
  "users": "仅创建者可读写",
  "orders": "仅创建者可读写",
  "banners": "所有用户可读，仅管理员可写",
  "categories": "所有用户可读，仅管理员可写",
  "coupons": "所有用户可读，仅管理员可写",
  "user_coupons": "仅创建者可读写"
}
```

## 部署完成检查清单

- [ ] login 云函数部署成功
- [ ] syncUser 云函数部署成功
- [ ] getShopProducts 云函数部署成功
- [ ] getProductDetail 云函数部署成功
- [ ] getBanners 云函数部署成功
- [ ] 数据库集合权限配置正确
- [ ] 商城页面能正常加载商品
- [ ] 图片显示正常
- [ ] 购物车功能正常
- [ ] 订单功能正常

## 联系支持

如果按照以上步骤操作后问题仍然存在，请：
1. 查看微信开发者工具控制台的详细错误信息
2. 检查云开发控制台的云函数执行日志
3. 确认网络连接正常
4. 参考微信小程序云开发官方文档

---

**重要提示：** 必须先完成核心云函数（login、syncUser、getShopProducts）的部署，商城页面才能正常工作。建议按照优先级顺序逐步部署，每部署一个云函数后都进行测试验证。