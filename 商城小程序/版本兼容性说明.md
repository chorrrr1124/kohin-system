# 版本兼容性解决方案

## 问题描述

在微信小程序中获取用户手机号时，可能会遇到版本兼容性问题，导致无法直接通过微信API获取手机号。

## 解决方案

### 1. 自动检测与降级

系统会自动检测以下情况：
- 微信版本过低
- 基础库版本不支持 `wx.getPhoneNumber` API
- 用户拒绝授权
- 其他获取失败的情况

### 2. 手动输入降级方案

当自动获取失败时，系统会提供手动输入手机号的降级方案：

1. **手机号输入**：用户手动输入11位手机号
2. **格式验证**：系统验证手机号格式是否正确
3. **发送验证码**：调用云函数发送短信验证码
4. **验证码验证**：用户输入6位验证码进行验证
5. **完成登录**：验证成功后完成用户登录流程

### 3. 云函数支持

#### sendSmsCode 云函数
- 功能：发送短信验证码
- 参数：`phoneNumber`（手机号）、`type`（验证码类型）
- 返回：验证码发送状态

#### verifySmsCode 云函数
- 功能：验证短信验证码
- 参数：`phoneNumber`（手机号）、`code`（验证码）、`type`（验证码类型）
- 返回：验证结果和用户信息

### 4. 数据库设计

#### sms_codes 集合
```javascript
{
  phoneNumber: "手机号",
  code: "验证码",
  type: "验证码类型",
  expireTime: "过期时间",
  createTime: "创建时间",
  openid: "用户openid",
  used: "是否已使用"
}
```

#### users 集合
```javascript
{
  phoneNumber: "手机号",
  openid: "用户openid",
  unionid: "用户unionid",
  lastLoginTime: "最后登录时间",
  createTime: "创建时间"
}
```

## 技术实现

### 版本检测逻辑
```javascript
// 检查是否支持获取手机号
if (!wx.getPhoneNumber) {
  console.log('wx.getPhoneNumber API 不存在，使用降级方案');
  this.showFallbackOption();
  return;
}

// 检查基础库版本
if (this.compareVersion(SDKVersion, '2.19.0') < 0) {
  console.log('基础库版本过低，使用降级方案');
  this.showFallbackOption();
  return;
}
```

### 降级流程
1. 显示降级提示弹窗
2. 用户选择手动输入
3. 弹出手机号输入框
4. 验证手机号格式
5. 发送验证码
6. 弹出验证码输入框
7. 验证验证码
8. 完成登录流程

## 部署说明

### 1. 部署云函数
```bash
# 部署发送验证码云函数
cd cloudfunctions/sendSmsCode
npm install
# 在微信开发者工具中右键选择"上传并部署：云端安装依赖"

# 部署验证验证码云函数
cd cloudfunctions/verifySmsCode
npm install
# 在微信开发者工具中右键选择"上传并部署：云端安装依赖"
```

### 2. 创建数据库集合
在云开发控制台中创建以下集合：
- `sms_codes`：存储短信验证码
- `users`：存储用户信息

### 3. 配置短信服务（可选）
如需真实发送短信，需要：
1. 申请短信服务（如腾讯云短信、阿里云短信）
2. 在 `sendSmsCode` 云函数中配置短信服务参数
3. 注释掉开发环境下的验证码显示代码

## 测试建议

### 1. 开发环境测试
- 使用微信开发者工具测试
- 查看控制台日志确认流程
- 验证码会在弹窗中显示（仅开发环境）

### 2. 真机测试
- 在真机上测试完整流程
- 验证版本兼容性检测
- 测试降级方案是否正常工作

### 3. 错误处理测试
- 测试手机号格式错误
- 测试验证码错误
- 测试网络异常情况

## 注意事项

1. **安全性**：生产环境必须配置真实的短信服务
2. **用户体验**：提供清晰的错误提示和操作指引
3. **性能优化**：验证码有效期设置为5分钟，避免频繁发送
4. **数据清理**：定期清理过期的验证码记录
5. **隐私保护**：严格遵守用户隐私政策，合理使用用户信息

## 更新日志

### v2.0.0 (2024-01-XX)
- 新增手动输入手机号降级方案
- 新增短信验证码功能
- 优化版本兼容性检测逻辑
- 新增云函数支持
- 完善错误处理和用户体验 