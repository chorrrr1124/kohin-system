# 快速开发指南

## 环境准备

### 1. 必需工具

- **微信开发者工具** (最新版本)
- **Node.js** (v16.13+)
- **Git** (版本控制)
- **VS Code** (推荐编辑器)

### 2. 账号准备

- 微信小程序账号 (已认证)
- 腾讯云账号 (开通云开发服务)
- 微信支付商户号 (如需支付功能)

## 项目初始化

### 1. 克隆项目

```bash
# 克隆项目到本地
git clone <项目地址>
cd finish
```

### 2. 配置云开发环境

1. 打开微信开发者工具
2. 导入项目 `完成版小程序后台8.7`
3. 在云开发控制台创建环境
4. 记录环境ID: `cloudbase-3g4w6lls8a5ce59b`

### 3. 初始化数据库

```javascript
// 在微信开发者工具中执行
// 1. 部署 createCollection 云函数
// 2. 在云开发控制台创建以下集合：

const collections = [
  'users',           // 用户信息
  'customers',       // 客户信息
  'products',        // 产品信息
  'shopProducts',    // 商城产品
  'orders',          // 订单信息
  'prepaidRecords',  // 预存记录
  'banners',         // 轮播图
  'coupons',         // 优惠券
  'homepageConfig',  // 首页配置
  'admins'           // 管理员
]
```

## 项目配置

### 1. 小程序配置

#### 完成版小程序后台8.7

```json
// project.config.json
{
  "appid": "your-backend-appid",
  "projectname": "产品库存管理",
  "cloudfunctionRoot": "cloudfunctions/"
}
```

#### 商城小程序

```json
// project.config.json  
{
  "appid": "your-mall-appid",
  "projectname": "KOHIN高品蔻洇商城",
  "cloudfunctionRoot": "cloudfunctions/"
}
```

### 2. Web端配置

```bash
cd web7.27/miniprogram-admin

# 安装依赖
npm install

# 配置云开发
# 修改 src/utils/cloudbase.js
export const app = cloudbase.init({
  env: 'cloudbase-3g4w6lls8a5ce59b'
})

# 启动开发服务器
npm run dev
```

## 开发流程

### 1. 后台管理小程序开发

```bash
# 1. 打开微信开发者工具
# 2. 导入 完成版小程序后台8.7
# 3. 配置AppID和云环境
# 4. 部署云函数
# 5. 预览测试
```

**主要功能开发顺序：**

1. 用户登录认证
2. 产品管理 (增删改查)
3. 库存管理 (入库出库)
4. 客户管理 (客户信息维护)
5. 订单管理 (下单流程)
6. 预存管理 (充值消费)

### 2. 商城小程序开发

```bash
# 1. 导入 商城小程序 项目
# 2. 配置独立的AppID
# 3. 实现用户隔离逻辑
# 4. 开发商城功能
```

**开发重点：**

```javascript
// 用户隔离示例
const getUserOrders = async () => {
  const { OPENID } = cloud.getWXContext()
  return await db.collection('orders')
    .where({ 
      userId: OPENID,  // 关键：用户隔离
      status: _.neq('deleted')
    })
    .orderBy('createTime', 'desc')
    .get()
}
```

### 3. Web端后台开发

```bash
cd web7.27/miniprogram-admin

# 开发模式
npm run dev

# 构建生产版本  
npm run build
```

**开发重点：**

- 响应式设计 (TailwindCSS)
- 组件化开发 (React)
- 状态管理 (React Hooks)
- 路由管理 (React Router)

## 核心功能实现

### 1. 用户认证

```javascript
// 小程序登录
wx.cloud.callFunction({
  name: 'login',
  success: res => {
    const { openid } = res.result
    // 保存用户信息
    wx.setStorageSync('userInfo', { openid })
  }
})

// Web端登录
const login = async (username, password) => {
  // 实现管理员登录逻辑
  const result = await app.callFunction({
    name: 'adminLogin',
    data: { username, password }
  })
  
  if (result.success) {
    localStorage.setItem('admin_logged_in', '1')
  }
}
```

### 2. 数据操作

```javascript
// 添加产品
const addProduct = async (productData) => {
  try {
    const result = await db.collection('products').add({
      data: {
        ...productData,
        createTime: db.serverDate(),
        updateTime: db.serverDate()
      }
    })
    return { success: true, id: result._id }
  } catch (error) {
    console.error('添加产品失败:', error)
    return { success: false, error }
  }
}

// 更新库存
const updateStock = async (productId, quantity, operation) => {
  const _ = db.command
  const updateData = operation === 'add' 
    ? { stock: _.inc(quantity) }
    : { stock: _.inc(-quantity) }
    
  return await db.collection('products')
    .doc(productId)
    .update({ data: updateData })
}
```

### 3. 订单处理

```javascript
// 创建订单
const createOrder = async (orderData) => {
  const db = cloud.database()
  const _ = db.command
  
  try {
    // 开始事务
    const transaction = await db.startTransaction()
    
    // 1. 创建订单
    const orderResult = await transaction.collection('orders').add({
      data: {
        ...orderData,
        orderNo: generateOrderNo(),
        status: 'pending',
        createTime: db.serverDate()
      }
    })
    
    // 2. 更新库存
    for (const item of orderData.items) {
      await transaction.collection('products')
        .doc(item.productId)
        .update({
          data: { stock: _.inc(-item.quantity) }
        })
    }
    
    // 3. 提交事务
    await transaction.commit()
    
    return { success: true, orderId: orderResult._id }
  } catch (error) {
    await transaction.rollback()
    return { success: false, error }
  }
}
```

## 调试技巧

### 1. 小程序调试

```javascript
// 开启调试模式
wx.setEnableDebug({
  enableDebug: true
})

// 云函数调试
console.log('[云函数] 参数:', event)
console.log('[云函数] 用户信息:', cloud.getWXContext())

// 数据库调试
const result = await db.collection('test').get()
console.log('[数据库] 查询结果:', result)
```

### 2. Web端调试

```javascript
// 开发环境配置
if (process.env.NODE_ENV === 'development') {
  console.log('开发模式')
  // 开启详细日志
}

// 网络请求调试
const callFunction = async (name, data) => {
  console.log(`[云函数] 调用 ${name}:`, data)
  const result = await app.callFunction({ name, data })
  console.log(`[云函数] ${name} 结果:`, result)
  return result
}
```

### 3. 常见问题解决

```javascript
// 1. 权限问题
// 检查数据库权限设置
// 确保云函数有正确的读写权限

// 2. 用户隔离问题
// 确保所有查询都包含用户标识
const { OPENID } = cloud.getWXContext()
if (!OPENID) {
  return { success: false, message: '用户未登录' }
}

// 3. 数据一致性问题
// 使用事务处理关键操作
// 添加重试机制
```

## 部署上线

### 1. 小程序发布

```bash
# 1. 在微信开发者工具中
# 2. 点击"上传"按钮
# 3. 填写版本号和项目备注
# 4. 在微信公众平台提交审核
# 5. 审核通过后发布
```

### 2. Web端部署

```bash
# 构建生产版本
npm run build

# 部署到服务器
# 可以使用腾讯云静态网站托管
# 或其他CDN服务
```

### 3. 云函数部署

```bash
# 在微信开发者工具中
# 1. 右键云函数目录
# 2. 选择"上传并部署：云端安装依赖"
# 3. 等待部署完成
```

## 性能优化

### 1. 数据库优化

```javascript
// 1. 添加索引
// 在云开发控制台为常用查询字段添加索引

// 2. 分页查询
const getProducts = async (page = 1, limit = 20) => {
  const skip = (page - 1) * limit
  return await db.collection('products')
    .skip(skip)
    .limit(limit)
    .get()
}

// 3. 字段筛选
const getProductList = async () => {
  return await db.collection('products')
    .field({ name: true, price: true, stock: true })
    .get()
}
```

### 2. 图片优化

```javascript
// 图片压缩上传
const uploadImage = async (filePath) => {
  // 先压缩图片
  const compressedPath = await compressImage(filePath)
  
  // 上传到云存储
  const result = await wx.cloud.uploadFile({
    cloudPath: `images/${Date.now()}.jpg`,
    filePath: compressedPath
  })
  
  return result.fileID
}
```

### 3. 缓存策略

```javascript
// 本地缓存
const getCachedData = (key, fetchFunction, expireTime = 300000) => {
  const cached = wx.getStorageSync(key)
  const now = Date.now()
  
  if (cached && (now - cached.timestamp) < expireTime) {
    return Promise.resolve(cached.data)
  }
  
  return fetchFunction().then(data => {
    wx.setStorageSync(key, {
      data,
      timestamp: now
    })
    return data
  })
}
```

## 监控告警

### 1. 错误监控

```javascript
// 全局错误处理
App({
  onError(error) {
    console.error('[小程序错误]', error)
    // 上报错误信息
    wx.cloud.callFunction({
      name: 'reportError',
      data: { error, timestamp: Date.now() }
    })
  }
})

// 云函数错误处理
exports.main = async (event, context) => {
  try {
    // 业务逻辑
    return { success: true, data: result }
  } catch (error) {
    console.error('[云函数错误]', error)
    return { 
      success: false, 
      error: error.message,
      timestamp: Date.now()
    }
  }
}
```

### 2. 性能监控

```javascript
// 接口性能监控
const performanceMonitor = (functionName) => {
  return async (event, context) => {
    const startTime = Date.now()
    
    try {
      const result = await originalFunction(event, context)
      const duration = Date.now() - startTime
      
      // 记录性能数据
      if (duration > 3000) { // 超过3秒告警
        console.warn(`[性能告警] ${functionName} 执行时间: ${duration}ms`)
      }
      
      return result
    } catch (error) {
      const duration = Date.now() - startTime
      console.error(`[错误] ${functionName} 执行失败, 耗时: ${duration}ms`, error)
      throw error
    }
  }
}
```

## 团队协作

### 1. Git工作流

```bash
# 功能开发流程
git checkout -b feature/new-feature
# 开发功能
git add .
git commit -m "feat: 添加新功能"
git push origin feature/new-feature
# 创建Pull Request

# 发布流程
git checkout main
git merge feature/new-feature
git tag v1.0.0
git push origin main --tags
```

### 2. 代码规范

```javascript
// 使用ESLint配置
// .eslintrc.js
module.exports = {
  extends: ['eslint:recommended'],
  rules: {
    'no-console': 'warn',
    'no-unused-vars': 'error',
    'prefer-const': 'error'
  }
}

// 提交规范
// feat: 新功能
// fix: 修复bug
// docs: 文档更新
// style: 代码格式
// refactor: 重构
// test: 测试
```

## 常见问题FAQ

### Q1: 云函数调用失败？

**A:** 检查以下几点：
1. 云函数是否正确部署
2. 权限配置是否正确
3. 参数格式是否正确
4. 网络连接是否正常

### Q2: 数据库查询为空？

**A:** 检查以下几点：
1. 集合是否存在
2. 查询条件是否正确
3. 权限设置是否允许读取
4. 数据是否真实存在

### Q3: 用户隔离不生效？

**A:** 确保：
1. 所有查询都包含用户标识
2. 使用`cloud.getWXContext()`获取OpenID
3. 在云函数中进行权限验证

### Q4: 图片上传失败？

**A:** 检查：
1. 文件大小是否超限
2. 文件格式是否支持
3. 云存储权限配置
4. 网络连接状态

---

**开发愉快！如有问题请查阅详细文档或联系开发团队。**