# 商城系统综合开发文档

## 项目概述

本项目是一个完整的商城生态系统，包含三个核心模块：

1. **完成版小程序后台8.7** - 内部管理小程序
2. **商城小程序** - 面向用户的商城小程序
3. **web7.27** - Web端后台管理系统

## 技术架构

### 核心技术栈

- **数据库**: 腾讯云开发 CloudBase
- **开发工具**: 微信开发者工具
- **前端框架**: 
  - 小程序: 微信小程序原生框架 + TDesign组件库
  - Web端: React 18 + Vite + TailwindCSS + DaisyUI
- **后端**: 腾讯云函数 (Node.js)
- **存储**: 腾讯云对象存储 COS

### 云环境配置

```json
{
  "envId": "cloudbase-3g4w6lls8a5ce59b",
  "version": "2.0",
  "runtime": "Nodejs16.13"
}
```

## 项目详细说明

### 1. 完成版小程序后台8.7 (内部管理系统)

#### 功能模块

- **库存管理**: 产品入库、出库、库存查询、低库存预警
- **商城下单**: 内部员工代客户下单
- **订单管理**: 订单查看、状态更新、订单详情
- **预存记录**: 客户预存金额管理、消费记录
- **客户管理**: 客户信息维护、客户合并、客户订单历史

#### 核心页面结构

```
pages/
├── login/                 # 登录页面
├── index/                 # 首页(库存管理)
├── admin/                 # 管理员功能
│   ├── products/          # 产品管理
│   ├── addProduct/        # 添加产品
│   └── homepageSettings/  # 首页设置
├── records/               # 使用记录
├── totalStock/            # 总库存
├── lowStock/              # 低库存预警
├── productIn/             # 产品入库
├── productRecords/        # 产品记录
├── productCalendar/       # 产品日历
├── shop/                  # 商城下单
├── cart/                  # 购物车
├── customers/             # 客户管理
├── orders/                # 订单管理
├── members/               # 预存记录
└── calendar/              # 日历功能
```

#### 主要云函数

- `addPrestore`: 添加预存记录
- `createCollection`: 创建数据库集合
- `submitOrder`: 提交订单
- `deleteProduct`: 删除产品
- `homepageManagement`: 首页管理
- `initShopProducts`: 初始化商城产品

### 2. 商城小程序 (用户端)

#### 功能模块

- **首页**: 轮播图、推广活动、用户信息展示
- **商城**: 产品浏览、分类筛选、购物车
- **订单**: 订单查看、订单状态跟踪
- **个人中心**: 用户信息、积分、优惠券

#### 核心页面结构

```
pages/
├── index/           # 首页
├── cart/            # 购物车/商城
├── orders/          # 订单列表
├── profile/         # 个人中心
├── product-detail/  # 产品详情
├── order-detail/    # 订单详情
├── address/         # 地址管理
└── login/           # 登录页面
```

#### 主要云函数

- `login`: 用户登录
- `getShopProducts`: 获取商城产品
- `getBanners`: 获取轮播图
- `getCategories`: 获取分类
- `getProductDetail`: 获取产品详情
- `manageBanners`: 管理轮播图
- `manageHomepageConfig`: 管理首页配置

#### 用户隔离设计

商城小程序需要实现用户隔离，确保每个用户只能看到自己的数据：

```javascript
// 示例：用户数据查询
const { OPENID } = cloud.getWXContext()
const userOrders = await db.collection('orders')
  .where({ userId: OPENID })
  .get()
```

### 3. Web7.27 (Web端后台管理)

#### 功能模块

- **基础管理**: 与小程序后台功能一致
  - 用户管理
  - 订单管理
  - 预存记录管理
  - 商城下单
- **商城管理**: 专门管理商城小程序
  - 首页布局装修
  - 轮播图管理
  - 优惠券发放
  - 商城订单管理
  - 产品上架下架

#### 技术栈详情

```json
{
  "dependencies": {
    "@cloudbase/js-sdk": "^2.19.2",
    "react": "^18.2.0",
    "react-router-dom": "^6.22.3",
    "tailwindcss": "^3.4.17",
    "daisyui": "^4.7.2",
    "lucide-react": "^0.536.0",
    "cos-js-sdk-v5": "^1.10.1"
  }
}
```

#### 页面结构

```
src/
├── components/
│   └── Layout.jsx         # 布局组件
├── pages/
│   ├── DashboardPage.jsx  # 仪表板
│   ├── UsersPage.jsx      # 用户管理
│   ├── OrdersPage.jsx     # 订单管理
│   ├── DepositsPage.jsx   # 预存管理
│   ├── ShopPage.jsx       # 商城下单
│   ├── MallManagePage.jsx # 商城管理
│   ├── HomepageSettingsPage.jsx # 首页设置
│   └── LoginPage.jsx      # 登录页面
└── utils/
    └── cloudbase.js       # 云开发配置
```

## 数据库设计

### 核心数据集合

#### 1. 用户相关

```javascript
// users - 用户信息
{
  _id: "用户ID",
  openid: "微信OpenID",
  nickName: "用户昵称",
  avatarUrl: "头像URL",
  phone: "手机号",
  points: 0,           // 积分
  balance: 0,          // 余额
  vipLevel: 1,         // VIP等级
  createTime: Date,
  updateTime: Date
}

// customers - 客户信息(后台管理)
{
  _id: "客户ID",
  name: "客户姓名",
  phone: "手机号",
  address: "地址",
  prepaidBalance: 0,   // 预存余额
  totalSpent: 0,       // 总消费
  createTime: Date,
  updateTime: Date
}
```

#### 2. 产品相关

```javascript
// products - 产品信息
{
  _id: "产品ID",
  name: "产品名称",
  description: "产品描述",
  price: 0,            // 价格
  originalPrice: 0,    // 原价
  category: "分类",
  type: "类型",
  stock: 0,            // 库存
  minStock: 10,        // 最低库存预警
  images: [],          // 产品图片
  onSale: true,        // 是否上架
  createTime: Date,
  updateTime: Date
}

// shopProducts - 商城产品(继承products结构)
{
  // 继承products所有字段
  isRecommended: false, // 是否推荐
  sortOrder: 0,        // 排序
  tags: []             // 标签
}
```

#### 3. 订单相关

```javascript
// orders - 订单信息
{
  _id: "订单ID",
  orderNo: "订单号",
  userId: "用户ID",     // 商城订单
  customerId: "客户ID", // 后台订单
  items: [             // 订单商品
    {
      productId: "产品ID",
      name: "产品名称",
      price: 0,
      quantity: 1,
      subtotal: 0
    }
  ],
  totalAmount: 0,      // 总金额
  status: "pending",   // 订单状态
  paymentMethod: "预存", // 支付方式
  address: {},         // 收货地址
  createTime: Date,
  updateTime: Date
}
```

#### 4. 预存记录

```javascript
// prepaidRecords - 预存记录
{
  _id: "记录ID",
  customerId: "客户ID",
  customerName: "客户姓名",
  amount: 0,           // 金额(正数充值，负数消费)
  type: "recharge",    // 类型: recharge/consume
  orderId: "订单ID",   // 关联订单(消费时)
  balance: 0,          // 操作后余额
  operatorId: "操作员ID",
  remark: "备注",
  createTime: Date
}
```

#### 5. 商城管理

```javascript
// banners - 轮播图
{
  _id: "轮播图ID",
  title: "标题",
  subtitle: "副标题",
  imageUrl: "图片URL",
  linkUrl: "跳转链接",
  gradient: "渐变色",
  isActive: true,      // 是否启用
  sortOrder: 0,        // 排序
  createTime: Date
}

// coupons - 优惠券
{
  _id: "优惠券ID",
  name: "优惠券名称",
  type: "discount",    // 类型: discount/amount
  value: 0,            // 优惠值
  minAmount: 0,        // 最低消费
  validFrom: Date,     // 有效期开始
  validTo: Date,       // 有效期结束
  totalCount: 100,     // 总数量
  usedCount: 0,        // 已使用数量
  isActive: true,      // 是否启用
  createTime: Date
}

// homepageConfig - 首页配置
{
  _id: "配置ID",
  title: "主标题",
  subtitle: "副标题",
  giftNote: "赠品说明",
  validityNote: "有效期说明",
  prices: [            // 价格配置
    {
      price: 30,
      originalPrice: 30
    }
  ],
  updateTime: Date
}
```

## 开发环境配置

### 1. 微信开发者工具配置

```json
// project.config.json
{
  "miniprogramRoot": "miniprogram/",
  "cloudfunctionRoot": "cloudfunctions/",
  "setting": {
    "urlCheck": true,
    "es6": true,
    "enhance": true,
    "postcss": true,
    "minified": true
  },
  "appid": "your-appid",
  "libVersion": "latest",
  "cloud": true
}
```

### 2. Web端开发环境

```bash
# 安装依赖
npm install

# 开发模式
npm run dev

# 构建生产版本
npm run build
```

### 3. 云函数部署

```bash
# 在微信开发者工具中
# 1. 右键云函数文件夹
# 2. 选择"上传并部署"
# 3. 选择"云端安装依赖"
```

## 部署指南

### 1. 云开发环境准备

1. 在微信公众平台创建小程序
2. 开通云开发服务
3. 获取环境ID并配置到项目中

### 2. 数据库初始化

```javascript
// 使用createCollection云函数创建必要的集合
const collections = [
  'users',
  'customers', 
  'products',
  'shopProducts',
  'orders',
  'prepaidRecords',
  'banners',
  'coupons',
  'homepageConfig'
]
```

### 3. 权限配置

```json
// 数据库权限配置
{
  "read": "auth",
  "write": "auth"
}
```

## 安全考虑

### 1. 用户隔离

- 所有用户数据查询必须包含用户标识
- 使用云函数的`cloud.getWXContext()`获取用户OpenID
- 敏感操作需要管理员权限验证

### 2. 数据验证

- 云函数中进行参数验证
- 金额计算使用服务端验证
- 库存操作使用事务确保一致性

### 3. 权限控制

```javascript
// 管理员权限验证示例
const checkAdminPermission = async (openid) => {
  const admin = await db.collection('admins')
    .where({ openid })
    .get()
  return admin.data.length > 0
}
```

## 开发规范

### 1. 代码规范

- 使用ES6+语法
- 统一的错误处理机制
- 详细的日志记录
- 组件化开发

### 2. 命名规范

- 文件名使用小驼峰命名
- 组件名使用大驼峰命名
- 常量使用大写下划线
- 数据库字段使用小驼峰

### 3. 注释规范

```javascript
/**
 * 添加预存记录
 * @param {string} customerId - 客户ID
 * @param {number} amount - 金额
 * @param {string} type - 类型
 * @returns {Object} 操作结果
 */
```

## 测试策略

### 1. 单元测试

- 云函数逻辑测试
- 数据验证测试
- 权限控制测试

### 2. 集成测试

- 完整业务流程测试
- 跨模块数据一致性测试
- 用户体验测试

### 3. 性能测试

- 数据库查询优化
- 图片加载优化
- 网络请求优化

## 维护指南

### 1. 日常维护

- 定期备份数据库
- 监控云函数执行情况
- 检查错误日志
- 更新依赖包

### 2. 版本管理

- 使用Git进行版本控制
- 重要功能发布前进行测试
- 保持开发、测试、生产环境一致

### 3. 监控告警

- 设置云函数执行异常告警
- 监控数据库性能
- 关注用户反馈

## 扩展计划

### 1. 功能扩展

- 会员等级系统
- 积分商城
- 营销活动管理
- 数据分析报表
- 消息推送系统

### 2. 技术优化

- 引入TypeScript
- 实现自动化测试
- 优化数据库查询
- 实现缓存机制

### 3. 平台扩展

- 支付宝小程序适配
- H5版本开发
- APP版本开发
- 管理后台独立部署

## 联系方式

如有问题或建议，请联系开发团队。

---

*文档版本: v1.0*  
*最后更新: 2024年*